<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —Ç–∞–π–º–µ—Ä–æ–≤: Smart Clean Log</title>
    <style>
        /* --- UTILITY CLASSES --- */
        body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .p-4 { padding: 1rem; }
        .w-full { width: 100%; }
        .max-w-6xl { max-width: 72rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .bg-white { background-color: #ffffff; }
        .p-6 { padding: 1.5rem; }
        .sm\:p-10 { padding: 2.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .font-extrabold { font-weight: 800; }
        .mb-2 { margin-bottom: 0.5rem; }
        .font-bold { font-weight: 700; }
        .mt-3 { margin-top: 0.75rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .text-center { text-align: center; }
        
        /* Grid Layout */
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .gap-4 { gap: 1rem; }
        @media (min-width: 640px) { .sm\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (min-width: 1024px) { .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); } }

        /* Flexbox */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .flex-1 { flex: 1 1 0%; }
        
        .space-x-1 > * { margin-left: 0.25rem; }
        .space-x-1 > *:first-child { margin-left: 0; }
        @media (min-width: 640px) {
            .sm\:space-x-2 > * { margin-left: 0.5rem; }
            .sm\:space-x-2 > *:first-child { margin-left: 0; }
        }
        
        /* --- CLOCK STYLES (MODIFIED FOR CENTER) --- */
        .header-container { display: flex; justify-content: center; align-items: center; width: 100%; position: relative; }
        .real-time-clock { font-variant-numeric: tabular-nums; color: #374151; line-height: 1; text-align: center; }
        .clock-time { font-size: 2.5rem; font-weight: 800; letter-spacing: 0.05em; }
        .clock-date { font-size: 1rem; color: #6b7280; font-weight: 500; margin-top: 0.5rem; text-transform: capitalize; }
        .settings-button-wrapper { position: absolute; right: 0; top: 0; }
        /* --- TOTAL COUNTER STYLES (MOTOHOURS) --- */
        .total-counter-block {
            background-color: #e0e7ff; /* Indigo 100 */
            border: 2px solid #6366f1; /* Indigo 500 */
            color: #312e81; /* Indigo 900 */
            padding: 1rem;
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        
        .motohours-header { width: 100%; text-align: center; cursor: pointer; user-select: none; }
        
        .total-time-val {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-size: 2.5rem;
            font-weight: 900;
            font-variant-numeric: tabular-nums;
            margin: 0.5rem 0;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: flex;
            width: 100%;
            max-width: 600px;
            justify-content: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .stat-item {
            background-color: rgba(255,255,255,0.5);
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
        }
        .stat-time {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: #4338ca;
        }

        .total-reset-btn {
            background-color: #4338ca;
            color: white;
            border: none;
            padding: 0.4rem 1rem;
            border-radius: 0.4rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            opacity: 0.9;
            transition: all 0.2s;
        }
        .total-reset-btn:hover { opacity: 1; }
        
        /* --- CLEAR ALL HISTORY BUTTON --- */
        .clear-all-history-btn {
            margin-top: 1rem; 
            padding: 0.7rem; 
            border-radius: 0.5rem;
            width: 100%; 
            font-weight: 700; 
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .clear-all-history-btn.clear {
            background-color: #fee2e2; 
            color: #b91c1c;
            border: 2px solid #fca5a5; 
        }
        .clear-all-history-btn.clear:hover {
            background-color: #fca5a5;
            color: #991b1b;
        }
        
        /* --- TIMER STYLES --- */
        .timer-row {
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #93c5fd;
            background-color: #eff6ff; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: background-color 0.15s;
        }
        .timer-row.flash-reset {
             background-color: #fde047 !important; 
             transition: none;
        }

        .timer-id-display {
            font-family: 'Inter', sans-serif;
            font-size: 3.5rem; 
            font-weight: 900;
            color: #ffffff; 
            background-color: #2563eb; 
            width: 4rem; 
            height: 4rem; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            line-height: 1; 
            user-select: none;
            margin-right: 0.5rem; 
            transition: background-color 0.3s, transform 0.2s;
        }
        .timer-id-display:hover { transform: scale(1.05); } 

        .time-display {
            font-family: 'SF Mono', 'Roboto Mono', monospace; 
            font-variant-numeric: tabular-nums;
            min-width: 160px; 
            font-size: 4.5rem; 
            font-weight: 900; 
            line-height: 0.95; 
            color: #1f2937; 
            background-color: #f0fdf4; 
            padding: 0.2rem 0.75rem;
            border: 3px solid #34d399; 
            border-radius: 0.75rem; 
            box-shadow: 0 0 10px rgba(52, 211, 153, 0.5); 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            justify-content: flex-end; 
            letter-spacing: -0.08em; 
        }
        .time-display:hover { transform: scale(1.02); }
        
        .time-display.state-running { border-color: #059669; box-shadow: 0 0 15px rgba(5, 150, 105, 0.8); }
        .time-display.state-paused { border-color: #34d399; background-color: #f0fdf4; opacity: 0.8; } 
        .time-display.state-alarm { border-color: #f59e0b; background-color: #fffbeb; }
        .time-display.state-overtime-red { color: #dc2626; border-color: #ef4444; background-color: #fef2f2; box-shadow: 0 0 15px rgba(239, 68, 68, 0.8); } 
        /* NEW: Style for 0 time */
        .time-display.state-zero { border-color: #9ca3af; background-color: #f3f4f6; color: #6b7280; }

        @keyframes pulse-yellow { 0%, 100% { background-color: #fffbeb; } 50% { background-color: #fcd34d; } }
        @keyframes pulse-red { 0%, 100% { background-color: #fef2f2; } 50% { background-color: #fca5a5; } }
        /* NEW: Green Blink for Infinity */
        @keyframes blink-green {
            0%, 100% { background-color: #eff6ff; border-color: #93c5fd; }
            50% { background-color: #dcfce7; border-color: #22c55e; box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); }
        }
        
        .alarm-row-pulse { animation: pulse-yellow 1s infinite; border-color: #f59e0b; }
        .alarm-row-pulse-overtime { animation: pulse-red 1s infinite; border-color: #ef4444; }
        .blink-green-active { animation: blink-green 1.5s infinite ease-in-out; border: 2px solid #22c55e !important; }

        .timer-button {
            padding: 0.5rem;
            font-size: 0.9rem; 
            font-weight: 600;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.15s, opacity 0.1s, box-shadow 0.1s; /* Added opacity and box-shadow transitions */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .timer-button:active { transform: translateY(1px); }

        /* Active Service Button (Yellow) */
        .service-active {
            background-color: #facc15 !important; /* Yellow-400 */
            color: #000 !important; /* Black Text */
            border: 1px solid #ca8a04;
        }

        .control-btn { font-size: 1.5rem; padding: 0.6rem 0; }
        .btn-play { background-color: #059669; } .btn-play:hover { background-color: #047857; }
        .btn-pause { background-color: #b91c1c; } .btn-pause:hover { background-color: #991b1b; }
        .btn-reset { background-color: #4b5563; } .btn-reset:hover { background-color: #374151; }
        
        /* Dynamic Button Colors via classes */
        .btn-color-blue { background-color: #2563eb; } .btn-color-blue:hover { background-color: #1d4ed8; }
        .btn-color-indigo { background-color: #4f46e5; } .btn-color-indigo:hover { background-color: #4338ca; }
        .btn-color-purple { background-color: #9333ea; } .btn-color-purple:hover { background-color: #7e22ce; }
        .btn-color-green { background-color: #16a34a; } .btn-color-green:hover { background-color: #15803d; }
        .btn-color-red { background-color: #dc2626; } .btn-color-red:hover { background-color: #b91c1c; }
        .btn-color-gray { background-color: #6b7280; } .btn-color-gray:hover { background-color: #4b5563; }
        .btn-color-teal { background-color: #0d9488; } .btn-color-teal:hover { background-color: #0f766e; }


        .icon-svg { width: 1.4rem; height: 1.4rem; fill: currentColor; }
        .icon-play-svg { transform: translateX(2px); }

        .status-wrapper { width: 100%; overflow: hidden; }
        .status-details { 
            width: 100%; text-align: center; border-radius: 0.75rem; padding: 0.75rem; 
            border-width: 2px; border-style: solid; margin-top: 0.5rem;
        }
        .status-info-orange { background-color: #ffedd5; border-color: #f97316; }
        .status-info-red { background-color: #fee2e2; border-color: #ef4444; }
        
        .text-red-700 { color: #b91c1c; }
        .text-green-700 { color: #15803d; }
        .text-gray-600 { color: #4b5563; }

        /* --- MODAL HISTORY STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(3px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.2s ease;
        }
        .modal-visible { display: flex !important; opacity: 1 !important; }
        .modal-content {
            background: white; width: 95%; max-width: 600px; max-height: 90vh;
            border-radius: 1rem; padding: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column; animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; border-bottom: 2px solid #f3f4f6; padding-bottom: 0.5rem;
        }
        .modal-title { font-size: 1.5rem; font-weight: 800; color: #1f2937; }
        .modal-close { background: none; border: none; font-size: 2rem; line-height: 1; color: #9ca3af; cursor: pointer; }

        .history-list, #summaryReportOutput, #settingsContainer { overflow-y: auto; flex: 1; padding-right: 0.5rem; }
        
        /* --- CARD STYLE MATCHING IMAGE --- */
        .history-card {
            background-color: #f8fafc; 
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1.2rem;
            margin-bottom: 1rem;
            font-size: 0.95rem;
            position: relative;
            color: #334155;
        }
        .history-card.type-summary {
            background-color: #eff6ff; 
            border-left: 6px solid #4338ca; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 800;
            color: #1e1b4b;
            border-bottom: 2px solid #e0e7ff;
            padding-bottom: 0.5rem;
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
            position: relative; 
            padding-right: 30px; 
        }
        
        /* NEW: Check Number Style */
        .check-number {
            font-size: 0.8rem;
            background-color: #c7d2fe;
            color: #312e81;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        .delete-check-btn {
            background: none; border: none; font-size: 1.5rem; line-height: 1; 
            color: #ef4444; cursor: pointer; position: absolute; top: 10px; right: 10px;
            transition: color 0.15s;
            z-index: 1001;
        }
        .delete-check-btn:hover { color: #b91c1c; }

        .summary-row {
            display: flex; justify-content: space-between; padding: 0.2rem 0;
            font-weight: 500; align-items: flex-start;
        }
        .summary-label { color: #475569; font-weight: 600; }
        .summary-val {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-weight: 700; color: #334155; text-align: right;
        }
        .summary-row.red-text .summary-val, .summary-row.red-text .summary-label { color: #dc2626; }
        .summary-row.total-row {
            margin-top: 0.8rem; border-top: 2px dashed #94a3b8; padding-top: 0.5rem;
            font-size: 1.15rem; font-weight: 800; color: #111827;
        }

        .log-item { margin-bottom: 0.5rem; font-weight: 700; font-size: 0.95rem; }
        .log-item.type-start { color: #059669; }
        .log-item.type-pause { color: #b91c1c; }
        .log-item.type-ext { color: #4f46e5; }
        .log-item.type-service { color: #0d9488; } /* Teal for services */
        .log-item.type-reset-nocheck { color: #4b5563; }

        .clear-history-btn {
            margin-top: 1rem; background-color: #fee2e2; color: #ef4444;
            border: 1px solid #fca5a5; padding: 0.8rem; border-radius: 0.8rem;
            width: 100%; font-weight: 700; cursor: pointer;
            text-transform: uppercase; letter-spacing: 0.05em;
        }

        /* --- SETTINGS STYLES --- */
        .settings-group { margin-bottom: 2rem; border: 1px solid #e5e7eb; border-radius: 0.8rem; padding: 1rem; background: #f9fafb; position: relative; }
        .settings-label { display: block; font-size: 0.9rem; font-weight: 600; color: #374151; margin-bottom: 0.3rem; margin-top: 0.8rem; }
        .settings-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.3rem; font-size: 1rem; box-sizing: border-box; }
        /* Adjusted btn-config-row for better layout */
        .btn-config-row { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; background: white; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; }
        .btn-config-input { flex: 1; padding: 0.3rem; border: 1px solid #ccc; border-radius: 0.2rem; min-width: 0; }
        .btn-config-color { width: 80px; padding: 0.3rem; }
        .settings-action-btn { width: 100%; padding: 0.8rem; margin-top: 1rem; border-radius: 0.5rem; font-weight: bold; cursor: pointer; border: none; }
        .save-btn { background-color: #2563eb; color: white; }
        .save-btn:hover { background-color: #1d4ed8; }
        .add-group-btn { background-color: #10b981; color: white; width: 100%; margin-top: 0.5rem; font-size: 1.1rem;}
        .add-group-btn:hover { background-color: #059669; }
        .add-btn-small { background-color: #e5e7eb; color: #374151; margin-top:0.5rem; padding:0.5rem; width: auto; font-size: 0.9rem; }
        .add-btn-small:hover { background-color: #d1d5db; }
        .remove-btn { background-color: #ef4444; color: white; border: none; border-radius: 0.3rem; padding: 0.3rem 0.6rem; cursor: pointer; font-size: 0.8rem; }
        
        .group-header { 
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; 
            padding-bottom: 0.5rem; margin-bottom: 0.5rem; font-size: 1.1rem; font-weight: 700; color: #111827; 
            cursor: pointer;
        }
        .group-header h3 { margin: 0; color: #111827; }
        /* Style for main group content */
        .group-content { overflow: hidden; transition: max-height 0.3s ease-out; }
        .group-content.collapsed { max-height: 0; padding: 0; margin: 0; }


        /* --- NEW TOGGLE SWITCH STYLES --- */
        .switch-row { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb; }
        .switch { position: relative; display: inline-block; width: 45px; height: 25px; margin: 0 0 0 10px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 25px; }
        .slider:before { position: absolute; content: ""; height: 17px; width: 17px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }

        input:checked + .slider { background-color: #10b981; /* Green for standard toggle */ }
        input:focus + .slider { box-shadow: 0 0 1px #10b981; }
        input:checked + .slider:before { transform: translateX(20px); }
        
        /* NEW: Styles for the Double Click switch (Green when checked, Gray when unchecked) */
        .double-click-slider {
            background-color: #9ca3af !important; /* Lighter Gray for unchecked */
        }
        input:checked + .double-click-slider {
            background-color: #10b981 !important; /* Green when checked */
        }

        .toggle-wrapper { display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; width: 100px; }
        .toggle-label { font-size: 0.8rem; font-weight: 600; color: #4b5563; }
        .full-label { font-size: 0.9rem; font-weight: 600; color: #111827; }
        /* -------------------------------- */
        
        /* --- COLLAPSIBLE STYLES --- */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            color: #4b5563;
            padding: 0.5rem 0;
            margin-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .collapsible-header:first-child {
            margin-top: 0;
            border-top: none;
        }
        .collapse-icon {
            font-size: 1.5rem;
            line-height: 1;
            transition: transform 0.2s;
        }
        .collapsed-icon-state {
            transform: rotate(-90deg);
        }
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-in-out; 
            max-height: 2000px; /* Safe initial height for expanded content */
            padding-bottom: 10px;
        }
        .collapsible-content.collapsed {
            max-height: 0;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0;
        }

        /* --- NEW: Group Summary Button Styles --- */
        .group-summary-btn {
            margin-top: 1rem; 
            padding: 0.7rem; 
            border-radius: 0.5rem;
            width: 100%; 
            font-weight: 700; 
            cursor: pointer;
            transition: background-color 0.2s;
            background-color: #dbeafe; 
            color: #1e40af;
            border: 2px solid #93c5fd; 
        }
        .group-summary-btn:hover {
            background-color: #93c5fd;
            color: #1e3a8a;
        }

        /* --- NEW: Report and Restore Styles --- */
        .report-section {
            margin-top: 2rem;
            padding: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }

        .date-range-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .date-range-selector input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
        }

        .restore-check-item {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .restore-check-info {
            flex: 1;
            font-size: 0.9rem;
        }

        .restore-check-actions {
            display: flex;
            gap: 0.5rem;
        }

        .deleted-check {
            opacity: 0.7;
            background-color: #fef2f2;
            border-color: #fca5a5;
        }
        
        /* --- NEW: Timer Icon Styles --- */
        .timer-icon {
            font-size: 2.5rem;
            line-height: 1;
        }
        
        /* --- NEW: Export Button Styles --- */
        .export-btn {
            background-color: #8b5cf6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
        }
        
        .export-btn:hover {
            background-color: #7c3aed;
        }
        
        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–ú–ï–ù–ê–ú–ò --- */
        .shift-controls-container {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #f8fafc;
            border-radius: 0.75rem;
            border: 2px solid #d1d5db;
        }
        
        .shift-manager-btn {
            background-color: #6b7280;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            text-align: center;
            transition: background-color 0.2s;
            font-size: 1.1rem;
        }
        
        .shift-manager-btn:hover {
            background-color: #4b5563;
        }
        
        .shift-btn-active {
            background-color: #10b981 !important;
        }
        
        .shift-btn-inactive {
            background-color: #9ca3af !important;
        }
        
        .shift-worker-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }
        
        .shift-info-display {
            background-color: #dbeafe;
            border: 2px solid #3b82f6;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: #1e40af;
        }
        
        .shift-checks-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: white;
        }
        
        .shift-check-item {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .shift-check-item:last-child {
            border-bottom: none;
        }
        
        .shift-timer-filter {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .shift-timer-btn {
            padding: 0.5rem 1rem;
            background-color: #e5e7eb;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .shift-timer-btn:hover {
            background-color: #d1d5db;
        }
        
        .shift-timer-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #2563eb;
        }
        
        .shift-report-card {
            background-color: #f0f9ff;
            border: 1px solid #7dd3fc;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .shift-report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .shift-warning {
            background-color: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        /* --- Password Modal on top --- */
        #passwordModal {
            z-index: 2000;
        }
        
        /* --- Check Creation Date --- */
        .check-creation-date {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        /* --- Shift Actions Double Click --- */
        .shift-action-dblclick {
            position: relative;
        }
        
        .shift-action-dblclick::after {
            content: " (–î–≤–∞–∂–¥—ã)";
            font-size: 0.8rem;
            color: #ef4444;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="w-full max-w-6xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        
        <div class="flex justify-between items-start mb-6 header-container">
            <div class="real-time-clock" style="flex-grow: 1;">
                <div id="clock-time" class="clock-time">00:00:00</div>
                <div id="clock-date" class="clock-date">...</div>
            </div>
            <div class="settings-button-wrapper">
                <button onclick="requestPassword(openSettings)" style="background:none; border:none; font-size:1.5rem; cursor:pointer;" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
            </div>
        </div>

        <div id="timersContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Timers will be generated here -->
        </div>

        <div id="motohoursBlock" class="total-counter-block mt-6" style="display: none;">
            <div class="font-bold text-lg uppercase tracking-wider mb-1 motohours-header" onclick="toggleMotohoursVisibility()">
                <span id="motohoursNameDisplay">–ú–û–¢–û–ß–ê–°–´</span> <span id="motohoursToggleIcon">‚ñº</span>
            </div>
            <div id="motohoursDetails">
                <div id="total-counter-display" class="total-time-val">00:00:00</div>
                <div id="statsGrid" class="stats-grid">
                    <!-- Stats will be generated here -->
                </div>
                <button id="resetMotohoursBtn" class="total-reset-btn"
                    onmousedown="startHold(event)" onmouseup="cancelHold(event)" onmouseleave="cancelHold(event)"
                    ontouchstart="startHold(event)" ontouchend="cancelHold(event)" ontouchcancel="cancelHold(event)">
                    –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë
                </button>
            </div>
        </div>
        
        <button class="clear-all-history-btn clear" onclick="requestPassword(clearAllHistoryWithPassword)">
            –û—á–∏—Å—Ç–∏—Ç—å –í–°–Æ –∏—Å—Ç–æ—Ä–∏—é (–≤—Å–µ —Ç–∞–π–º–µ—Ä—ã)
        </button>

        <div id="summaryControls" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4" style="display: none;">
             <button id="fullSummaryBtn" class="clear-all-history-btn" style="background-color: #d1fae5; color: #059669; border: 2px solid #34d399; margin-top:0;" 
                onclick="promptAndShowSummaryReport(1, 100, '–ü–æ–ª–Ω–∞—è —Å–≤–æ–¥–∫–∞')">
                üìä –ü–æ–ª–Ω–∞—è –°–≤–æ–¥–∫–∞ (–í—Å–µ)
            </button>
        </div>

        <!-- NEW: Group Summary Buttons Container -->
        <div id="groupSummaryControls" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4" style="display: none;">
            <!-- Group summary buttons will be generated here -->
        </div>
        
        <!-- –ù–û–í–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–ú–ï–ù–ê–ú–ò -->
        <div class="shift-controls-container">
            <button id="shiftManagerBtn" class="shift-manager-btn" 
                onclick="handleShiftManagerClick()">
                üïê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–º–µ–Ω–æ–π
            </button>
            <div id="shiftInfo" class="shift-info-display" style="display: none;">
                <div id="currentShiftStatus"></div>
                <div id="currentWorkerName"></div>
                <div id="shiftCheckCounter"></div>
            </div>
        </div>
    </div> 

    <div id="passwordModal" class="modal-overlay" onclick="if(event.target === this) closePasswordModal()">
        <div class="modal-content" style="max-width: 400px; z-index: 2001;">
            <div class="modal-header">
                <div class="modal-title">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</div>
                <button class="modal-close" onclick="closePasswordModal()">&times;</button>
            </div>
            <div style="margin-bottom: 1rem;">
                <input type="password" id="modal-password-input" class="settings-input" placeholder="–ü–∞—Ä–æ–ª—å..." style="font-size: 1.5rem; text-align: center;">
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button id="modal-password-submit" class="settings-action-btn save-btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button class="settings-action-btn" style="background-color: #6b7280; color: white; font-size: 0.9rem;" onclick="resetMasterPasswordFromModal()">–ù–µ –ø–æ–º–Ω—é –ø–∞—Ä–æ–ª—å</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay" onclick="if(event.target === this) closeSettingsModal()">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
                <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div id="settingsContainer">
                <!-- Settings will be generated here -->
            </div>
            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button class="settings-action-btn" style="background-color:#9ca3af; color:white;" onclick="closeSettingsModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="settings-action-btn save-btn" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal-overlay" onclick="if(event.target === this) closeHistoryModal()">
        <div class="modal-content">
            <div class="modal-header">
                <div id="modalTitle" class="modal-title">–ò—Å—Ç–æ—Ä–∏—è</div>
                <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
            </div>

            <div id="filterControls" style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #f3f4f6;">
                <div style="font-size: 0.85rem; font-weight: 600; color: #4b5563; margin-bottom: 0.5rem;">
                    –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ:
                </div>
                <div class="flex space-x-2">
                    <input type="date" id="filterStartDate" style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 0.5rem; flex: 1;">
                    <input type="date" id="filterEndDate" style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 0.5rem; flex: 1;">
                </div>
                <button onclick="applyFilter()" style="margin-top: 0.5rem; padding: 0.5rem; width: 100%; background-color: #3b82f6; color: white; border-radius: 0.5rem; font-weight: 600;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
            </div>
            <div id="summaryReportOutput" style="display:none; overflow-y: auto; flex: 1; padding-right: 0.5rem;"></div>
            <div id="modalList" class="history-list"></div>
            <button class="clear-history-btn" onclick="requestPassword(clearCurrentHistory)">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        </div>
    </div>

    <!-- NEW: Report Generation Modal -->
    <div id="reportModal" class="modal-overlay" onclick="if(event.target === this) closeReportModal()">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞</div>
                <button class="modal-close" onclick="closeReportModal()">&times;</button>
            </div>
            <div style="margin-bottom: 1rem;">
                <div class="settings-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:</div>
                <div class="date-range-selector">
                    <input type="date" id="reportStartDate">
                    <span>–ø–æ</span>
                    <input type="date" id="reportEndDate">
                </div>
                <div class="settings-label">–§–∏–ª—å—Ç—Ä –ø–æ –Ω–æ–º–µ—Ä—É —Å–º–µ–Ω—ã:</div>
                <input type="number" id="reportShiftNumber" class="settings-input" placeholder="–ù–æ–º–µ—Ä —Å–º–µ–Ω—ã –∏–ª–∏ –ø—É—Å—Ç–æ">
                <div class="settings-label">–§–∏–ª—å—Ç—Ä –ø–æ –∏–º–µ–Ω–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞:</div>
                <input type="text" id="reportWorkerName" class="settings-input" placeholder="–ò–º—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ –∏–ª–∏ –ø—É—Å—Ç–æ">
                <div class="settings-label">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É:</div>
                <select id="reportGroupSelect" class="settings-input">
                    <option value="all">–í—Å–µ –≥—Ä—É–ø–ø—ã</option>
                </select>
            </div>
            <div id="reportContent" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                <div style="text-align: center; color: #6b7280;">–û—Ç—á–µ—Ç –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–¥–µ—Å—å</div>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="settings-action-btn" onclick="generateReport()" style="background-color: #10b981; color: white;">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç</button>
                <button class="settings-action-btn" onclick="exportReportToText()" style="background-color: #3b82f6; color: white;">–≠–∫—Å–ø–æ—Ä—Ç –≤ —Ç–µ–∫—Å—Ç</button>
                <button class="settings-action-btn" style="background-color:#9ca3af; color:white;" onclick="closeReportModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- NEW: Restore Checks Modal -->
    <div id="restoreModal" class="modal-overlay" onclick="if(event.target === this) closeRestoreModal()">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —á–µ–∫–æ–≤</div>
                <button class="modal-close" onclick="closeRestoreModal()">&times;</button>
            </div>
            <div style="margin-bottom: 1rem;">
                <div class="settings-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ —É–¥–∞–ª–µ–Ω–∏—è:</div>
                <div class="date-range-selector">
                    <input type="date" id="restoreStartDate">
                    <span>–ø–æ</span>
                    <input type="date" id="restoreEndDate">
                </div>
                <button onclick="loadDeletedChecks()" style="margin-top: 0.5rem; padding: 0.5rem; width: 100%; background-color: #3b82f6; color: white; border-radius: 0.5rem; font-weight: 600;">–ó–∞–≥—Ä—É–∑–∏—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–µ —á–µ–∫–∏</button>
            </div>
            <div id="restoreContent" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                <div style="text-align: center; color: #6b7280;">–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã —É–¥–∞–ª–µ–Ω–Ω—ã–µ —á–µ–∫–∏</div>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="settings-action-btn" onclick="restoreSelectedChecks()" style="background-color: #10b981; color: white;">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                <button class="settings-action-btn" onclick="restoreAllChecks()" style="background-color: #3b82f6; color: white;">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ</button>
                <button class="settings-action-btn" style="background-color:#9ca3af; color:white;" onclick="closeRestoreModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- NEW: Shift Management Modal -->
    <div id="shiftModal" class="modal-overlay" onclick="if(event.target === this) closeShiftModal()">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–º–µ–Ω–∞–º–∏</div>
                <button class="modal-close" onclick="closeShiftModal()">&times;</button>
            </div>
            <div style="margin-bottom: 1rem;">
                <div class="settings-label">–ò–º—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞:</div>
                <input type="text" id="shiftWorkerName" class="shift-worker-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞">
                
                <div id="currentShiftInfo" style="margin-bottom: 1rem;"></div>
                
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <button id="openShiftBtn" class="settings-action-btn shift-btn-inactive shift-action-dblclick" onclick="handleDoubleClick('openShift', openShift)">
                        –û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É
                    </button>
                    <button id="closeShiftBtn" class="settings-action-btn shift-btn-inactive shift-action-dblclick" onclick="handleDoubleClick('closeShift', closeShift)">
                        –ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É
                    </button>
                </div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #e5e7eb;">
                    <div class="settings-label">–ë—ã—Å—Ç—Ä–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <button class="settings-action-btn shift-action-dblclick" style="background-color: #10b981; color: white;" onclick="handleDoubleClick('openShiftWithCurrentWorker', openShiftWithCurrentWorker)">
                            –û—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—É—é —Å–º–µ–Ω—É
                        </button>
                        <button class="settings-action-btn shift-action-dblclick" style="background-color: #ef4444; color: white;" onclick="handleDoubleClick('forceCloseShift', forceCloseShift)">
                            –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
                        </button>
                    </div>
                </div>
            </div>
            <div style="margin-top: 1rem;">
                <button class="settings-action-btn" style="background-color:#9ca3af; color:white;" onclick="closeShiftModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- NEW: Shift Reports Modal -->
    <div id="shiftReportsModal" class="modal-overlay" onclick="if(event.target === this) closeShiftReportsModal()">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">–û—Ç—á–µ—Ç—ã –ø–æ —Å–º–µ–Ω–∞–º</div>
                <button class="modal-close" onclick="closeShiftReportsModal()">&times;</button>
            </div>
            <div style="margin-bottom: 1rem;">
                <div class="date-range-selector">
                    <input type="date" id="shiftReportStartDate">
                    <span>–ø–æ</span>
                    <input type="date" id="shiftReportEndDate">
                </div>
                <div class="settings-label">–§–∏–ª—å—Ç—Ä –ø–æ –Ω–æ–º–µ—Ä—É —Å–º–µ–Ω—ã:</div>
                <input type="number" id="shiftReportNumberFilter" class="settings-input" placeholder="–ù–æ–º–µ—Ä —Å–º–µ–Ω—ã –∏–ª–∏ –ø—É—Å—Ç–æ">
                <div class="settings-label">–§–∏–ª—å—Ç—Ä –ø–æ —Ä–∞–±–æ—Ç–Ω–∏–∫—É:</div>
                <input type="text" id="shiftReportWorkerFilter" class="settings-input" placeholder="–ò–º—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ –∏–ª–∏ '–≤—Å–µ'">
                
                <button onclick="loadShiftReports()" style="margin-top: 0.5rem; padding: 0.5rem; width: 100%; background-color: #3b82f6; color: white; border-radius: 0.5rem; font-weight: 600;">
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç—ã
                </button>
            </div>
            <div id="shiftReportsContent" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                <div style="text-align: center; color: #6b7280;">–û—Ç—á–µ—Ç—ã –ø–æ —Å–º–µ–Ω–∞–º –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å</div>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="settings-action-btn" onclick="exportShiftReportsToText()" style="background-color: #3b82f6; color: white;">
                    –≠–∫—Å–ø–æ—Ä—Ç –≤ —Ç–µ–∫—Å—Ç
                </button>
                <button class="settings-action-btn" style="background-color:#9ca3af; color:white;" onclick="closeShiftReportsModal()">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- NEW: Shift Details Modal -->
    <div id="shiftDetailsModal" class="modal-overlay" onclick="if(event.target === this) closeShiftDetailsModal()">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">–î–µ—Ç–∞–ª–∏ —Å–º–µ–Ω—ã</div>
                <button class="modal-close" onclick="closeShiftDetailsModal()">&times;</button>
            </div>
            <div id="shiftDetailsContent" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                <div style="text-align: center; color: #6b7280;">–î–µ—Ç–∞–ª–∏ —Å–º–µ–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å</div>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="settings-action-btn" onclick="exportShiftDetailsToText()" style="background-color: #3b82f6; color: white;">
                    –≠–∫—Å–ø–æ—Ä—Ç –≤ —Ç–µ–∫—Å—Ç
                </button>
                <button class="settings-action-btn shift-action-dblclick" onclick="handleDoubleClick('deleteCurrentShiftFromDetails', deleteCurrentShiftFromDetails)" style="background-color: #ef4444; color: white;">
                    –£–¥–∞–ª–∏—Ç—å —Å–º–µ–Ω—É
                </button>
                <button class="settings-action-btn" style="background-color:#9ca3af; color:white;" onclick="closeShiftDetailsModal()">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- NEW: Restore Shifts Modal -->
    <div id="restoreShiftsModal" class="modal-overlay" onclick="if(event.target === this) closeRestoreShiftsModal()">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å–º–µ–Ω</div>
                <button class="modal-close" onclick="closeRestoreShiftsModal()">&times;</button>
            </div>
            <div style="margin-bottom: 1rem;">
                <div class="settings-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ —É–¥–∞–ª–µ–Ω–∏—è:</div>
                <div class="date-range-selector">
                    <input type="date" id="restoreShiftsStartDate">
                    <span>–ø–æ</span>
                    <input type="date" id="restoreShiftsEndDate">
                </div>
                <button onclick="loadDeletedShifts()" style="margin-top: 0.5rem; padding: 0.5rem; width: 100%; background-color: #3b82f6; color: white; border-radius: 0.5rem; font-weight: 600;">–ó–∞–≥—Ä—É–∑–∏—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–µ —Å–º–µ–Ω—ã</button>
            </div>
            <div id="restoreShiftsContent" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                <div style="text-align: center; color: #6b7280;">–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã —É–¥–∞–ª–µ–Ω–Ω—ã–µ —Å–º–µ–Ω—ã</div>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="settings-action-btn" onclick="restoreSelectedShifts()" style="background-color: #10b981; color: white;">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                <button class="settings-action-btn" onclick="restoreAllShifts()" style="background-color: #3b82f6; color: white;">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ</button>
                <button class="settings-action-btn" style="background-color:#9ca3af; color:white;" onclick="closeRestoreShiftsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
        <script>
        // --- CONSTANTS & DEFAULT CONFIG ---
        const MASTER_RESET_KEY = '89144892253'; // –ú–∞—Å—Ç–µ—Ä-–∫–æ–¥ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
        const STORAGE_KEY_PASSWORD = 'app_admin_password_v1';
        const STORAGE_KEY_DELETED_CHECKS = 'deleted_checks_v1';
        // --- –ù–ê–ß–ê–õ–û FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyDgM_G6FN6QYZYX7ZH_1ZdmuyBNtYC-bPQ",
          authDomain: "timer75rus.firebaseapp.com",
          projectId: "timer75rus",
          storageBucket: "timer75rus.firebasestorage.app",
          messagingSenderId: "478310152450",
          appId: "1:478310152450:web:6b865a530ed919df3a2a1b",
          measurementId: "G-KYBBCEGEZB"
        };

        // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã –∏—Ö –≤–∏–¥–µ–ª–∏ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
        let db = null;
        let analytics = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            analytics = firebase.analytics();
            console.log("‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ");
        } catch (e) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Firebase:", e);
            alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –æ–±–ª–∞–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
        }

        // –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –í –û–ë–õ–ê–ö–û
        function uploadToCloud(collectionName, docId, data) {
            if (!db) {
                console.warn("‚ö†Ô∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞, –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã:", collectionName);
                return;
            }
            
            // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –º—É—Å–æ—Ä–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            try {
                const cleanData = JSON.parse(JSON.stringify(data));
                cleanData.lastUpdateCloud = new Date().toISOString(); 
                
                db.collection(collectionName).doc(docId).set(cleanData, { merge: true })
                    .then(() => console.log(`‚òÅÔ∏è –£—Å–ø–µ—à–Ω–æ: ${collectionName}/${docId}`))
                    .catch(err => console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ ${collectionName}:`, err));
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–ª–∞–∫–∞:", err);
            }
        }
        // --- –ö–û–ù–ï–¶ FIREBASE CONFIG ---

        
        // –ù–û–í–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–ú–ï–ù–ê–ú–ò
        const STORAGE_KEY_SHIFT = 'app_shift_v1';
        const STORAGE_KEY_SHIFT_HISTORY = 'app_shift_history_v1';
        const STORAGE_KEY_SHIFT_CHECK_ID = 'shift_check_id_v1';
        const STORAGE_KEY_DELETED_SHIFTS = 'deleted_shifts_v1'; // –ù–û–í–û–ï: –î–ª—è –∫–æ—Ä–∑–∏–Ω—ã —Å–º–µ–Ω
        
        // Dynamic Password Logic
        function getAdminPassword() {
            return localStorage.getItem(STORAGE_KEY_PASSWORD) || '4892'; // Default '4892'
        }
        function setAdminPassword(newPwd) {
            localStorage.setItem(STORAGE_KEY_PASSWORD, newPwd);
        }

        const GRACE_PERIOD_MINUTES = 0; 
        const GRACE_PERIOD_MS = GRACE_PERIOD_MINUTES * 60 * 1000;
        const DOUBLE_CLICK_DELAY = 400; // milliseconds
        const STORAGE_KEY_CHECK_ID = 'global_check_id_v1';

        // NEW: Global object to track last click for double tap logic
        let lastClick = {};
        let shiftActionLastClick = {}; // –î–ª—è –¥–≤–æ–π–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π –¥–µ–π—Å—Ç–≤–∏–π —Å–º–µ–Ω
        
        // Global for password callback
        let onPasswordSuccess = null;

        // NEW: Comprehensive list of all report keys
        const ALL_REPORT_KEYS = [
            'showPaymentTime', 'showLabel', 'showAmount', // Fixed payment specific
            'showStartTime', 'showResetTime', 'showTotalPause', 'showPauseDetails', 
            'showInitialMinutes', 'showExtensionMinutes', 'showBaseCost', 
            'showExtensionCost', 'showOvertimeDuration', 'showOvertimeCost', 
            'showRate', 'showTotalCost' // Timer specific
        ];

        // NEW: Defaults for Fixed Payment Report (Only relevant fields are true)
        const FIXED_REPORT_DEFAULTS = {
            showPaymentTime: true, showLabel: true, showAmount: true, // Relevant
            showStartTime: false, showResetTime: false, showTotalPause: false, 
            showPauseDetails: false, showInitialMinutes: false, showExtensionMinutes: false, 
            showBaseCost: false, showExtensionCost: false, showOvertimeDuration: false, 
            showOvertimeCost: false, showRate: false, showTotalCost: false // Timer-related
        };

        const DEFAULT_SETTINGS = {
            activeTimers: "1,2,3,4,5,6,7,8,9,11,12,13", // String CSV
            minReportMinutes: 1, // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —á–µ–∫–∞
            
            generalControls: { // –ù–û–í–´–ï –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –í–ò–î–ò–ú–û–°–¢–ò –ò –ú–û–¢–û–ß–ê–°–û–í
                pauseButtonVisible: true,
                motohoursBlockVisible: true,
                motohoursName: "–ú–û–¢–û–ß–ê–°–´", 
                motohoursIds: "11,12,13", // ID —Ç–∞–π–º–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—Ö–æ–¥—è—Ç –≤ —Å—É–º–º—É –º–æ—Ç–æ—á–∞—Å–æ–≤
                fullSummaryVisible: true
            },

            groups: [
                {
                    id: "standard",
                    name: "–°–Ω–µ–≥–æ–∫–∞—Ç—ã (1-9)",
                    ids: [1,2,3,4,5,6,7,8,9],
                    defaultMinutes: 20,
                    rate: 30, // RUB/min
                    warnYellow: 5, 
                    warnRed: 2, 
                    resetDoubleClickRequired: false, // Double click for Reset
                    isActive: true, // NEW: Group active state
                    showSummaryButton: true, // NEW: Show group summary button
                    timerColor: "#2563eb", // NEW: Timer ID color
                    timerIcon: "", // NEW: Timer icon (empty for number)
                    // Reset Report Config
                    resetReportConfig: {
                        showStartTime: true, showResetTime: true, showTotalPause: true, showPauseDetails: false, 
                        showInitialMinutes: true, showExtensionMinutes: true, showBaseCost: true, 
                        showExtensionCost: true, showOvertimeDuration: true, showOvertimeCost: true, 
                        showRate: true, showTotalCost: true
                    },
                    buttons: [
                        { label: "+10", minutes: 10, color: "blue", isVisible: true, doubleClickRequired: false, enableOvertime: true, reportConfig: JSON.parse(JSON.stringify(FIXED_REPORT_DEFAULTS)) }, 
                        { label: "+20", minutes: 20, color: "indigo", isVisible: true, doubleClickRequired: false, enableOvertime: true, reportConfig: JSON.parse(JSON.stringify(FIXED_REPORT_DEFAULTS)) } 
                    ],
                    fixedButtons: [], // CLEARED (Classic fixed buttons removed)
                    // NEW: Fixed Rate Extension Buttons
                    fixedExtensionButtons: [
                        { 
                            label: "+1 —á–∞—Å (600—Ä)", 
                            amount: 600, 
                            durationValue: 1, 
                            durationUnit: "hour", 
                            color: "purple", 
                            isVisible: true, 
                            doubleClickRequired: false, 
                            enableOvertime: true, // Default to true
                            fixedReportConfig: JSON.parse(JSON.stringify(FIXED_REPORT_DEFAULTS)) 
                        }
                    ],
                    // NEW: Additional Services Buttons
                    additionalServiceButtons: [
                        { label: "–®–ª–µ–º", amount: 200, isVisible: true },
                        { label: "–≠–∫–∏–ø", amount: 500, isVisible: true }
                    ]
                },
                {
                    id: "moto",
                    name: "–ú–æ—Ç–æ—Å–Ω–æ—É–±–æ—Ä–¥—ã (11-13)",
                    ids: [11,12,13,14],
                    defaultMinutes: 30,
                    rate: 33.33,
                    warnYellow: 5,
                    warnRed: 2,
                    resetDoubleClickRequired: false, // Double click for Reset
                    isActive: true, // NEW: Group active state
                    showSummaryButton: true, // NEW: Show group summary button
                    timerColor: "#2563eb", // NEW: Timer ID color
                    timerIcon: "", // NEW: Timer icon (empty for number)
                    resetReportConfig: {
                        showStartTime: true, showResetTime: true, showTotalPause: true, showPauseDetails: false, 
                        showInitialMinutes: true, showExtensionMinutes: true, showBaseCost: true, 
                        showExtensionCost: true, showOvertimeDuration: true, showOvertimeCost: true, 
                        showRate: true, showTotalCost: true
                    },
                    buttons: [
                        { label: "+15", minutes: 15, color: "purple", isVisible: true, doubleClickRequired: false, enableOvertime: true, reportConfig: JSON.parse(JSON.stringify(FIXED_REPORT_DEFAULTS)) } 
                    ],
                    fixedButtons: [], // CLEARED
                    // NEW: Fixed Rate Extension Buttons
                    fixedExtensionButtons: [],
                    additionalServiceButtons: []
                }
            ]
        };

        const STORAGE_KEY_SETTINGS = 'app_settings_v4_groups'; // Updated version
        const TIMER_STATE_STORAGE_KEY = 'timer_state_v15_clean_log'; 
        const STORAGE_KEY_STATS = 'timer_stats_v12_default_time_fix'; 

        // Globals
        let appSettings = null;
        let timers = [];
        let container = null; 
        let lastUpdateTime = Date.now();
        let audioContext = null;
        let lastSaveTime = 0;
        let timerStats = {}; 
        let motohoursDetails, isMotohoursVisible = true, toggleIcon, resetButton, pressTimer, motohoursNameDisplay;
        let currentModalTimerId = null;
        let currentModalType = 'history';
        
        // NEW: Variables for double-click group removal
        let doubleClickGroupRemove = {};
        
        // –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–ú–ï–ù–ê–ú–ò
        let currentShift = null;
        let shiftHistory = [];
        let deletedShifts = []; // –ù–û–í–û–ï: –ö–æ—Ä–∑–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å–º–µ–Ω
        let lastShiftClick = 0;
        let shiftCheckCounter = 1;

        // --- ICONS ---
        const ICON_PLAY = `<svg class="icon-svg icon-play-svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
        const ICON_PAUSE = `<svg class="icon-svg" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
        const ICON_RESET = `<span style="font-size: 1.4rem; line-height:1;">‚úï</span>`;
        
        // --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–ú–ï–ù–ê–ú–ò ---
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Å–º–µ–Ω–∞—Ö
        function loadShiftData() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–º–µ–Ω—É
            const savedShift = localStorage.getItem(STORAGE_KEY_SHIFT);
            if (savedShift) {
                currentShift = JSON.parse(savedShift);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞—Ä–µ–ª–∞ –ª–∏ —Å–º–µ–Ω–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–∞—Ç—ã)
                const today = new Date().toISOString().split('T')[0];
                const shiftDate = new Date(currentShift.openedAt).toISOString().split('T')[0];
                
                if (today !== shiftDate && currentShift.isOpen) {
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–º–µ–Ω—É
                    forceCloseShift();
                    console.log(`–°–º–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç–∞, —Ç–∞–∫ –∫–∞–∫ –Ω–∞—á–∞–ª—Å—è –Ω–æ–≤—ã–π –¥–µ–Ω—å (${today}).`);
                }
            } else {
                currentShift = {
                    isOpen: false,
                    openedAt: null,
                    closedAt: null,
                    workerName: '',
                    shiftNumber: 1,
                    checkCounter: 1,
                    checks: []
                };
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–º–µ–Ω
            const savedHistory = localStorage.getItem(STORAGE_KEY_SHIFT_HISTORY);
            if (savedHistory) {
                shiftHistory = JSON.parse(savedHistory);
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä–∞ —Å–º–µ–Ω –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                renumberShifts();
            } else {
                shiftHistory = [];
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ —Å–º–µ–Ω—ã
            const savedDeletedShifts = localStorage.getItem(STORAGE_KEY_DELETED_SHIFTS);
            if (savedDeletedShifts) {
                deletedShifts = JSON.parse(savedDeletedShifts);
            } else {
                deletedShifts = [];
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —á–µ–∫–æ–≤ —Å–º–µ–Ω—ã
            const savedCheckCounter = localStorage.getItem(STORAGE_KEY_SHIFT_CHECK_ID);
            if (savedCheckCounter) {
                shiftCheckCounter = parseInt(savedCheckCounter);
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ —Å–º–µ–Ω–∞—Ö
        function saveShiftData() {
            localStorage.setItem(STORAGE_KEY_SHIFT, JSON.stringify(currentShift));
            localStorage.setItem(STORAGE_KEY_SHIFT_HISTORY, JSON.stringify(shiftHistory));
            localStorage.setItem(STORAGE_KEY_SHIFT_CHECK_ID, shiftCheckCounter.toString());
            localStorage.setItem(STORAGE_KEY_DELETED_SHIFTS, JSON.stringify(deletedShifts));
            
            // >>> –î–û–ë–ê–í–õ–ï–ù–û: –û–¢–ü–†–ê–í–ö–ê –í –û–ë–õ–ê–ö–û <<<
            // –ê–∫—Ç–∏–≤–Ω–∞—è —Å–º–µ–Ω–∞ (–∫—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ —Å–µ–π—á–∞—Å)
            uploadToCloud('shifts', 'active', currentShift); 
            // –ò—Å—Ç–æ—Ä–∏—è —Å–º–µ–Ω (–∞—Ä—Ö–∏–≤)
            uploadToCloud('shifts', 'history', { list: shiftHistory });
            // –ö–æ—Ä–∑–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å–º–µ–Ω
            uploadToCloud('shifts', 'trash', { list: deletedShifts });
        }

        
        // –ü–µ—Ä–µ—Å—á–µ—Ç –Ω–æ–º–µ—Ä–æ–≤ —Å–º–µ–Ω –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
        function renumberShifts() {
            shiftHistory.forEach((shift, index) => {
                shift.shiftNumber = index + 1;
            });
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä —Å–º–µ–Ω—ã
            if (currentShift && !currentShift.isOpen) {
                currentShift.shiftNumber = shiftHistory.length + 1;
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ ID –¥–ª—è —á–µ–∫–∞ –≤ —Å–º–µ–Ω–µ
        function getNextShiftCheckId() {
            if (!currentShift.isOpen) return 0;
            
            const id = currentShift.checkCounter;
            currentShift.checkCounter++;
            shiftCheckCounter++;
            localStorage.setItem(STORAGE_KEY_SHIFT_CHECK_ID, shiftCheckCounter.toString());
            saveShiftData();
            return id;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–º–µ–Ω–µ –≤ UI
        function updateShiftUI() {
            const shiftInfo = document.getElementById('shiftInfo');
            const currentShiftStatus = document.getElementById('currentShiftStatus');
            const currentWorkerName = document.getElementById('currentWorkerName');
            const shiftCheckCounter = document.getElementById('shiftCheckCounter');
            
            if (currentShift.isOpen) {
                shiftInfo.style.display = 'block';
                currentShiftStatus.innerHTML = `‚úÖ –°–º–µ–Ω–∞ #${currentShift.shiftNumber} –æ—Ç–∫—Ä—ã—Ç–∞`;
                currentShiftStatus.style.color = '#059669';
                
                if (currentShift.workerName) {
                    currentWorkerName.innerHTML = `üë§ –†–∞–±–æ—Ç–Ω–∏–∫: ${currentShift.workerName}`;
                } else {
                    currentWorkerName.innerHTML = `üë§ –†–∞–±–æ—Ç–Ω–∏–∫: –Ω–µ —É–∫–∞–∑–∞–Ω`;
                }
                
                // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ—É–¥–∞–ª–µ–Ω–Ω—ã–µ —á–µ–∫–∏
                const activeChecks = currentShift.checks.filter(check => !check.isDeleted);
                shiftCheckCounter.innerHTML = `üìã –ß–µ–∫–æ–≤ –≤ —Å–º–µ–Ω–µ: ${activeChecks.length}`;
            } else {
                shiftInfo.style.display = 'none';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            const openShiftBtn = document.getElementById('openShiftBtn');
            const closeShiftBtn = document.getElementById('closeShiftBtn');
            
            if (currentShift.isOpen) {
                openShiftBtn.classList.remove('shift-btn-active');
                openShiftBtn.classList.add('shift-btn-inactive');
                openShiftBtn.disabled = true;
                
                closeShiftBtn.classList.remove('shift-btn-inactive');
                closeShiftBtn.classList.add('shift-btn-active');
                closeShiftBtn.disabled = false;
            } else {
                openShiftBtn.classList.remove('shift-btn-inactive');
                openShiftBtn.classList.add('shift-btn-active');
                openShiftBtn.disabled = false;
                
                closeShiftBtn.classList.remove('shift-btn-active');
                closeShiftBtn.classList.add('shift-btn-inactive');
                closeShiftBtn.disabled = true;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            const currentShiftInfo = document.getElementById('currentShiftInfo');
            if (currentShift.isOpen) {
                const openedTime = new Date(currentShift.openedAt).toLocaleString('ru-RU');
                const activeChecks = currentShift.checks.filter(check => !check.isDeleted);
                currentShiftInfo.innerHTML = `
                    <div style="background-color: #d1fae5; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                        <strong>–¢–µ–∫—É—â–∞—è —Å–º–µ–Ω–∞ #${currentShift.shiftNumber}</strong><br>
                        –û—Ç–∫—Ä—ã—Ç–∞: ${openedTime}<br>
                        –†–∞–±–æ—Ç–Ω–∏–∫: ${currentShift.workerName || '–Ω–µ —É–∫–∞–∑–∞–Ω'}<br>
                        –ß–µ–∫–æ–≤: ${activeChecks.length}
                    </div>
                `;
            } else {
                currentShiftInfo.innerHTML = `
                    <div style="background-color: #fee2e2; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                        <strong>–°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞</strong><br>
                        –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—É—é —Å–º–µ–Ω—É
                    </div>
                `;
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π —Å–º–µ–Ω
        function handleDoubleClick(actionId, callback) {
            const now = Date.now();
            const lastClickTime = shiftActionLastClick[actionId] || 0;
            
            if (now - lastClickTime < DOUBLE_CLICK_DELAY) {
                // –í—Ç–æ—Ä–æ–π –∫–ª–∏–∫ - –≤—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
                callback();
                shiftActionLastClick[actionId] = 0;
            } else {
                // –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫
                shiftActionLastClick[actionId] = now;
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å —á–µ—Ä–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏
                const event = window.event;
                if (event && event.target) {
                    const originalText = event.target.textContent;
                    event.target.textContent = '–ù–∞–∂–º–∏—Ç–µ –µ—â–µ —Ä–∞–∑';
                    
                    // –°–±—Ä–æ—Å —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É
                    setTimeout(() => {
                        if (shiftActionLastClick[actionId] === now) {
                            event.target.textContent = originalText;
                            shiftActionLastClick[actionId] = 0;
                        }
                    }, DOUBLE_CLICK_DELAY);
                }
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–º–µ–Ω–æ–π (–¥–≤–æ–π–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ)
        function handleShiftManagerClick() {
            const now = Date.now();
            
            if (now - lastShiftClick < DOUBLE_CLICK_DELAY) {
                // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–º–µ–Ω–æ–π
                openShiftModal();
                lastShiftClick = 0;
            } else {
                // –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫
                lastShiftClick = now;
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                const btn = document.getElementById('shiftManagerBtn');
                const originalText = btn.textContent;
                btn.textContent = '–ù–∞–∂–º–∏—Ç–µ –µ—â–µ —Ä–∞–∑';
                btn.style.backgroundColor = '#f59e0b';
                
                // –°–±—Ä–æ—Å —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É
                setTimeout(() => {
                    if (lastShiftClick === now) {
                        btn.textContent = originalText;
                        btn.style.backgroundColor = '';
                        lastShiftClick = 0;
                    }
                }, DOUBLE_CLICK_DELAY);
            }
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–º–µ–Ω–æ–π
        function openShiftModal() {
            loadShiftData();
            updateShiftUI();
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –∏–º–µ–Ω–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
            if (currentShift.workerName) {
                document.getElementById('shiftWorkerName').value = currentShift.workerName;
            }
            
            document.getElementById('shiftModal').classList.add('modal-visible');
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–º–µ–Ω–æ–π
        function closeShiftModal() {
            document.getElementById('shiftModal').classList.remove('modal-visible');
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã
        function openShift() {
            const workerName = document.getElementById('shiftWorkerName').value.trim();
            
            if (!workerName) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞');
                return;
            }
            
            if (currentShift.isOpen) {
                alert('–°–º–µ–Ω–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞!');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–º–µ–Ω—É
            currentShift = {
                isOpen: true,
                openedAt: Date.now(),
                closedAt: null,
                workerName: workerName,
                shiftNumber: shiftHistory.length + 1,
                checkCounter: 1, // –ù–∞—á–∏–Ω–∞–µ–º —Å 1
                checks: []
            };
            
            saveShiftData();
            updateShiftUI();
            alert(`–°–º–µ–Ω–∞ #${currentShift.shiftNumber} –æ—Ç–∫—Ä—ã—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ ${workerName}`);
            closeShiftModal();
        }
        
        // –ë—ã—Å—Ç—Ä–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã —Å —Ç–µ–∫—É—â–∏–º —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–º
        function openShiftWithCurrentWorker() {
            const workerName = document.getElementById('shiftWorkerName').value.trim();
            
            if (!workerName) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞');
                return;
            }
            
            openShift();
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã
        function closeShift() {
            if (!currentShift.isOpen) {
                alert('–°–º–µ–Ω–∞ —É–∂–µ –∑–∞–∫—Ä—ã—Ç–∞!');
                return;
            }
            
            const activeChecks = currentShift.checks.filter(check => !check.isDeleted);
            if (activeChecks.length === 0) {
                if (!confirm('–í —Å–º–µ–Ω–µ –Ω–µ—Ç —á–µ–∫–æ–≤. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É?')) {
                    return;
                }
            }
            
            currentShift.closedAt = Date.now();
            currentShift.isOpen = false;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–º–µ–Ω—É –≤ –∏—Å—Ç–æ—Ä–∏—é
            shiftHistory.push({...currentShift});
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–º–µ–Ω—É
            currentShift = {
                isOpen: false,
                openedAt: null,
                closedAt: null,
                workerName: '',
                shiftNumber: shiftHistory.length + 1,
                checkCounter: 1,
                checks: []
            };
            
            saveShiftData();
            updateShiftUI();
            alert('–°–º–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏');
            closeShiftModal();
        }
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã
        function forceCloseShift() {
            if (!currentShift.isOpen) return;
            
            currentShift.closedAt = Date.now();
            currentShift.isOpen = false;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–º–µ–Ω—É –≤ –∏—Å—Ç–æ—Ä–∏—é
            shiftHistory.push({...currentShift});
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–º–µ–Ω—É
            currentShift = {
                isOpen: false,
                openedAt: null,
                closedAt: null,
                workerName: '',
                shiftNumber: shiftHistory.length + 1,
                checkCounter: 1,
                checks: []
            };
            
            saveShiftData();
            updateShiftUI();
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–º–µ–Ω—ã (–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É)
        function deleteShift(shiftIndex) {
            if (shiftIndex >= 0 && shiftIndex < shiftHistory.length) {
                const shiftToDelete = shiftHistory[shiftIndex];
                
                // –ü–æ–º–µ—á–∞–µ–º —á–µ–∫–∏ –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã–µ
                shiftToDelete.checks.forEach(check => {
                    check.isDeleted = true;
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ—Ä–∑–∏–Ω—É
                deletedShifts.push({
                    ...shiftToDelete,
                    deletedAt: Date.now(),
                    originalIndex: shiftIndex
                });
                
                // –£–¥–∞–ª—è–µ–º –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
                shiftHistory.splice(shiftIndex, 1);
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä–∞
                renumberShifts();
                
                saveShiftData();
                alert(`–°–º–µ–Ω–∞ #${shiftToDelete.shiftNumber} –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É`);
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å–º–µ–Ω—ã –∏–∑ –¥–µ—Ç–∞–ª–µ–π
        function deleteCurrentShiftFromDetails() {
            if (window.currentViewingShift && confirm('–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —ç—Ç—É —Å–º–µ–Ω—É –≤ –∫–æ—Ä–∑–∏–Ω—É?')) {
                const shiftToDelete = window.currentViewingShift;
                const index = shiftHistory.findIndex(s => s.shiftNumber === shiftToDelete.shiftNumber);
                
                if (index !== -1) {
                    deleteShift(index);
                    closeShiftDetailsModal();
                    loadShiftReports(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ç—á–µ—Ç–æ–≤
                }
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–º–µ–Ω
        function deleteAllShifts() {
            if (shiftHistory.length === 0) {
                alert('–ù–µ—Ç —Å–º–µ–Ω –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }
            
            if (confirm(`–í–ù–ò–ú–ê–ù–ò–ï! –í—ã –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –í–°–ï ${shiftHistory.length} —Å–º–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) {
                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤—Å–µ —Å–º–µ–Ω—ã –≤ –∫–æ—Ä–∑–∏–Ω—É
                shiftHistory.forEach((shift, index) => {
                    // –ü–æ–º–µ—á–∞–µ–º —á–µ–∫–∏ –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã–µ
                    shift.checks.forEach(check => {
                        check.isDeleted = true;
                    });
                    
                    deletedShifts.push({
                        ...shift,
                        deletedAt: Date.now(),
                        originalIndex: index
                    });
                });
                
                // –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
                shiftHistory = [];
                
                // –û–±–Ω—É–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ —Å–º–µ–Ω
                if (currentShift && !currentShift.isOpen) {
                    currentShift.shiftNumber = 1;
                }
                
                saveShiftData();
                alert(`–í—Å–µ —Å–º–µ–Ω—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –∫–æ—Ä–∑–∏–Ω—É`);
            }
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–º–µ–Ω—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
        function restoreShift(deletedIndex) {
            if (deletedIndex >= 0 && deletedIndex < deletedShifts.length) {
                const shiftToRestore = deletedShifts[deletedIndex];
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ–∫–∏
                shiftToRestore.checks.forEach(check => {
                    check.isDeleted = false;
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                shiftHistory.push(shiftToRestore);
                
                // –£–¥–∞–ª—è–µ–º –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
                deletedShifts.splice(deletedIndex, 1);
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä–∞
                renumberShifts();
                
                saveShiftData();
                alert(`–°–º–µ–Ω–∞ #${shiftToRestore.shiftNumber} –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`);
            }
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–º–µ–Ω
        function restoreAllShifts() {
            if (deletedShifts.length === 0) {
                alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
                return;
            }
            
            deletedShifts.forEach(shift => {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ–∫–∏
                shift.checks.forEach(check => {
                    check.isDeleted = false;
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                shiftHistory.push(shift);
            });
            
            // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
            deletedShifts = [];
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä–∞
            renumberShifts();
            
            saveShiftData();
            alert(`–í—Å–µ —Å–º–µ–Ω—ã (${shiftHistory.length}) –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã`);
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å–º–µ–Ω –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
        function loadDeletedShifts() {
            const startDate = document.getElementById('restoreShiftsStartDate').value;
            const endDate = document.getElementById('restoreShiftsEndDate').value;
            
            if (!startDate || !endDate) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥");
                return;
            }
            
            const startTimestamp = new Date(startDate).getTime();
            const endTimestamp = new Date(endDate).getTime() + (24 * 60 * 60 * 1000);
            
            const filteredShifts = deletedShifts.filter(shift => 
                shift.deletedAt >= startTimestamp && shift.deletedAt < endTimestamp
            );
            
            let html = '';
            
            if (filteredShifts.length === 0) {
                html = '<div style="text-align: center; color: #6b7280; padding: 2rem;">–ù–µ—Ç —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å–º–µ–Ω –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
            } else {
                html += '<div id="allDeletedShifts">';
                filteredShifts.forEach((shift, index) => {
                    const deletedDate = new Date(shift.deletedAt).toLocaleString('ru-RU');
                    const openedDate = new Date(shift.openedAt).toLocaleString('ru-RU');
                    const activeChecks = shift.checks.filter(check => !check.isDeleted);
                    
                    html += `
                        <div class="restore-check-item deleted-check" id="deleted-shift-${index}">
                            <div class="restore-check-info">
                                <div><strong>–°–º–µ–Ω–∞ #${shift.shiftNumber}</strong></div>
                                <div style="font-size: 0.8rem; color: #6b7280;">–†–∞–±–æ—Ç–Ω–∏–∫: ${shift.workerName || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">–û—Ç–∫—Ä—ã—Ç–∞: ${openedDate}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">–£–¥–∞–ª–µ–Ω–∞: ${deletedDate}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">–ß–µ–∫–æ–≤: ${activeChecks.length}</div>
                            </div>
                            <div class="restore-check-actions">
                                <button onclick="restoreSingleShift(${index})" style="background-color: #10b981; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 0.25rem; cursor: pointer;">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" class="restore-shift-checkbox" data-index="${index}" style="margin-right: 0.5rem;">
                                </label>
                            </div>
                        </div>`;
                });
                html += '</div>';
            }
            
            document.getElementById('restoreShiftsContent').innerHTML = html;
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–π —Å–º–µ–Ω—ã
        function restoreSingleShift(index) {
            restoreShift(index);
            loadDeletedShifts(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–º–µ–Ω
        function restoreSelectedShifts() {
            const checkboxes = document.querySelectorAll('.restore-shift-checkbox:checked');
            const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
            
            if (indices.length === 0) {
                alert("–í—ã–±–µ—Ä–∏—Ç–µ —Å–º–µ–Ω—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è");
                return;
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ, —á—Ç–æ–±—ã –∏–Ω–¥–µ–∫—Å—ã –Ω–µ —Å–¥–≤–∏–≥–∞–ª–∏—Å—å
            indices.sort((a, b) => b - a).forEach(index => {
                restoreShift(index);
            });
            
            loadDeletedShifts();
            alert(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ${indices.length} —Å–º–µ–Ω`);
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–º–µ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
        function restoreAllShiftsFromModal() {
            restoreAllShifts();
            closeRestoreShiftsModal();
            alert('–í—Å–µ —Å–º–µ–Ω—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–æ—Ä–∑–∏–Ω—ã —Å–º–µ–Ω
        function openRestoreShiftsModal() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('restoreShiftsStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('restoreShiftsEndDate').value = endDate.toISOString().split('T')[0];
            
            document.getElementById('restoreShiftsModal').classList.add('modal-visible');
            loadDeletedShifts();
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–æ—Ä–∑–∏–Ω—ã —Å–º–µ–Ω
        function closeRestoreShiftsModal() {
            document.getElementById('restoreShiftsModal').classList.remove('modal-visible');
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ —Å–º–µ–Ω–∞ (–¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π)
        function checkShiftOpen() {
            if (!currentShift.isOpen) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–º–µ–Ω—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–π–º–µ—Ä–∞–º–∏');
                openShiftModal();
                return false;
            }
            return true;
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–µ–∫–∞ –≤ —Ç–µ–∫—É—â—É—é —Å–º–µ–Ω—É (–ò–°–ü–†–ê–í–õ–ï–ù–û: —Ç–æ–ª—å–∫–æ —Å—É–º–º–∞, –±–µ–∑ –±–∞–∑–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏)
        function addCheckToShift(timerId, checkHtml, checkData) {
            if (!currentShift.isOpen) return null;
            
            const shiftCheckId = getNextShiftCheckId();
            const checkWithShiftInfo = {
                shiftCheckId: shiftCheckId,
                timerId: timerId,
                timestamp: Date.now(),
                html: checkHtml,
                data: checkData,
                shiftNumber: currentShift.shiftNumber,
                workerName: currentShift.workerName,
                isDeleted: false, // –ù–û–í–û–ï: –§–ª–∞–≥ —É–¥–∞–ª–µ–Ω–∏—è
                creationDate: new Date().toLocaleDateString('ru-RU') // –ù–û–í–û–ï: –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
            };
            
            currentShift.checks.push(checkWithShiftInfo);
            saveShiftData();
            updateShiftUI();
            
            return shiftCheckId;
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ —Å–º–µ–Ω–∞–º
        function openShiftReportsModal() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('shiftReportStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('shiftReportEndDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('shiftReportNumberFilter').value = '';
            document.getElementById('shiftReportWorkerFilter').value = '';
            
            document.getElementById('shiftReportsModal').classList.add('modal-visible');
            loadShiftReports();
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ —Å–º–µ–Ω–∞–º
        function closeShiftReportsModal() {
            document.getElementById('shiftReportsModal').classList.remove('modal-visible');
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π —Å–º–µ–Ω—ã
        function openShiftDetails(shift) {
            window.currentViewingShift = shift;
            
            const openedDate = new Date(shift.openedAt).toLocaleString('ru-RU');
            const closedDate = shift.closedAt ? new Date(shift.closedAt).toLocaleString('ru-RU') : '–ù–µ –∑–∞–∫—Ä—ã—Ç–∞';
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ—É–¥–∞–ª–µ–Ω–Ω—ã–µ —á–µ–∫–∏ –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å—É–º–º—ã
            const activeChecks = shift.checks.filter(check => !check.isDeleted);
            let shiftTotal = 0;
            activeChecks.forEach(check => {
                if (check.data && check.data.amount) {
                    shiftTotal += check.data.amount;
                }
            });
            
            let html = `
                <div class="history-card type-summary">
                    <div class="summary-header">
                        <span>–°–º–µ–Ω–∞ #${shift.shiftNumber}</span>
                        <span>${openedDate.split(',')[0]}</span>
                    </div>
                    <div class="summary-body">
                        <div class="summary-row">
                            <span class="summary-label">–†–∞–±–æ—Ç–Ω–∏–∫:</span>
                            <span class="summary-val">${shift.workerName || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">–û—Ç–∫—Ä—ã—Ç–∞:</span>
                            <span class="summary-val">${openedDate}</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">–ó–∞–∫—Ä—ã—Ç–∞:</span>
                            <span class="summary-val">${closedDate}</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">–í—Å–µ–≥–æ —á–µ–∫–æ–≤:</span>
                            <span class="summary-val">${shift.checks.length}</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —á–µ–∫–æ–≤:</span>
                            <span class="summary-val">${activeChecks.length}</span>
                        </div>
                        <div class="summary-row total-row">
                            <span class="summary-label">–ò—Ç–æ–≥–æ (—Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —á–µ–∫–∏):</span>
                            <span class="summary-val" style="font-size: 1.2rem; color: #059669;">${shiftTotal} —Ä—É–±.</span>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 1rem; font-weight: 700; color: #4b5563;">–ß–µ–∫–∏ —Å–º–µ–Ω—ã:</div>`;
            
            if (activeChecks.length === 0) {
                html += `<div style="text-align: center; color: #6b7280; padding: 1rem;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–µ–∫–æ–≤</div>`;
            } else {
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —á–µ–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
                activeChecks.sort((a, b) => b.timestamp - a.timestamp).forEach(check => {
                    const checkDate = new Date(check.timestamp).toLocaleString('ru-RU');
                    html += `
                        <div class="history-card" style="margin-top: 0.5rem;">
                            <div style="font-size: 0.8rem; color: #6b7280;">
                                –¢–∞–π–º–µ—Ä ${check.timerId} ‚Ä¢ ${checkDate}
                                ${check.creationDate ? `<br>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${check.creationDate}` : ''}
                            </div>
                            ${check.html}
                        </div>`;
                });
            }
            
            document.getElementById('shiftDetailsContent').innerHTML = html;
            document.getElementById('shiftDetailsModal').classList.add('modal-visible');
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π —Å–º–µ–Ω—ã
        function closeShiftDetailsModal() {
            document.getElementById('shiftDetailsModal').classList.remove('modal-visible');
            window.currentViewingShift = null;
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç –¥–µ—Ç–∞–ª–µ–π —Å–º–µ–Ω—ã –≤ —Ç–µ–∫—Å—Ç
        function exportShiftDetailsToText() {
            if (!window.currentViewingShift) return;
            
            const shift = window.currentViewingShift;
            const openedDate = new Date(shift.openedAt).toLocaleString('ru-RU');
            const closedDate = shift.closedAt ? new Date(shift.closedAt).toLocaleString('ru-RU') : '–ù–µ –∑–∞–∫—Ä—ã—Ç–∞';
            
            let text = `–î–µ—Ç–∞–ª–∏ —Å–º–µ–Ω—ã #${shift.shiftNumber}\n`;
            text += `==============================\n`;
            text += `–†–∞–±–æ—Ç–Ω–∏–∫: ${shift.workerName || '–ù–µ —É–∫–∞–∑–∞–Ω'}\n`;
            text += `–û—Ç–∫—Ä—ã—Ç–∞: ${openedDate}\n`;
            text += `–ó–∞–∫—Ä—ã—Ç–∞: ${closedDate}\n`;
            text += `–í—Å–µ–≥–æ —á–µ–∫–æ–≤: ${shift.checks.length}\n`;
            
            const activeChecks = shift.checks.filter(check => !check.isDeleted);
            text += `–ê–∫—Ç–∏–≤–Ω—ã—Ö —á–µ–∫–æ–≤: ${activeChecks.length}\n\n`;
            
            let total = 0;
            activeChecks.forEach((check, index) => {
                const checkDate = new Date(check.timestamp).toLocaleString('ru-RU');
                text += `–ß–µ–∫ ${index + 1}:\n`;
                text += `–¢–∞–π–º–µ—Ä: ${check.timerId}\n`;
                text += `–í—Ä–µ–º—è: ${checkDate}\n`;
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—É–º–º—É –∏–∑ HTML —á–µ–∫–∞
                const amountMatch = check.html.match(/total-final-cost[^>]*>([\d\s]+) —Ä—É–±/);
                const amount = amountMatch ? amountMatch[1].replace(/\s/g, '') : '0';
                text += `–°—É–º–º–∞: ${amount} —Ä—É–±\n`;
                text += `---\n`;
                
                total += parseInt(amount);
            });
            
            text += `\n–ò–¢–û–ì–û: ${total} —Ä—É–±\n`;
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `—Å–º–µ–Ω–∞_${shift.shiftNumber}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ —Å–º–µ–Ω–∞–º (–ò–°–ü–†–ê–í–õ–ï–ù–û: —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ—É–¥–∞–ª–µ–Ω–Ω—ã–µ —á–µ–∫–∏)
        function loadShiftReports() {
            const startDate = document.getElementById('shiftReportStartDate').value;
            const endDate = document.getElementById('shiftReportEndDate').value;
            const shiftNumber = document.getElementById('shiftReportNumberFilter').value.trim();
            const workerFilter = document.getElementById('shiftReportWorkerFilter').value.trim().toLowerCase();
            
            if (!startDate || !endDate) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥");
                return;
            }
            
            const startTimestamp = new Date(startDate).getTime();
            const endTimestamp = new Date(endDate).getTime() + (24 * 60 * 60 * 1000);
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–º–µ–Ω—ã –ø–æ –¥–∞—Ç–µ, –Ω–æ–º–µ—Ä—É –∏ —Ä–∞–±–æ—Ç–Ω–∏–∫—É
            const filteredShifts = shiftHistory.filter(shift => {
                const shiftDate = shift.openedAt;
                const matchesDate = shiftDate >= startTimestamp && shiftDate < endTimestamp;
                const matchesNumber = !shiftNumber || shift.shiftNumber.toString() === shiftNumber;
                const matchesWorker = !workerFilter || 
                    workerFilter === '–≤—Å–µ' ||
                    (shift.workerName && shift.workerName.toLowerCase().includes(workerFilter));
                
                return matchesDate && matchesNumber && matchesWorker;
            });
            
            if (filteredShifts.length === 0) {
                document.getElementById('shiftReportsContent').innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 2rem;">
                        –ù–µ—Ç —Å–º–µ–Ω –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
                    </div>`;
                return;
            }
            
            let html = '';
            let grandTotal = 0;
            let totalChecks = 0;
            
            filteredShifts.forEach(shift => {
                const openedDate = new Date(shift.openedAt).toLocaleString('ru-RU');
                const closedDate = shift.closedAt ? new Date(shift.closedAt).toLocaleString('ru-RU') : '–ù–µ –∑–∞–∫—Ä—ã—Ç–∞';
                
                // –°—á–∏—Ç–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É –ø–æ –ù–ï–£–î–ê–õ–ï–ù–ù–´–ú —á–µ–∫–∞–º —Å–º–µ–Ω—ã (–ò–°–ü–†–ê–í–õ–ï–ù–û)
                let shiftTotal = 0;
                const activeChecks = shift.checks.filter(check => !check.isDeleted);
                activeChecks.forEach(check => {
                    if (check.data && check.data.amount) {
                        shiftTotal += check.data.amount;
                    }
                });
                
                grandTotal += shiftTotal;
                totalChecks += activeChecks.length;
                
                html += `
                    <div class="shift-report-card" onclick="openShiftDetails(${JSON.stringify(shift).replace(/"/g, '&quot;')})">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="font-weight: 800; color: #1e40af;">–°–º–µ–Ω–∞ #${shift.shiftNumber}</div>
                            <div style="font-size: 0.9rem; color: #6b7280;">${openedDate.split(',')[0]}</div>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <div><strong>–†–∞–±–æ—Ç–Ω–∏–∫:</strong> ${shift.workerName || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                            <div><strong>–û—Ç–∫—Ä—ã—Ç–∞:</strong> ${openedDate}</div>
                            <div><strong>–ó–∞–∫—Ä—ã—Ç–∞:</strong> ${closedDate}</div>
                            <div><strong>–ê–∫—Ç–∏–≤–Ω—ã—Ö —á–µ–∫–æ–≤:</strong> ${activeChecks.length}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-weight: 800; font-size: 1.2rem; color: #8b5cf6; border-top: 2px solid #a78bfa; padding-top: 0.5rem;">
                            <span>–ò—Ç–æ–≥–æ –∑–∞ —Å–º–µ–Ω—É:</span>
                            <span>${shiftTotal} —Ä—É–±.</span>
                        </div>
                    </div>`;
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–π –∏—Ç–æ–≥
            html += `
                <div class="history-card type-summary" style="border-left: 6px solid #10b981; background-color: #ecfdf5; margin-top: 1rem;">
                    <div class="summary-header" style="color: #065f46;">
                        <span>üìä –û–ë–©–ò–ô –û–¢–ß–ï–¢ –ó–ê –ü–ï–†–ò–û–î</span>
                    </div>
                    <div class="summary-body">
                        <div class="summary-row">
                            <span class="summary-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–º–µ–Ω:</span>
                            <span class="summary-val">${filteredShifts.length}</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–µ–∫–æ–≤:</span>
                            <span class="summary-val">${totalChecks}</span>
                        </div>
                        <div class="summary-row total-row">
                            <span class="summary-label">–û–ë–©–ê–Ø –°–£–ú–ú–ê:</span>
                            <span class="summary-val" style="font-size: 1.5rem; color: #059669;">${grandTotal} —Ä—É–±.</span>
                        </div>
                    </div>
                </div>`;
            
            document.getElementById('shiftReportsContent').innerHTML = html;
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–æ–≤ –ø–æ —Å–º–µ–Ω–∞–º –≤ —Ç–µ–∫—Å—Ç
        function exportShiftReportsToText() {
            const reportContent = document.getElementById('shiftReportsContent').innerText;
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `–æ—Ç—á–µ—Ç_–ø–æ_—Å–º–µ–Ω–∞–º_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Å–º–µ–Ω
        function exportAllShiftsData() {
            const allData = {
                currentShift: currentShift,
                shiftHistory: shiftHistory,
                deletedShifts: deletedShifts,
                exportedAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `—Å–º–µ–Ω—ã_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏ —Å–º–µ–Ω
        function clearAllShiftsHistory() {
            if (confirm('–í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–Æ –∏—Å—Ç–æ—Ä–∏—é —Å–º–µ–Ω. –í—ã —É–≤–µ—Ä–µ–Ω—ã?')) {
                requestPassword(() => {
                    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤—Å–µ —Å–º–µ–Ω—ã –≤ –∫–æ—Ä–∑–∏–Ω—É
                    shiftHistory.forEach((shift, index) => {
                        shift.checks.forEach(check => {
                            check.isDeleted = true;
                        });
                        
                        deletedShifts.push({
                            ...shift,
                            deletedAt: Date.now(),
                            originalIndex: index
                        });
                    });
                    
                    shiftHistory = [];
                    renumberShifts();
                    saveShiftData();
                    alert('–í—Å–µ —Å–º–µ–Ω—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –∫–æ—Ä–∑–∏–Ω—É');
                    renderSettingsForm();
                });
            }
        }
        
        // --- –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–ú–ï–ù–ê–ú–ò ---

        // --- HELPER: GET NEXT CHECK ID ---
        function getNextCheckId() {
            let current = parseInt(localStorage.getItem(STORAGE_KEY_CHECK_ID) || '0');
            current++;
            localStorage.setItem(STORAGE_KEY_CHECK_ID, current);
            return current;
        }

        // --- DOUBLE CLICK LOGIC ---
        function handleDoubleTap(id, type, callback, isDoubleRequired, buttonElement) {
            const key = `${id}-${type}`;
            
            if (!isDoubleRequired) {
                callback();
                return;
            }

            const now = Date.now();
            const last = lastClick[key] || 0;
            
            // Check for double click
            if (now - last < DOUBLE_CLICK_DELAY) {
                callback();
                lastClick[key] = 0; // Reset after successful double click
                // Revert visual changes
                if (buttonElement && buttonElement.hasAttribute('data-original-label')) {
                    buttonElement.textContent = buttonElement.getAttribute('data-original-label');
                    buttonElement.style.opacity = 1.0;
                }
            } else {
                // First click
                lastClick[key] = now;
                
                // Visual feedback: change text and slightly reduce opacity
                if (buttonElement) {
                    if (!buttonElement.hasAttribute('data-original-label')) {
                        buttonElement.setAttribute('data-original-label', buttonElement.textContent);
                    }
                    buttonElement.textContent = '–î–í–ê–ñ–î–´';
                    buttonElement.style.opacity = 0.6;
                    
                    // Revert state if the second click doesn't happen in time
                    setTimeout(() => {
                        if (lastClick[key] === now) {
                            buttonElement.textContent = buttonElement.getAttribute('data-original-label');
                            buttonElement.style.opacity = 1.0;
                            lastClick[key] = 0; // Timeout, reset
                        }
                    }, DOUBLE_CLICK_DELAY);
                }
            }
        }
        // --- END DOUBLE CLICK LOGIC ---
        
        // --- COLLAPSE LOGIC (NEW) ---
        function toggleGroupCollapse(contentId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(contentId + '-icon');
            
            if (content.classList.contains('collapsed')) {
                // Expand
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed-icon-state');
                // Set max-height for smooth transition
                content.style.maxHeight = content.scrollHeight + 'px';
                // Reset to large value after transition to allow content changes
                setTimeout(() => {
                    content.style.maxHeight = '2000px'; 
                }, 300); 
            } else {
                // Collapse
                content.style.maxHeight = content.scrollHeight + 'px'; // Set current height
                
                // Trigger reflow/transition, then set to 0
                setTimeout(() => {
                    content.classList.add('collapsed');
                    icon.classList.add('collapsed-icon-state');
                    content.style.maxHeight = '0';
                }, 10);
            }
        }
        // --- END COLLAPSE LOGIC ---

        // --- GROUP REMOVAL DOUBLE CLICK ---
        function handleGroupRemoval(idx, button) {
            const now = Date.now();
            const lastClickTime = doubleClickGroupRemove[idx] || 0;
            
            if (now - lastClickTime < DOUBLE_CLICK_DELAY) {
                // Second click - remove group
                if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –≥—Ä—É–ø–ø—É –Ω–∞—Å—Ç—Ä–æ–µ–∫?")) {
                    appSettings.groups.splice(idx, 1);
                    renderSettingsForm();
                }
                doubleClickGroupRemove[idx] = 0;
                button.textContent = "–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É";
                button.style.backgroundColor = "#ef4444";
            } else {
                // First click
                doubleClickGroupRemove[idx] = now;
                button.textContent = "–ù–∞–∂–º–∏—Ç–µ –µ—â–µ —Ä–∞–∑";
                button.style.backgroundColor = "#f59e0b";
                
                // Reset after delay
                setTimeout(() => {
                    if (doubleClickGroupRemove[idx] === now) {
                        button.textContent = "–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É";
                        button.style.backgroundColor = "#ef4444";
                        doubleClickGroupRemove[idx] = 0;
                    }
                }, DOUBLE_CLICK_DELAY);
            }
        }

        // --- SETTINGS LOGIC ---
        function loadSettings() {
            const stored = localStorage.getItem(STORAGE_KEY_SETTINGS);
            if (stored) {
                appSettings = JSON.parse(stored);
                
                // Backward compatibility checks for general controls
                if (typeof appSettings.minReportMinutes === 'undefined') {
                    appSettings.minReportMinutes = DEFAULT_SETTINGS.minReportMinutes;
                }
                const defaultControls = DEFAULT_SETTINGS.generalControls;
                if (!appSettings.generalControls) appSettings.generalControls = {};
                for (const key in defaultControls) {
                    if (typeof appSettings.generalControls[key] === 'undefined') {
                        appSettings.generalControls[key] = defaultControls[key];
                    }
                }
                
                appSettings.groups.forEach(g => {
                    if (typeof g.warnYellow === 'undefined') g.warnYellow = 5;
                    if (typeof g.warnRed === 'undefined') g.warnRed = 2;
                    // NEW: Group active state
                    if (typeof g.isActive === 'undefined') g.isActive = true;
                    if (typeof g.showSummaryButton === 'undefined') g.showSummaryButton = true;
                    if (typeof g.timerColor === 'undefined') g.timerColor = "#2563eb";
                    if (typeof g.timerIcon === 'undefined') g.timerIcon = "";
                    
                    // REMOVED: fixedButtons default initialization
                    // NEW: Compatibility for fixedExtensionButtons
                    if (typeof g.fixedExtensionButtons === 'undefined') g.fixedExtensionButtons = []; 
                    
                    // NEW: Compatibility for additionalServiceButtons
                    if (typeof g.additionalServiceButtons === 'undefined') g.additionalServiceButtons = [];

                    // Reset Double Click Check
                    if (typeof g.resetDoubleClickRequired === 'undefined') {
                        g.resetDoubleClickRequired = false;
                    }

                    // Reset Report Config for groups
                    const defaultRRC = DEFAULT_SETTINGS.groups[0].resetReportConfig;
                    if (typeof g.resetReportConfig === 'undefined') g.resetReportConfig = {};
                    for (const key in defaultRRC) {
                        if (typeof g.resetReportConfig[key] === 'undefined') {
                            g.resetReportConfig[key] = defaultRRC[key];
                        }
                    }

                    // Compatibility for Standard Buttons (Extension)
                    g.buttons.forEach(btn => { 
                        if (typeof btn.isVisible === 'undefined') btn.isVisible = true; 
                        if (typeof btn.doubleClickRequired === 'undefined') btn.doubleClickRequired = false;
                        if (typeof btn.enableOvertime === 'undefined') btn.enableOvertime = true;

                        // FIX: Standard Button Report Config
                        const defaultFRC = FIXED_REPORT_DEFAULTS; 
                        if (typeof btn.reportConfig === 'undefined') btn.reportConfig = {};
                        for (const key of ALL_REPORT_KEYS) {
                            if (typeof btn.reportConfig[key] === 'undefined') {
                                btn.reportConfig[key] = defaultFRC[key] || false; 
                            }
                        }
                    });

                    // REMOVED: fixedButtons iteration
                    
                    // NEW: Compatibility for fixedExtensionButtons
                    g.fixedExtensionButtons.forEach(btn => { 
                        if (typeof btn.isVisible === 'undefined') btn.isVisible = true; 
                        if (typeof btn.doubleClickRequired === 'undefined') btn.doubleClickRequired = false;
                        if (typeof btn.durationValue === 'undefined') btn.durationValue = 1; 
                        if (typeof btn.durationUnit === 'undefined') btn.durationUnit = 'minute'; 
                        if (typeof btn.enableOvertime === 'undefined') btn.enableOvertime = true; // Default

                        // FIX: Fixed Button Report Config - Ensure ALL keys are present
                        const defaultFRC = FIXED_REPORT_DEFAULTS; 
                        if (typeof btn.fixedReportConfig === 'undefined') btn.fixedReportConfig = {};
                        
                        for (const key of ALL_REPORT_KEYS) {
                            if (typeof btn.fixedReportConfig[key] === 'undefined') {
                                btn.fixedReportConfig[key] = defaultFRC[key] || false; 
                            }
                        }
                    });

                    // NEW: Additional Services Iteration
                    g.additionalServiceButtons.forEach(btn => {
                        if (typeof btn.isVisible === 'undefined') btn.isVisible = true;
                    });
                });
            } else {
                appSettings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
            }
        }

        function getGroupForId(id) {
            return appSettings.groups.find(g => g.ids.includes(id)) || appSettings.groups[0];
        }

        // --- PASSWORD MODAL LOGIC ---
        function requestPassword(callback) {
            onPasswordSuccess = callback;
            document.getElementById('modal-password-input').value = '';
            document.getElementById('passwordModal').classList.add('modal-visible');
            document.getElementById('modal-password-input').focus();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('modal-visible');
            onPasswordSuccess = null;
        }

        document.getElementById('modal-password-submit').addEventListener('click', () => {
            const pwd = document.getElementById('modal-password-input').value;
            if (pwd === getAdminPassword()) {
                const callbackToRun = onPasswordSuccess;
                closePasswordModal();
                if (callbackToRun) callbackToRun();
            } else {
                alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
                document.getElementById('modal-password-input').value = '';
                document.getElementById('modal-password-input').focus();
            }
        });

        // Add Enter key support
        document.getElementById('modal-password-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('modal-password-submit').click();
            }
        });

        function openSettings() {
            renderSettingsForm();
            document.getElementById('settingsModal').classList.add('modal-visible');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('modal-visible');
        }
        
        // NEW: Report Modal Functions
        function openReportModal() {
            // Populate group select
            const groupSelect = document.getElementById('reportGroupSelect');
            groupSelect.innerHTML = '<option value="all">–í—Å–µ –≥—Ä—É–ø–ø—ã</option>';
            appSettings.groups.forEach((g, idx) => {
                if (g.isActive) {
                    const option = document.createElement('option');
                    option.value = idx;
                    option.textContent = g.name;
                    groupSelect.appendChild(option);
                }
            });
            
            // Set default dates (last 7 –¥–Ω–µ–π)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            
            document.getElementById('reportStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('reportShiftNumber').value = '';
            document.getElementById('reportWorkerName').value = '';
            
            document.getElementById('reportModal').classList.add('modal-visible');
        }
        
        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('modal-visible');
        }
        
        // NEW: Restore Modal Functions
        function openRestoreModal() {
            // Set default dates (last 30 –¥–Ω–µ–π)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('restoreStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('restoreEndDate').value = endDate.toISOString().split('T')[0];
            
            document.getElementById('restoreModal').classList.add('modal-visible');
        }
        
        function closeRestoreModal() {
            document.getElementById('restoreModal').classList.remove('modal-visible');
        }

        // --- PASSWORD MANAGEMENT LOGIC ---
        function changePassword() {
            const oldPwd = document.getElementById('sec-old-pwd').value;
            const newPwd1 = document.getElementById('sec-new-pwd-1').value;
            const newPwd2 = document.getElementById('sec-new-pwd-2').value;

            if (oldPwd !== getAdminPassword()) {
                alert("–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å –≤–≤–µ–¥–µ–Ω –Ω–µ–≤–µ—Ä–Ω–æ.");
                return;
            }
            if (newPwd1.length === 0) {
                alert("–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.");
                return;
            }
            if (newPwd1 !== newPwd2) {
                alert("–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.");
                return;
            }

            setAdminPassword(newPwd1);
            alert("–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!");
            // Clear inputs
            document.getElementById('sec-old-pwd').value = '';
            document.getElementById('sec-new-pwd-1').value = '';
            document.getElementById('sec-new-pwd-2').value = '';
        }

        function resetMasterPasswordFromModal() {
            // Only prompts for master key, bypassing the user password check
            const code = prompt("–í–≤–µ–¥–∏—Ç–µ –º–∞—Å—Ç–µ—Ä-–∫–æ–¥ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è:");
            if (code === MASTER_RESET_KEY) {
                setAdminPassword('0000');
                alert("–ü–∞—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω –Ω–∞: 0000");
                closePasswordModal();
            } else {
                alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥.");
            }
        }
        
        function resetMasterPassword() {
             const code = prompt("–í–≤–µ–¥–∏—Ç–µ –º–∞—Å—Ç–µ—Ä-–∫–æ–¥ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è:");
            if (code === MASTER_RESET_KEY) {
                setAdminPassword('0000');
                alert("–ü–∞—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω –Ω–∞: 0000");
            } else {
                alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥.");
            }
        }

        // Helper function to generate report config toggles
        function generateReportConfigToggles(config, prefix, type) {
            // Comprehensive list of fields and their labels
            const fields = {
                // Fixed Payment Fields (Relevant)
                showPaymentTime: '–í—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã',
                showLabel: '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏',
                showAmount: '–°—É–º–º–∞',
                // Timer Report Fields (As in Reset)
                showStartTime: '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–µ—Å—Å–∏–∏',
                showResetTime: '–í—Ä–µ–º—è —Å–±—Ä–æ—Å–∞ (–∫–æ–Ω–µ—Ü)',
                showTotalPause: '–û–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞—É–∑—ã',
                showPauseDetails: '–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—É–∑',
                showInitialMinutes: '–ú–∏–Ω. –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é',
                showExtensionMinutes: '–ú–∏–Ω. –ø—Ä–æ–¥–ª–µ–Ω–∏–π',
                showBaseCost: '–°—Ç–æ–∏–º–æ—Å—Ç—å –±–∞–∑—ã',
                showExtensionCost: '–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–π',
                showOvertimeDuration: '–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ (–¥–ª–∏—Ç.)',
                showOvertimeCost: '–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ (—à—Ç—Ä–∞—Ñ)',
                showRate: '–¢–∞—Ä–∏—Ñ (–†—É–±/–º–∏–Ω)',
                showTotalCost: '–ò–¢–û–ì–û (–û–±—â–∞—è —Å—É–º–º–∞)'
            };
            
            let html = `<div class="settings-label" style="color: #4338ca; font-size: 1rem; margin-bottom: 0.5rem; font-weight: 700;">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç—á–µ—Ç–∞ (${type}):</div>`;

            // Filter fields based on the config keys and use the ALL_REPORT_KEYS order
            for (const key of ALL_REPORT_KEYS) {
                if (config.hasOwnProperty(key)) {
                    html += `
                        <div class="switch-row" style="padding: 0.25rem 0; border-bottom: none; border-top: 1px dashed #e5e7eb;">
                            <span class="full-label" style="font-size: 0.85rem; font-weight: 500;">${fields[key] || key}:</span>
                            <label class="switch" style="width: 35px; height: 20px;">
                                <input type="checkbox" id="${prefix}-${key}" ${config[key] ? 'checked' : ''}>
                                <span class="slider" style="border-radius: 20px;"></span>
                            </label>
                        </div>
                    `;
                }
            }
            return html;
        }

        // --- DYNAMIC SETTINGS ACTIONS (FIXED EXTENSION) ---
        window.addSettingFixedExtensionButton = (groupIdx) => {
            appSettings.groups[groupIdx].fixedExtensionButtons.push({ 
                label: "1 —á–∞—Å (600—Ä)", amount: 600, durationValue: 1, durationUnit: "hour", 
                color: "indigo", isVisible: true, doubleClickRequired: false, enableOvertime: true,
                fixedReportConfig: JSON.parse(JSON.stringify(FIXED_REPORT_DEFAULTS)) 
            });
            renderSettingsForm(); 
        };

        window.removeSettingFixedExtensionButton = (groupIdx, btnIdx) => {
            appSettings.groups[groupIdx].fixedExtensionButtons.splice(btnIdx, 1);
            renderSettingsForm();
        };
        
        // --- DYNAMIC SETTINGS ACTIONS (ADDITIONAL SERVICES) ---
        window.addSettingAdditionalServiceButton = (groupIdx) => {
            appSettings.groups[groupIdx].additionalServiceButtons.push({ label: "–®–ª–µ–º", amount: 200, isVisible: true });
            renderSettingsForm();
        };
        
        window.removeSettingAdditionalServiceButton = (groupIdx, btnIdx) => {
            appSettings.groups[groupIdx].additionalServiceButtons.splice(btnIdx, 1);
            renderSettingsForm();
        };

        // NEW: Helper to toggle duration input when Infinity is selected
        window.toggleDurationInput = (selectEl, groupIdx, febIdx) => {
            const inputEl = document.getElementById(`g-${groupIdx}-feb-${febIdx}-duration-val`);
            if (!inputEl) return;
            
            if (selectEl.value === 'infinity') {
                inputEl.dataset.savedVal = inputEl.value; // Save current value
                inputEl.value = '‚àû';
                inputEl.disabled = true;
            } else {
                inputEl.disabled = false;
                // Restore saved value or default to 1 if coming from infinity for the first time
                if (inputEl.value === '‚àû') {
                     inputEl.value = inputEl.dataset.savedVal || 1;
                }
            }
        };

        function renderSettingsForm() {
            const container = document.getElementById('settingsContainer');
            const gc = appSettings.generalControls;
            
            let html = `
                <div class="settings-group" style="border-color: #f87171; background-color: #fef2f2;">
                    <div class="group-header" onclick="toggleGroupCollapse('group-security-content')" style="cursor:pointer; color: #b91c1c;">
                        <h3 style="color: #b91c1c;">üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h3>
                        <span id="group-security-content-icon" class="collapse-icon">‚ñº</span>
                    </div>
                    <div id="group-security-content" class="group-content collapsed">
                        <label class="settings-label">–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="sec-old-pwd" class="settings-input">
                        
                        <label class="settings-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="sec-new-pwd-1" class="settings-input">
                        
                        <label class="settings-label">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="sec-new-pwd-2" class="settings-input">

                        <div style="display: flex; gap: 10px; margin-top: 1rem;">
                            <button class="settings-action-btn" style="background-color: #ef4444; color: white; margin-top: 0;" onclick="changePassword()">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                            <button class="settings-action-btn" style="background-color: #6b7280; color: white; margin-top: 0; font-size: 0.9rem;" onclick="resetMasterPassword()">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
                        </div>
                    </div>
                </div>

                <div class="settings-group">
                    <div class="group-header" onclick="toggleGroupCollapse('group-general-content')" style="cursor:pointer;">
                        <h3>–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>
                        <span id="group-general-content-icon" class="collapse-icon">‚ñº</span>
                    </div>
                    <div id="group-general-content" class="group-content">
                        <label class="settings-label">–ê–∫—Ç–∏–≤–Ω—ã–π ‚Ññ —Ç–∞–π–º–µ—Ä–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:</label>
                        <input type="text" id="set-active-timers" class="settings-input" value="${appSettings.activeTimers}">
                        
                        <label class="settings-label">–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ–∫–∞ (–º–∏–Ω):</label>
                        <input type="number" step="0.1" class="settings-input" value="${appSettings.minReportMinutes}" id="set-min-report-minutes" min="0">
                    </div>
                </div>

                <div class="settings-group">
                    <div class="group-header" onclick="toggleGroupCollapse('group-motohours-content')" style="cursor:pointer;">
                        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã</h3>
                        <span id="group-motohours-content-icon" class="collapse-icon">‚ñº</span>
                    </div>
                    <div id="group-motohours-content" class="group-content">
                        <div class="switch-row">
                            <span class="full-label">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ü–∞—É–∑–∞" –Ω–∞ –≤—Å–µ—Ö —Ç–∞–π–º–µ—Ä–∞—Ö:</span>
                            <label class="switch">
                                <input type="checkbox" id="set-pause-visible" ${gc.pauseButtonVisible ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-row">
                            <span class="full-label">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã:</span>
                            <label class="switch">
                                <input type="checkbox" id="set-motohours-visible" ${gc.motohoursBlockVisible ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <label class="settings-label">–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞ —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã:</label>
                        <input type="text" id="set-motohours-name" class="settings-input" value="${gc.motohoursName}">

                        <label class="settings-label">ID —Ç–∞–π–º–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—Ö–æ–¥—è—Ç –≤ —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                        <input type="text" id="set-motohours-ids" class="settings-input" value="${gc.motohoursIds}">

                        <div class="switch-row">
                            <span class="full-label">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ü–æ–ª–Ω–∞—è –°–≤–æ–¥–∫–∞":</span>
                            <label class="switch">
                                <input type="checkbox" id="set-summary-visible" ${gc.fullSummaryVisible ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- –ù–û–í–´–ô –ë–õ–û–ö –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–ú–ï–ù–ê–ú–ò -->
                <div class="settings-group">
                    <div class="group-header" onclick="toggleGroupCollapse('group-shifts-content')" style="cursor:pointer;">
                        <h3>üïê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–º–µ–Ω–∞–º–∏</h3>
                        <span id="group-shifts-content-icon" class="collapse-icon">‚ñº</span>
                    </div>
                    <div id="group-shifts-content" class="group-content collapsed">
                        <p style="margin-bottom: 1rem; color: #4b5563;">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ —Å–º–µ–Ω–∞–º –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
                        <button class="settings-action-btn" style="background-color: #8b5cf6; color: white;" onclick="openShiftReportsModal()">
                            üìä –û—Ç—á–µ—Ç—ã –ø–æ —Å–º–µ–Ω–∞–º
                        </button>
                        
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                            <div class="settings-label">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω–æ–π —Å–º–µ–Ω:</div>
                            <button class="settings-action-btn" style="background-color: #ef4444; color: white; margin-top: 0.5rem;" onclick="openRestoreShiftsModal()">
                                –ö–æ—Ä–∑–∏–Ω–∞ —Å–º–µ–Ω (${deletedShifts.length})
                            </button>
                            <button class="settings-action-btn shift-action-dblclick" style="background-color: #dc2626; color: white; margin-top: 0.5rem;" onclick="handleDoubleClick('deleteAllShifts', deleteAllShifts)">
                                –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–º–µ–Ω—ã
                            </button>
                        </div>
                        
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                            <div class="settings-label">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–º–µ–Ω:</div>
                            <div style="background-color: #f3f4f6; padding: 0.75rem; border-radius: 0.5rem;">
                                –í—Å–µ–≥–æ —Å–º–µ–Ω –≤ –∏—Å—Ç–æ—Ä–∏–∏: <strong>${shiftHistory.length}</strong><br>
                                –°–º–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω–µ: <strong>${deletedShifts.length}</strong><br>
                                ${currentShift && currentShift.isOpen ? `–¢–µ–∫—É—â–∞—è —Å–º–µ–Ω–∞: <strong>#${currentShift.shiftNumber}</strong> (–æ—Ç–∫—Ä—ã—Ç–∞)` : '–¢–µ–∫—É—â–∞—è —Å–º–µ–Ω–∞: <strong>–Ω–µ –æ—Ç–∫—Ä—ã—Ç–∞</strong>'}
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                            <div class="settings-label">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö:</div>
                            <button class="settings-action-btn" style="background-color: #10b981; color: white; margin-top: 0.5rem;" onclick="exportAllShiftsData()">
                                –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Å–º–µ–Ω
                            </button>
                            <button class="settings-action-btn shift-action-dblclick" style="background-color: #b91c1c; color: white; margin-top: 0.5rem;" onclick="handleDoubleClick('clearAllShiftsHistory', clearAllShiftsHistory)">
                                –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Å–º–µ–Ω
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Report Generation Section -->
                <div class="settings-group report-section">
                    <div class="group-header" onclick="toggleGroupCollapse('group-report-content')" style="cursor:pointer;">
                        <h3>üìä –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤</h3>
                        <span id="group-report-content-icon" class="collapse-icon">‚ñº</span>
                    </div>
                    <div id="group-report-content" class="group-content collapsed">
                        <p style="margin-bottom: 1rem; color: #4b5563;">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ –ø–æ —á–µ–∫–∞–º –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –Ω–æ–º–µ—Ä—É —Å–º–µ–Ω—ã –∏ –∏–º–µ–Ω–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞</p>
                        <button class="settings-action-btn" style="background-color: #10b981; color: white;" onclick="openReportModal()">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç</button>
                    </div>
                </div>

                <!-- Restore Checks Section -->
                <div class="settings-group report-section">
                    <div class="group-header" onclick="toggleGroupCollapse('group-restore-content')" style="cursor:pointer;">
                        <h3>üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ–∫–æ–≤</h3>
                        <span id="group-restore-content-icon" class="collapse-icon">‚ñº</span>
                    </div>
                    <div id="group-restore-content" class="group-content collapsed">
                        <p style="margin-bottom: 1rem; color: #4b5563;">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —á–µ–∫–æ–≤</p>
                        <button class="settings-action-btn" style="background-color: #3b82f6; color: white;" onclick="openRestoreModal()">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ–∫–∏</button>
                    </div>
                </div>
            `;

            appSettings.groups.forEach((g, idx) => {
                let btnsHtml = '';
                g.buttons.forEach((btn, bIdx) => {
                    // FULL CONFIG FOR STANDARD BUTTONS
                    btnsHtml += `
                        <div class="btn-config-row" style="flex-direction: column; align-items: flex-start; flex-wrap: nowrap; padding: 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                            
                             <div style="display: flex; gap: 0.5rem; width: 100%; margin-bottom: 0.8rem; align-items: center;">
                                <div style="flex: 1;">
                                    <label style="font-size: 0.75rem; color: #6b7280; font-weight: 600; display: block; margin-bottom: 2px;">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                    <input type="text" class="btn-config-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (+10)" value="${btn.label}" id="g-${idx}-b-${bIdx}-label" style="width: 100%;">
                                </div>
                                <div style="width: 60px;">
                                    <label style="font-size: 0.75rem; color: #6b7280; font-weight: 600; display: block; margin-bottom: 2px;">–ú–∏–Ω</label>
                                    <input type="number" class="btn-config-input" placeholder="–ú–∏–Ω" value="${btn.minutes}" style="width: 100%;" id="g-${idx}-b-${bIdx}-min">
                                </div>
                                <div style="width: 90px;">
                                    <label style="font-size: 0.75rem; color: #6b7280; font-weight: 600; display: block; margin-bottom: 2px;">–¶–≤–µ—Ç</label>
                                    <select class="btn-config-color" id="g-${idx}-b-${bIdx}-color" style="width: 100%; height: 34px;">
                                        <option value="blue" ${btn.color==='blue'?'selected':''}>–°–∏–Ω–∏–π</option>
                                        <option value="indigo" ${btn.color==='indigo'?'selected':''}>–ò–Ω–¥–∏–≥–æ</option>
                                        <option value="purple" ${btn.color==='purple'?'selected':''}>–§–∏–æ–ª.</option>
                                        <option value="green" ${btn.color==='green'?'selected':''}>–ó–µ–ª–µ–Ω.</option>
                                        <option value="red" ${btn.color==='red'?'selected':''}>–ö—Ä–∞—Å–Ω.</option>
                                        <option value="gray" ${btn.color==='gray'?'selected':''}>–°–µ—Ä—ã–π</option>
                                    </select>
                                </div>
                            </div>

                            <div style="display: flex; gap: 0.8rem; align-items: center; justify-content: space-between; width: 100%;">
                                <div class="toggle-wrapper" title="–ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∞ –ø–∞–Ω–µ–ª–∏" style="width: auto; flex-direction: column; align-items: center; gap: 2px;">
                                    <label class="toggle-label" style="margin-bottom:0;">–ü–æ–∫–∞–∑</label>
                                    <label class="switch" style="width: 35px; height: 20px; margin:0;">
                                        <input type="checkbox" id="g-${idx}-b-${bIdx}-visible" ${btn.isVisible ? 'checked' : ''}>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="toggle-wrapper" title="–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫" style="width: auto; flex-direction: column; align-items: center; gap: 2px;">
                                    <label class="toggle-label" style="font-weight: 700; color: #10b981; margin-bottom:0;">DBL</label>
                                    <label class="switch" style="width: 35px; height: 20px; margin:0;">
                                        <input type="checkbox" id="g-${idx}-b-${bIdx}-dblclick" ${btn.doubleClickRequired ? 'checked' : ''}>
                                        <span class="slider double-click-slider"></span>
                                    </label>
                                </div>

                                <div class="toggle-wrapper" title="–°—á–∏—Ç–∞—Ç—å –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É" style="width: auto; flex-direction: column; align-items: center; gap: 2px;">
                                    <label class="toggle-label" style="font-weight: 700; color: #dc2626; margin-bottom:0;">–ü–ï–†–ï</label>
                                    <label class="switch" style="width: 35px; height: 20px; margin:0;">
                                        <input type="checkbox" id="g-${idx}-b-${bIdx}-overtime" ${btn.enableOvertime !== false ? 'checked' : ''}>
                                        <span class="slider"></span>
                                    </label>
                                </div>

                                <button class="remove-btn" onclick="removeSettingButton(${idx}, ${bIdx})" style="height: 34px; width: 34px; display: flex; align-items: center; justify-content: center; padding: 0;">X</button>
                            </div>
                            
                            <div onclick="toggleGroupCollapse('g-${idx}-b-${bIdx}-report-container')" class="collapsible-header" style="width: 100%; border-top: 1px dotted #ccc; margin-top: 10px; font-size: 0.85rem;">
                                <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç—á–µ—Ç–∞</span>
                                <span id="g-${idx}-b-${bIdx}-report-container-icon" class="collapse-icon collapsed-icon-state" style="font-size: 1rem;">‚ñº</span>
                            </div>
                            <div id="g-${idx}-b-${bIdx}-report-container" class="collapsible-content collapsed" style="border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.75rem; width: 100%; background: #f9fafb;">
                                ${generateReportConfigToggles(btn.reportConfig, `g-${idx}-b-${bIdx}-report`, '–ü—Ä–æ–¥–ª–µ–Ω–∏–µ')}
                            </div>
                        </div>
                    `;
                });

                
                // NEW: Fixed Extension Buttons HTML Generation (UPDATED FOR INFINITY)
                let fixedExtensionBtnsHtml = '';
                g.fixedExtensionButtons.forEach((btn, febIdx) => {
                    const isInfinity = btn.durationUnit === 'infinity';
                    
                    fixedExtensionBtnsHtml += `
                        <div class="btn-config-row" style="flex-direction: column; align-items: flex-start; flex-wrap: nowrap; padding: 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                            
                            <div style="display: flex; gap: 0.5rem; width: 100%; margin-bottom: 0.8rem; align-items: center;">
                                <div style="flex: 1;">
                                    <label style="font-size: 0.75rem; color: #6b7280; font-weight: 600; display: block; margin-bottom: 2px;">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                    <input type="text" class="btn-config-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (+1 —á–∞—Å)" value="${btn.label}" id="g-${idx}-feb-${febIdx}-label" style="width: 100%;">
                                </div>
                                <div style="width: 80px;">
                                    <label style="font-size: 0.75rem; color: #6b7280; font-weight: 600; display: block; margin-bottom: 2px;">–°—É–º–º–∞</label>
                                    <input type="number" class="btn-config-input" placeholder="–†—É–±" value="${btn.amount}" id="g-${idx}-feb-${febIdx}-amount" min="0" style="width: 100%;">
                                </div>
                            </div>

                            <div style="display: flex; gap: 0.5rem; width: 100%; align-items: flex-end; justify-content: space-between; flex-wrap: wrap;">
                                
                                <div style="display: flex; gap: 2px; align-items: flex-end;">
                                    <div style="width: 50px;">
                                        <label style="font-size: 0.75rem; color: #6b7280; font-weight: 600; display: block; margin-bottom: 2px;">–î–ª–∏—Ç.</label>
                                        <input type="text" class="btn-config-input" 
                                            value="${isInfinity ? '‚àû' : btn.durationValue}" 
                                            id="g-${idx}-feb-${febIdx}-duration-val" 
                                            style="width: 100%;" 
                                            ${isInfinity ? 'disabled' : ''}>
                                    </div>
                                    <div style="width: 75px;">
                                        <select class="btn-config-color" id="g-${idx}-feb-${febIdx}-duration-unit" 
                                            style="width: 100%; height: 34px;"
                                            onchange="toggleDurationInput(this, ${idx}, ${febIdx})">
                                            <option value="minute" ${btn.durationUnit==='minute'?'selected':''}>–ú–∏–Ω.</option>
                                            <option value="hour" ${btn.durationUnit==='hour'?'selected':''}>–ß–∞—Å</option>
                                            <option value="infinity" ${btn.durationUnit==='infinity'?'selected':''}>‚àû</option>
                                        </select>
                                    </div>
                                </div>

                                <div style="width: 90px;">
                                    <label style="font-size: 0.75rem; color: #6b7280; font-weight: 600; display: block; margin-bottom: 2px;">–¶–≤–µ—Ç</label>
                                    <select class="btn-config-color" id="g-${idx}-feb-${febIdx}-color" style="width: 100%; height: 34px;">
                                        <option value="blue" ${btn.color==='blue'?'selected':''}>–°–∏–Ω–∏–π</option>
                                        <option value="indigo" ${btn.color==='indigo'?'selected':''}>–ò–Ω–¥–∏–≥–æ</option>
                                        <option value="purple" ${btn.color==='purple'?'selected':''}>–§–∏–æ–ª.</option>
                                        <option value="green" ${btn.color==='green'?'selected':''}>–ó–µ–ª–µ–Ω.</option>
                                        <option value="red" ${btn.color==='red'?'selected':''}>–ö—Ä–∞—Å–Ω.</option>
                                        <option value="gray" ${btn.color==='gray'?'selected':''}>–°–µ—Ä—ã–π</option>
                                    </select>
                                </div>

                                <div style="display: flex; gap: 0.8rem; align-items: center; padding-bottom: 5px;">
                                    <div class="toggle-wrapper" title="–ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∞ –ø–∞–Ω–µ–ª–∏" style="width: auto; flex-direction: column; align-items: center; gap: 2px;">
                                        <label class="toggle-label" style="margin-bottom:0;">–ü–æ–∫–∞–∑</label>
                                        <label class="switch" style="width: 35px; height: 20px; margin:0;">
                                            <input type="checkbox" id="g-${idx}-feb-${febIdx}-visible" ${btn.isVisible ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    
                                    <div class="toggle-wrapper" title="–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫" style="width: auto; flex-direction: column; align-items: center; gap: 2px;">
                                        <label class="toggle-label" style="font-weight: 700; color: #10b981; margin-bottom:0;">DBL</label>
                                        <label class="switch" style="width: 35px; height: 20px; margin:0;">
                                            <input type="checkbox" id="g-${idx}-feb-${febIdx}-dblclick" ${btn.doubleClickRequired ? 'checked' : ''}>
                                            <span class="slider double-click-slider"></span>
                                        </label>
                                    </div>

                                    <div class="toggle-wrapper" title="–°—á–∏—Ç–∞—Ç—å –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É" style="width: auto; flex-direction: column; align-items: center; gap: 2px;">
                                        <label class="toggle-label" style="font-weight: 700; color: #dc2626; margin-bottom:0;">–ü–ï–†–ï</label>
                                        <label class="switch" style="width: 35px; height: 20px; margin:0;">
                                            <input type="checkbox" id="g-${idx}-feb-${febIdx}-overtime" ${btn.enableOvertime !== false ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <button class="remove-btn" onclick="removeSettingFixedExtensionButton(${idx}, ${febIdx})" style="height: 34px; width: 34px; display: flex; align-items: center; justify-content: center; padding: 0;">X</button>
                            </div>
                            
                            <div onclick="toggleGroupCollapse('g-${idx}-feb-${febIdx}-report-container')" class="collapsible-header" style="width: 100%; border-top: 1px dotted #ccc; margin-top: 10px; font-size: 0.85rem;">
                                <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ–∫–∞ —Ç–∞–π–º–µ—Ä–∞</span>
                                <span id="g-${idx}-feb-${febIdx}-report-container-icon" class="collapse-icon collapsed-icon-state" style="font-size: 1rem;">‚ñº</span>
                            </div>
                            <div id="g-${idx}-feb-${febIdx}-report-container" class="collapsible-content collapsed" style="border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.75rem; width: 100%; background: #f9fafb;">
                                ${generateReportConfigToggles(btn.fixedReportConfig, `g-${idx}-feb-${febIdx}-report`, '–§–∏–∫—Å. –ü—Ä–æ–¥–ª–µ–Ω–∏–µ')}
                            </div>
                        </div>
                    `;
                });
                
                // NEW: Additional Services Buttons HTML
                let additionalServicesBtnsHtml = '';
                g.additionalServiceButtons.forEach((btn, asbIdx) => {
                    additionalServicesBtnsHtml += `
                        <div class="btn-config-row">
                             <input type="text" class="btn-config-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–®–ª–µ–º)" value="${btn.label}" id="g-${idx}-asb-${asbIdx}-label">
                             <input type="number" class="btn-config-input" placeholder="–°—É–º–º–∞" value="${btn.amount}" style="width:80px;" id="g-${idx}-asb-${asbIdx}-amount">
                             <div class="toggle-wrapper" title="–ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∞ –ø–∞–Ω–µ–ª–∏">
                                <label class="toggle-label">–ü–æ–∫–∞–∑</label>
                                <label class="switch">
                                    <input type="checkbox" id="g-${idx}-asb-${asbIdx}-visible" ${btn.isVisible ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <button class="remove-btn" onclick="removeSettingAdditionalServiceButton(${idx}, ${asbIdx})">X</button>
                        </div>
                    `;
                });

                // MAIN GROUP CONTAINER
                html += `
                    <div class="settings-group">
                        <div class="group-header" onclick="toggleGroupCollapse('group-${idx}-content')" style="cursor:pointer;">
                            <h3>–ì—Ä—É–ø–ø–∞ #${idx + 1} - ${g.name}</h3>
                            <div style="display:flex; align-items:center;">
                                <button class="remove-btn" onclick="event.stopPropagation(); handleGroupRemoval(${idx}, this)" style="margin-right: 10px;">–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
                                <span id="group-${idx}-content-icon" class="collapse-icon">‚ñº</span>
                            </div>
                        </div>
                        <div id="group-${idx}-content" class="group-content">
                            <label class="settings-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:</label>
                            <input type="text" class="settings-input" value="${g.name}" id="g-${idx}-name">
                            
                            <div class="switch-row">
                                <span class="full-label">–ì—Ä—É–ø–ø–∞ –∞–∫—Ç–∏–≤–Ω–∞ (–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ):</span>
                                <label class="switch">
                                    <input type="checkbox" id="g-${idx}-active" ${g.isActive ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="switch-row">
                                <span class="full-label">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É —Å–≤–æ–¥–∫–∏ –¥–ª—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã:</span>
                                <label class="switch">
                                    <input type="checkbox" id="g-${idx}-show-summary" ${g.showSummaryButton ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" style="margin-top: 1rem;">
                                <div>
                                    <label class="settings-label">–¶–≤–µ—Ç –Ω–æ–º–µ—Ä–∞ —Ç–∞–π–º–µ—Ä–∞:</label>
                                    <input type="color" class="settings-input" value="${g.timerColor}" id="g-${idx}-timer-color" style="height: 40px; padding: 0.2rem;">
                                </div>
                                <div>
                                    <label class="settings-label">–ò–∫–æ–Ω–∫–∞ –≤–º–µ—Å—Ç–æ –Ω–æ–º–µ—Ä–∞ (emoji –∏–ª–∏ —Ç–µ–∫—Å—Ç):</label>
                                    <input type="text" class="settings-input" value="${g.timerIcon}" id="g-${idx}-timer-icon" placeholder="üèçÔ∏è –∏–ª–∏ —Ç–µ–∫—Å—Ç">
                                </div>
                            </div>

                            <label class="settings-label">–ê–∫—Ç–∏–≤–Ω—ã–π ‚Ññ —Ç–∞–π–º–µ—Ä–∞ –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:</label>
                            <input type="text" class="settings-input" value="${g.ids.join(',')}" id="g-${idx}-ids">
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="settings-label">–í—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–º–∏–Ω):</label>
                                    <input type="number" class="settings-input" value="${g.defaultMinutes}" id="g-${idx}-def">
                                </div>
                                <div>
                                    <label class="settings-label">–¢–∞—Ä–∏—Ñ (–†—É–±/–º–∏–Ω):</label>
                                    <input type="number" step="0.01" class="settings-input" value="${g.rate}" id="g-${idx}-rate">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="settings-label">–ñ–µ–ª—Ç—ã–π (–º–∏–Ω –¥–æ –∫–æ–Ω—Ü–∞):</label>
                                    <input type="number" class="settings-input" value="${g.warnYellow || 5}" id="g-${idx}-warn-yellow">
                                </div>
                                <div>
                                    <label class="settings-label">–ö—Ä–∞—Å–Ω—ã–π (–º–∏–Ω –¥–æ –∫–æ–Ω—Ü–∞):</label>
                                    <input type="number" class="settings-input" value="${g.warnRed || 2}" id="g-${idx}-warn-red">
                                </div>
                            </div>
                            
                            <div class="switch-row" style="margin-top: 1rem;">
                                <span class="full-label" style="font-weight: 700; color: #10b981;">–°–±—Ä–æ—Å (Reset): –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫</span>
                                <label class="switch">
                                    <input type="checkbox" id="g-${idx}-reset-dblclick" ${g.resetDoubleClickRequired ? 'checked' : ''}>
                                    <span class="slider double-click-slider"></span>
                                </label>
                            </div>

                            <div onclick="toggleGroupCollapse('g-${idx}-reset-report-content')" class="collapsible-header">
                                <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ–∫–∞ —Ç–∞–π–º–µ—Ä–∞</span>
                                <span id="g-${idx}-reset-report-content-icon" class="collapse-icon collapsed-icon-state">‚ñº</span>
                            </div>
                            <div id="g-${idx}-reset-report-content" class="collapsible-content collapsed" style="border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.75rem; background: #f0f4f7;">
                                ${generateReportConfigToggles(g.resetReportConfig, `g-${idx}-reset-report`, '–ß–µ–∫ –¢–∞–π–º–µ—Ä–∞ (Reset)')}
                            </div>
                            
                            <div onclick="toggleGroupCollapse('g-${idx}-btns-content')" class="collapsible-header">
                                <span>–ö–Ω–æ–ø–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç–∞—Ä–∏—Ñ—É</span>
                                <span id="g-${idx}-btns-content-icon" class="collapse-icon collapsed-icon-state">‚ñº</span>
                            </div>
                            <div id="g-${idx}-btns-content" class="collapsible-content collapsed">
                                <div id="g-${idx}-btns-list">${btnsHtml}</div>
                                <button class="settings-action-btn add-btn-small" onclick="addSettingButton(${idx})">+ –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É</button>
                            </div>
                            
                            <div onclick="toggleGroupCollapse('g-${idx}-fixed-ext-btns-content')" class="collapsible-header">
                                <span>–ö–Ω–æ–ø–∫–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ–ø–ª–∞—Ç—ã</span>
                                <span id="g-${idx}-fixed-ext-btns-content-icon" class="collapse-icon collapsed-icon-state">‚ñº</span>
                            </div>
                            <div id="g-${idx}-fixed-ext-btns-content" class="collapsible-content collapsed">
                                <div id="g-${idx}-fixed-ext-btns-list">${fixedExtensionBtnsHtml}</div>
                                <button class="settings-action-btn add-btn-small" onclick="addSettingFixedExtensionButton(${idx})">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É</button>
                            </div>

                            <div onclick="toggleGroupCollapse('g-${idx}-asb-content')" class="collapsible-header">
                                <span>–ö–Ω–æ–ø–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥</span>
                                <span id="g-${idx}-asb-content-icon" class="collapse-icon collapsed-icon-state">‚ñº</span>
                            </div>
                            <div id="g-${idx}-asb-content" class="collapsible-content collapsed">
                                <div id="g-${idx}-asb-list">${additionalServicesBtnsHtml}</div>
                                <button class="settings-action-btn add-btn-small" onclick="addSettingAdditionalServiceButton(${idx})">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É</button>
                            </div>

                        </div>
                    </div>
                `;
            });

            // ADD GROUP BUTTON
            html += `<button class="settings-action-btn add-group-btn" onclick="addNewGroup()">+ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É</button>`;

            container.innerHTML = html;
            
            // Set initial collapse state for top level groups (Expanded by default)
            const mainGroupIds = ['group-general-content', 'group-motohours-content'];
            mainGroupIds.forEach(id => {
                 const content = document.getElementById(id);
                 if(content) content.style.maxHeight = '2000px'; 
            });
            appSettings.groups.forEach((g, idx) => {
                 const content = document.getElementById(`group-${idx}-content`);
                 if(content) content.style.maxHeight = '2000px'; 
            });
        }

        // --- DYNAMIC SETTINGS ACTIONS (EXTEND) ---
        window.addSettingButton = (groupIdx) => {
            appSettings.groups[groupIdx].buttons.push({ 
                label: "+10", minutes: 10, color: "blue", isVisible: true, 
                doubleClickRequired: false, enableOvertime: true, reportConfig: JSON.parse(JSON.stringify(FIXED_REPORT_DEFAULTS))
            });
            renderSettingsForm(); 
        };

        window.removeSettingButton = (groupIdx, btnIdx) => {
            appSettings.groups[groupIdx].buttons.splice(btnIdx, 1);
            renderSettingsForm();
        };

        window.addNewGroup = () => {
            appSettings.groups.push({
                id: "group_" + Date.now(),
                name: "–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞",
                ids: [],
                defaultMinutes: 10,
                rate: 0,
                warnYellow: 5,
                warnRed: 2,
                resetDoubleClickRequired: false, // Add default
                isActive: true, // NEW: Default active
                showSummaryButton: true, // NEW: Default show summary
                timerColor: "#2563eb", // NEW: Default color
                timerIcon: "", // NEW: Default no icon
                resetReportConfig: JSON.parse(JSON.stringify(DEFAULT_SETTINGS.groups[0].resetReportConfig)),
                buttons: [{ label: "+10", minutes: 10, color: "blue", isVisible: true, doubleClickRequired: false, enableOvertime: true, reportConfig: JSON.parse(JSON.stringify(FIXED_REPORT_DEFAULTS)) }],
                fixedButtons: [],
                fixedExtensionButtons: [], // NEW: Default empty array
                additionalServiceButtons: [] // NEW
            });
            renderSettingsForm();
        };

        function saveSettings() {
            // Read General
            appSettings.activeTimers = document.getElementById('set-active-timers').value.replace(/\s/g,'');
            appSettings.minReportMinutes = parseFloat(document.getElementById('set-min-report-minutes').value) || 0; 
            
            // Read General Controls (NEW) - –ò–°–ü–†–ê–í–õ–ï–ù –¢–ï–ö–°–¢
            appSettings.generalControls.pauseButtonVisible = document.getElementById('set-pause-visible').checked;
            appSettings.generalControls.motohoursBlockVisible = document.getElementById('set-motohours-visible').checked;
            appSettings.generalControls.motohoursName = document.getElementById('set-motohours-name').value;
            appSettings.generalControls.motohoursIds = document.getElementById('set-motohours-ids').value.replace(/\s/g,'');
            appSettings.generalControls.fullSummaryVisible = document.getElementById('set-summary-visible').checked;


            // Read Groups
            appSettings.groups.forEach((g, idx) => {
                const nameEl = document.getElementById(`g-${idx}-name`);
                if(!nameEl) return; 

                g.name = nameEl.value;
                g.isActive = document.getElementById(`g-${idx}-active`).checked;
                g.showSummaryButton = document.getElementById(`g-${idx}-show-summary`).checked;
                g.timerColor = document.getElementById(`g-${idx}-timer-color`).value;
                g.timerIcon = document.getElementById(`g-${idx}-timer-icon`).value;
                
                g.ids = document.getElementById(`g-${idx}-ids`).value.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x));
                g.defaultMinutes = parseInt(document.getElementById(`g-${idx}-def`).value);
                g.rate = parseFloat(document.getElementById(`g-${idx}-rate`).value);
                
                g.warnYellow = parseInt(document.getElementById(`g-${idx}-warn-yellow`).value) || 5;
                g.warnRed = parseInt(document.getElementById(`g-${idx}-warn-red`).value) || 2;
                
                // Read Reset Double Click setting
                const dblClickEl = document.getElementById(`g-${idx}-reset-dblclick`);
                if(dblClickEl) g.resetDoubleClickRequired = dblClickEl.checked;
                
                // Read Reset Report Config
                const defaultRRC = DEFAULT_SETTINGS.groups[0].resetReportConfig;
                for (const key in defaultRRC) {
                    const el = document.getElementById(`g-${idx}-reset-report-${key}`);
                    if (el) g.resetReportConfig[key] = el.checked;
                }

                // READ STANDARD BUTTONS
                g.buttons = g.buttons.map((btn, bIdx) => {
                    const elLabel = document.getElementById(`g-${idx}-b-${bIdx}-label`);
                    const elVisible = document.getElementById(`g-${idx}-b-${bIdx}-visible`);
                    if(!elLabel) return btn; 

                    let savedBtn = {
                        label: elLabel.value,
                        minutes: parseInt(document.getElementById(`g-${idx}-b-${bIdx}-min`).value),
                        color: document.getElementById(`g-${idx}-b-${bIdx}-color`).value,
                        isVisible: elVisible ? elVisible.checked : true,
                        doubleClickRequired: document.getElementById(`g-${idx}-b-${bIdx}-dblclick`).checked,
                        enableOvertime: document.getElementById(`g-${idx}-b-${bIdx}-overtime`).checked
                    };
                    
                    // Read Button Report Config
                    let reportConfig = {};
                    for (const key of ALL_REPORT_KEYS) {
                        const el = document.getElementById(`g-${idx}-b-${bIdx}-report-${key}`);
                        if (el) reportConfig[key] = el.checked;
                    }
                    savedBtn.reportConfig = reportConfig;
                    
                    return savedBtn;
                }).filter(btn => btn.label && !isNaN(btn.minutes));


                // NEW: Read Fixed Extension Buttons
                g.fixedExtensionButtons = g.fixedExtensionButtons.map((btn, febIdx) => {
                    const elLabel = document.getElementById(`g-${idx}-feb-${febIdx}-label`);
                    if(!elLabel) return btn; 

                    let valStr = document.getElementById(`g-${idx}-feb-${febIdx}-duration-val`).value;
                    let val = parseInt(valStr);
                    // Safe guard for Infinity input which might be '‚àû'
                    if (isNaN(val)) val = 1;

                    let savedBtn = {
                        label: elLabel.value,
                        amount: parseInt(document.getElementById(`g-${idx}-feb-${febIdx}-amount`).value),
                        durationValue: val,
                        durationUnit: document.getElementById(`g-${idx}-feb-${febIdx}-duration-unit`).value,
                        color: document.getElementById(`g-${idx}-feb-${febIdx}-color`).value,
                        isVisible: document.getElementById(`g-${idx}-feb-${febIdx}-visible`).checked,
                        doubleClickRequired: document.getElementById(`g-${idx}-feb-${febIdx}-dblclick`).checked,
                        enableOvertime: document.getElementById(`g-${idx}-feb-${febIdx}-overtime`).checked
                    };

                    // Read Fixed Report Config
                    let fixedReportConfig = {};
                    for (const key of ALL_REPORT_KEYS) {
                        const el = document.getElementById(`g-${idx}-feb-${febIdx}-report-${key}`);
                        if (el) fixedReportConfig[key] = el.checked;
                    }
                    savedBtn.fixedReportConfig = fixedReportConfig;
                    
                    return savedBtn;
                }).filter(btn => btn.label && !isNaN(btn.amount));

                // NEW: Read Additional Service Buttons
                g.additionalServiceButtons = g.additionalServiceButtons.map((btn, asbIdx) => {
                    const elLabel = document.getElementById(`g-${idx}-asb-${asbIdx}-label`);
                    if(!elLabel) return btn;
                    
                    return {
                        label: elLabel.value,
                        amount: parseInt(document.getElementById(`g-${idx}-asb-${asbIdx}-amount`).value),
                        isVisible: document.getElementById(`g-${idx}-asb-${asbIdx}-visible`).checked
                    };
                }).filter(btn => btn.label && !isNaN(btn.amount));
            });

            localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(appSettings));
            
            // >>> –û–¢–ü–†–ê–í–ö–ê –í –û–ë–õ–ê–ö–û <<<
            if (typeof uploadToCloud === 'function') {
                uploadToCloud('config', 'app_settings', appSettings);
            }

            alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞.");
            window.location.reload();
        }

        // --- CORE FUNCTIONS (Modified for dynamic config) ---

        function toggleMotohoursVisibility() {
            if (!motohoursDetails) return;
            isMotohoursVisible = !isMotohoursVisible;
            motohoursDetails.style.display = isMotohoursVisible ? 'block' : 'none';
            toggleIcon.textContent = isMotohoursVisible ? '‚ñº' : '‚ñ≤';
        }

        function executeReset() {
            if (resetButton) { resetButton.textContent = '–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë'; resetButton.style.backgroundColor = '#4338ca'; }
            pressTimer = null; 
            if(confirm('–°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ –ú–û–¢–û–ß–ê–°–û–í?')) {
                const idsToReset = appSettings.generalControls.motohoursIds.split(',').map(Number).filter(id => !isNaN(id));
                idsToReset.forEach(id => {
                    timerStats[id] = 0;
                });
                localStorage.setItem(STORAGE_KEY_STATS, JSON.stringify(timerStats));
                updateTotalDisplay();
                playBeep();
            }
        }

        function startHold(e) {
            if (e) e.stopPropagation(); if (!resetButton) return;
            if (pressTimer) clearTimeout(pressTimer); 
            resetButton.textContent = `–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ...`;
            resetButton.style.backgroundColor = '#f59e0b'; 
            pressTimer = setTimeout(() => executeReset(), 3000);
        }

        function cancelHold(e) {
            if (e) e.stopPropagation(); 
            if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; }
            if (resetButton && resetButton.textContent !== '–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë') {
                resetButton.textContent = '–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë'; resetButton.style.backgroundColor = '#4338ca'; 
            }
        }

        function formatTotalTime(ms) {
            const totalSec = Math.floor(ms / 1000);
            return `${String(Math.floor(totalSec / 3600)).padStart(2,'0')}:${String(Math.floor((totalSec % 3600) / 60)).padStart(2,'0')}:${String(totalSec % 60).padStart(2,'0')}`;
        }
        
        function formatTimeShort(ms) {
            const totalSec = Math.floor(ms / 1000);
            return `${String(Math.floor(totalSec / 60)).padStart(2,'0')}:${String(totalSec % 60).padStart(2,'0')}`;
        }
        
        function getClockTime() {
            return new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        
        function getClockDateTime() {
            return new Date().toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function updateTotalDisplay() {
            if (!document.getElementById('total-counter-display')) return;
            
            // 1. Update Motohours Name
            if (motohoursNameDisplay) {
                motohoursNameDisplay.textContent = appSettings.generalControls.motohoursName;
            }
            
            // 2. Calculate Total Time
            let totalMotoMs = 0;
            const idsToTrack = appSettings.generalControls.motohoursIds.split(',').map(Number).filter(id => !isNaN(id));

            idsToTrack.forEach(id => {
                const val = timerStats[id] || 0;
                totalMotoMs += val;
                
                // 3. Update Dynamic Stats Grid
                const el = document.getElementById(`stat-${id}`);
                if(el) {
                    el.textContent = formatTotalTime(val);
                }
            });
            
            document.getElementById('total-counter-display').textContent = formatTotalTime(totalMotoMs);
        }

        function initAudio() { if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
        function playBeep() {
            if (!audioContext) return;
            try {
                const osc = audioContext.createOscillator(); const gain = audioContext.createGain();
                osc.connect(gain); gain.connect(audioContext.destination);
                osc.type = 'sine'; osc.frequency.setValueAtTime(440, audioContext.currentTime);
                gain.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
                osc.start(); osc.stop(audioContext.currentTime + 0.5);
            } catch(e) {}
        }

        // Updated logHistory to include session ID
        function logHistory(id, htmlContent, sessionId = null) {
            const t = timers.find(x => x.id === id);
            if (!t) return;
            // Add sessionId to history object to group log items
            t.history.unshift({ html: htmlContent, timestamp: Date.now(), sessionId: sessionId });
            if (t.history.length > 50) t.history.pop();
            saveTimerState();
        }

        // –ú–û–î–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –û–¢–ß–ï–¢–ê –° –£–ß–ï–¢–û–ú –°–ú–ï–ù–´ (–ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±—Ä–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è —Ñ–∏–∫—Å. –æ–ø–ª–∞—Ç—ã)
        function generateResetReport(t, nowTimestamp) {
            const resetTime = getClockTime();
            const checkId = getNextCheckId(); // Generate Unique ID
            
            const totalMs = t.config.MS; 
            const overtimeStart = totalMs + GRACE_PERIOD_MS;
            let overtimeStr = "00:00";
            
            const group = getGroupForId(t.id);
            const rate = group.rate;
            const config = group.resetReportConfig; // Get the report configuration

            let overtimeCost = 0;
            if (t.elapsedTime > overtimeStart && t.overtimeEnabled) {
                const extraMs = t.elapsedTime - overtimeStart;
                overtimeStr = formatTimeShort(extraMs);
                const totalExtraSeconds = Math.floor(extraMs / 1000);
                const fullMinutes = Math.floor((totalExtraSeconds % 3600) / 60);
                const remainderSeconds = totalExtraSeconds % 60;
                const chargeableMinutes = fullMinutes + (remainderSeconds > 50 ? 1 : 0);
                overtimeCost = Math.round(chargeableMinutes * rate); 
            }

            const initialMinutes = t.session.initialLimit || Math.floor(t.baseConfig.MS / 60000);
            const extensionMinutes = t.session.totalExtensions || 0;
            const initialCost = Math.round(initialMinutes * rate);
            const extensionCost = Math.round(extensionMinutes * rate);
            
            // ACCUMULATE COSTS
            const fixedAddonCost = t.session.accFixedAmount || 0; // Accumulated Fixed Costs
            
            // NEW: Additional Services Calculation
            let servicesCost = 0;
            let servicesHtml = '';
            if (t.session.additionalServices && t.session.additionalServices.length > 0) {
                 servicesHtml = t.session.additionalServices.map(s => {
                    servicesCost += s.amount;
                    return `
                        <div class="summary-row" style="color: #0d9488;">
                            <span class="summary-label">${s.label}:</span>
                            <span class="summary-val">${s.amount} —Ä—É–±.</span>
                        </div>
                    `;
                 }).join('');
            }
            
            const totalCost = initialCost + extensionCost + overtimeCost + fixedAddonCost + servicesCost;
            
            let pauseDetailsHtml = '';
            if (config.showPauseDetails) {
                 pauseDetailsHtml = t.session.pauseHistory.map((p, idx) => {
                    const duration = formatTimeShort(p.durationMs);
                    return `
                        <div class="summary-row" style="padding-left: 10px; font-size: 0.85rem;">
                            <span class="summary-label">–ü–∞—É–∑–∞ ${idx+1} (${p.start}-${p.end}):</span>
                            <span class="summary-val">${duration}</span>
                        </div>
                    `;
                 }).join('');
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —á–µ–∫ –≤ —Ç–µ–∫—É—â—É—é —Å–º–µ–Ω—É
            const shiftCheckId = addCheckToShift(t.id, '', {
                checkId: checkId,
                timerId: t.id,
                amount: totalCost,
                workerName: currentShift.workerName,
                shiftNumber: currentShift.shiftNumber
            });
            
            return `
                <div class="history-card type-summary">
                    <div class="summary-header">
                        <span>–ß–µ–∫ <span class="check-number">‚Ññ ${shiftCheckId || checkId}</span> ${currentShift.isOpen ? `(–°–º–µ–Ω–∞ ${currentShift.shiftNumber})` : ''}</span>
                        <span>${config.showResetTime ? resetTime : '---'}</span>
                        <button onclick="requestPassword(() => deleteSingleCheck(${t.id}, ${Date.now()}))" class="delete-check-btn" title="–£–¥–∞–ª–∏—Ç—å">&times;</button>
                    </div>
                    <div class="summary-body">
                        
                        ${config.showStartTime ? `<div class="summary-row"><span class="summary-label">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:</span><span class="summary-val">${t.session.startTime || '---'}</span></div>` : ''}
                        ${config.showResetTime ? `<div class="summary-row" style="margin-bottom: 5px;"><span class="summary-label">–í—Ä–µ–º—è —Å–±—Ä–æ—Å–∞:</span><span class="summary-val">${resetTime}</span></div>` : ''}
                        
                        ${config.showTotalPause ? `<div class="summary-row" style="margin-top: 5px; font-size: 1.1rem; border-top: 1px dashed #ccc; padding-top: 5px;"><span class="summary-label">–í—Å–µ–≥–æ –ø–∞—É–∑—ã:</span><span class="summary-val">${formatTimeShort(t.session.totalPauseDurationMs)}</span></div>` : ''}
                        ${pauseDetailsHtml}
                        
                        ${config.showInitialMinutes ? `<div class="summary-row" style="margin-top: 10px;"><span class="summary-label">1. –°—Ç–∞—Ä—Ç:</span><span class="summary-val">${initialMinutes} –º–∏–Ω.</span></div>` : ''}
                        ${config.showExtensionMinutes ? `<div class="summary-row"><span class="summary-label">2. –ü—Ä–æ–¥–ª–µ–Ω–∏—è:</span><span class="summary-val">+${extensionMinutes} –º–∏–Ω.</span></div>` : ''}
                        
                        ${config.showBaseCost ? `<div class="summary-row" style="margin-top:5px;"><span class="summary-label">3. –ë–∞–∑–∞:</span><span class="summary-val total-base-cost">${initialCost} —Ä—É–±.</span></div>` : ''}
                        ${config.showExtensionCost ? `<div class="summary-row"><span class="summary-label">4. –î–æ–ø:</span><span class="summary-val">${extensionCost} —Ä—É–±.</span></div>` : ''}
                        
                        ${config.showOvertimeDuration ? `<div class="summary-row red-text"><span class="summary-label">5. –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞:</span><span class="summary-val">${overtimeStr}</span></div>` : ''}
                        ${config.showOvertimeCost ? `<div class="summary-row red-text"><span class="summary-label">6. –®—Ç—Ä–∞—Ñ:</span><span class="summary-val total-doplata-cost">${overtimeCost} —Ä—É–±.</span></div>` : ''}

                        ${fixedAddonCost > 0 ? `<div class="summary-row" style="color: #4f46e5;"><span class="summary-label">7. –§–∏–∫—Å. —É—Å–ª—É–≥–∏:</span><span class="summary-val">${fixedAddonCost} —Ä—É–±.</span></div>` : ''}

                        ${servicesCost > 0 ? `<div class="summary-row" style="margin-top: 5px; border-top: 1px dotted #ccc; padding-top: 5px;"><span class="summary-label">8. –î–æ–ø. –£—Å–ª—É–≥–∏:</span></div>${servicesHtml}` : ''}

                        ${config.showTotalCost ? `<div class="summary-row total-row"><span class="summary-label">–ò–¢–û–ì–û:</span><span class="summary-val total-final-cost">${totalCost} —Ä—É–±.</span></div>` : ''}
                        
                        ${config.showRate ? `<div class="text-xs text-right text-gray-400 mt-1">–¢–∞—Ä–∏—Ñ: ${rate}/–º–∏–Ω</div>` : ''}
                        ${currentShift.isOpen ? `<div class="text-xs text-right text-gray-400 mt-1">–°–º–µ–Ω–∞: ${currentShift.shiftNumber}, –†–∞–±–æ—Ç–Ω–∏–∫: ${currentShift.workerName}</div>` : ''}
                        <div class="check-creation-date">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${new Date().toLocaleDateString('ru-RU')}</div>
                    </div>
                </div>`;
        }
        
        // –ú–û–î–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –û–¢–ß–ï–¢–ê –§–ò–ö–°–ò–†–û–í–ê–ù–ù–û–ô –û–ü–õ–ê–¢–´ –° –£–ß–ï–¢–û–ú –°–ú–ï–ù–´ (–ò–°–ü–†–ê–í–õ–ï–ù–û: —Ç–æ–ª—å–∫–æ —Ñ–∏–∫—Å. —Å—É–º–º–∞)
        function generateFixedPaymentReport(t, nowTimestamp, config) {
            const payTime = getClockTime();
            const checkId = getNextCheckId(); // Generate Unique ID
            // Fallback for old history items
            config = config || FIXED_REPORT_DEFAULTS; 
            
            // –î–æ–±–∞–≤–ª—è–µ–º —á–µ–∫ –≤ —Ç–µ–∫—É—â—É—é —Å–º–µ–Ω—É
            const shiftCheckId = addCheckToShift(t.id, '', {
                checkId: checkId,
                timerId: t.id,
                amount: t.fixedPaymentDetails.amount,
                workerName: currentShift.workerName,
                shiftNumber: currentShift.shiftNumber
            });

            return `
                <div class="history-card type-summary" style="border-left: 6px solid #10b981; background-color: #ecfdf5;">
                    <div class="summary-header" style="color: #065f46;">
                        <span>‚ôæÔ∏è –§–ò–ö–°. –û–ü–õ–ê–¢–ê <span class="check-number">‚Ññ ${shiftCheckId || checkId}</span> ${currentShift.isOpen ? `(–°–º–µ–Ω–∞ ${currentShift.shiftNumber})` : ''}</span>
                        ${config.showPaymentTime ? `<span>${payTime}</span>` : ''}
                        <button onclick="requestPassword(() => deleteSingleCheck(${t.id}, ${Date.now()}))" class="delete-check-btn" title="–£–¥–∞–ª–∏—Ç—å">&times;</button>
                    </div>
                    <div class="summary-body">
                        ${config.showLabel ? `<div class="summary-row"><span class="summary-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</span><span class="summary-val">${t.fixedPaymentDetails.label}</span></div>` : ''}
                        ${config.showAmount ? `<div class="summary-row total-row" style="border-top: none; padding-top: 0;"><span class="summary-label">–°–£–ú–ú–ê:</span><span class="summary-val total-final-cost" style="font-size:1.3rem; color:#16a34a;">${t.fixedPaymentDetails.amount} —Ä—É–±.</span></div>` : ''}
                        ${currentShift.isOpen ? `<div class="text-xs text-right text-gray-400 mt-1">–°–º–µ–Ω–∞: ${currentShift.shiftNumber}, –†–∞–±–æ—Ç–Ω–∏–∫: ${currentShift.workerName}</div>` : ''}
                        <div class="check-creation-date">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${new Date().toLocaleDateString('ru-RU')}</div>
                    </div>
                </div>`;
        }
        
        // –ú–û–î–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –£–î–ê–õ–ï–ù–ò–Ø –ß–ï–ö–ê (–° –ü–†–û–í–ï–†–ö–û–ô –ü–ê–†–û–õ–Ø –ò –£–î–ê–õ–ï–ù–ò–ï–ú –í–°–ï–• –õ–û–ì–û–í –°–ï–°–°–ò–ò)
function deleteSingleCheck(timerId, timestamp) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–µ–∫?')) return;
    
    const t = timers.find(x => x.id === timerId);
    if (t) {
        // –ò—â–µ–º —á–µ–∫ –ø–æ timestamp
        const checkIndex = t.history.findIndex(item => item.timestamp === timestamp);
        
        if (checkIndex !== -1) {
            const checkItem = t.history[checkIndex];
            
            // –£–¥–∞–ª—è–µ–º —á–µ–∫ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
            t.history.splice(checkIndex, 1);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–æ—Ä–∑–∏–Ω—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
            const deletedChecks = getDeletedChecks();
            deletedChecks.push({
                timerId: timerId,
                item: checkItem,
                deletedAt: Date.now(),
                shiftInfo: {
                    shiftNumber: currentShift.shiftNumber,
                    workerName: currentShift.workerName
                },
                sessionId: checkItem.sessionId || null
            });
            
            // –ü—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–æ–Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∞ –Ω–∏–∂–µ –≥–ª–æ–±–∞–ª—å–Ω–æ)
            saveDeletedChecks(deletedChecks); 
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ

            if (currentModalTimerId === timerId) {
                applyFilter();
            }
            
            alert("–ß–µ–∫ —É–¥–∞–ª–µ–Ω –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É");
        }
    }
}
        // –ú–û–î–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ß–ò–°–¢–ö–ò –í–°–ï–ô –ò–°–¢–û–†–ò–ò (–° –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï–ú –í –ê–†–•–ò–í)
        function clearAllHistoryWithPassword() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —á–µ—Ä–µ–∑ requestPassword
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ê–ë–°–û–õ–Æ–¢–ù–û –í–°–ï–• —Ç–∞–π–º–µ—Ä–æ–≤? –í—Å–µ —á–µ–∫–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –∞—Ä—Ö–∏–≤ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö.')) {
                const deletedChecks = getDeletedChecks();
                
                timers.forEach(t => {
                    // –°–æ–±–∏—Ä–∞–µ–º sessionId –≤—Å–µ—Ö —á–µ–∫–æ–≤
                    const checkSessionIds = new Set();
                    t.history.forEach(item => {
                        if (item.html && item.html.includes('type-summary')) {
                            checkSessionIds.add(item.sessionId);
                        }
                    });
                    
                    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å —ç—Ç–∏–º–∏ sessionId
                    t.history = t.history.filter(item => !checkSessionIds.has(item.sessionId));
                    
                    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ –∞—Ä—Ö–∏–≤
                    checkSessionIds.forEach(sessionId => {
                        const checkItem = t.history.find(item => item.sessionId === sessionId && item.html.includes('type-summary'));
                        if (checkItem) {
                            deletedChecks.push({
                                timerId: t.id,
                                item: checkItem,
                                deletedAt: Date.now(),
                                shiftInfo: {
                                    shiftNumber: currentShift.shiftNumber,
                                    workerName: currentShift.workerName
                                },
                                sessionId: sessionId
                            });
                        }
                    });
                });
                
                saveDeletedChecks(deletedChecks);
                saveTimerState();
                alert('–ì–æ—Ç–æ–≤–æ! –í—Å–µ —á–µ–∫–∏ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –∞—Ä—Ö–∏–≤ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö.');
            }
        }

        function promptAndShowSummaryReport(startId, endId, title) {
            requestPassword(() => showSummaryReport(startId, endId, title));
        }

        function showSummaryReport(startId, endId, title) {
            currentModalTimerId = null; 
            currentModalType = 'summary';
            const modal = document.getElementById('historyModal');
            document.getElementById('modalTitle').textContent = `–°–≤–æ–¥–∫–∞: ${title}`;
            document.getElementById('filterControls').style.display = 'block'; 
            document.getElementById('modalList').style.display = 'none'; 
            document.getElementById('summaryReportOutput').style.display = 'block'; 
            document.querySelector('.clear-history-btn').style.display = 'none'; 
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterStartDate').value = today;
            document.getElementById('filterEndDate').value = today;
            
            window.summaryReportRange = { startId, endId, title };
            applyFilter();
            modal.classList.add('modal-visible');
        }

        function parseCostsFromReport(html) {
            const baseMatch = html.match(/class="summary-val total-base-cost">([\d\s]+) —Ä—É–±/);
            const doplataMatch = html.match(/class="summary-val total-doplata-cost">([\d\s]+) —Ä—É–±/);
            const totalMatch = html.match(/class="summary-val total-final-cost"[\w\s-:]*?>([\d\s]+) —Ä—É–±/); 

            return { 
                baseCost: baseMatch ? parseInt(baseMatch[1].replace(/\s/g, ''), 10) : 0, 
                doplataCost: doplataMatch ? parseInt(doplataMatch[1].replace(/\s/g, ''), 10) : 0, 
                totalCost: totalMatch ? parseInt(totalMatch[1].replace(/\s/g, ''), 10) : 0 
            };
        }

        function applyFilter() {
            const startDateStr = document.getElementById('filterStartDate').value;
            const endDateStr = document.getElementById('filterEndDate').value;
            const startTimestamp = startDateStr ? new Date(startDateStr).getTime() : 0;
            const endTimestamp = endDateStr ? new Date(endDateStr).getTime() + (24 * 60 * 60 * 1000) : Infinity;

            if (currentModalType === 'history' && currentModalTimerId !== null) {
                const t = timers.find(x => x.id === currentModalTimerId);
                const list = document.getElementById('modalList');
                list.innerHTML = ''; 
                const filtered = t.history.filter(item => item.timestamp >= startTimestamp && item.timestamp < endTimestamp);
                if (filtered.length === 0) list.innerHTML = '<div class="text-center p-4 text-gray-500">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π.</div>';
                else filtered.forEach(item => list.innerHTML += item.html);
            } else if (currentModalType === 'summary' && window.summaryReportRange) {
                const { startId, endId } = window.summaryReportRange;
                let totalDoplata = 0, totalBase = 0, grandTotal = 0;

                timers.forEach(t => {
                    if (t.id >= startId && t.id <= endId) {
                        t.history.forEach(item => {
                            if (item.html && item.html.includes('type-summary') && item.timestamp >= startTimestamp && item.timestamp < endTimestamp) {
                                const costs = parseCostsFromReport(item.html);
                                totalBase += costs.baseCost; totalDoplata += costs.doplataCost; grandTotal += costs.totalCost;
                            }
                        });
                    }
                });

                document.getElementById('summaryReportOutput').innerHTML = `
                    <div class="history-card type-summary" style="border-left: 6px solid #10b981; background-color: #ecfdf5;">
                        <div class="summary-header" style="color: #065f46;">
                            <span>üí∞ –û–ë–©–ê–Ø –°–í–û–î–ö–ê</span>
                            <span class="date-time-stamp">${getClockDateTime()}</span>
                        </div>
                        <div class="summary-body">
                            <div class="summary-row"><span class="summary-label">–û–±—â–∞—è –ë–∞–∑–∞:</span><span class="summary-val">${totalBase} —Ä—É–±.</span></div>
                            <div class="summary-row"><span class="summary-label">–û–±—â–∞—è –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞:</span><span class="summary-val" style="color:#dc2626;">${totalDoplata} —Ä—É–±.</span></div>
                            <div class="summary-row total-row"><span class="summary-label">–ò–¢–û–ì–û:</span><span class="summary-val" style="font-size:1.3rem;">${grandTotal} —Ä—É–±.</span></div>
                        </div>
                    </div>`;
            }
        }

        // –ò–ó–ú–ï–ù–ï–ù–û: —É–¥–∞–ª–µ–Ω –≤—ã–∑–æ–≤ openHistoryModal –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –Ω–æ–º–µ—Ä —Ç–∞–π–º–µ—Ä–∞
        function openHistoryModal(id) {
            currentModalTimerId = id; currentModalType = 'history';
            document.getElementById('modalTitle').textContent = `–ß–µ–∫-–ª–µ–Ω—Ç–∞: –¢–∞–π–º–µ—Ä ${id}`;
            document.getElementById('filterControls').style.display = 'block'; 
            document.getElementById('modalList').style.display = 'block'; 
            document.getElementById('summaryReportOutput').style.display = 'none'; 
            document.querySelector('.clear-history-btn').style.display = 'block'; 
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterStartDate').value = today;
            document.getElementById('filterEndDate').value = today;
            
            applyFilter();
            document.getElementById('historyModal').classList.add('modal-visible');
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('modal-visible');
            currentModalTimerId = null; window.summaryReportRange = null;
        }

function clearCurrentHistory() {
    // Password checked via modal trigger
    if (currentModalTimerId === null || currentModalType !== 'history') return;
    
    if (confirm(`–û—á–∏—Å—Ç–∏—Ç—å —á–µ–∫–∏ —Ç–∞–π–º–µ—Ä–∞ ${currentModalTimerId}?`)) {
        const t = timers.find(x => x.id === currentModalTimerId);
        if (t) {
            // –°–æ–±–∏—Ä–∞–µ–º sessionId –≤—Å–µ—Ö —á–µ–∫–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
            const checkSessionIds = new Set();
            t.history.forEach(item => {
                if (item.html && item.html.includes('type-summary')) {
                    checkSessionIds.add(item.sessionId);
                }
            });
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å —ç—Ç–∏–º–∏ sessionId
            t.history = t.history.filter(item => !checkSessionIds.has(item.sessionId));
            
            // –£–¥–∞–ª—è–µ–º —á–µ–∫–∏ –∏–∑ —Ç–µ–∫—É—â–µ–π —Å–º–µ–Ω—ã
            if (currentShift.isOpen) {
                currentShift.checks = currentShift.checks.filter(check => 
                    !(check.data && check.data.sessionId && checkSessionIds.has(check.data.sessionId))
                );
                saveShiftData();
                updateShiftUI();
            }
            
            saveTimerState(); 
            applyFilter();
            alert(`–í—Å–µ —á–µ–∫–∏ —Ç–∞–π–º–µ—Ä–∞ ${currentModalTimerId} —É–¥–∞–ª–µ–Ω—ã`);
        }
    }
}
        // –ú–û–î–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –†–ê–ë–û–¢–´ –° –¢–ê–ô–ú–ï–†–ê–ú–ò –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –û–¢–ö–†–´–¢–û–ô –°–ú–ï–ù–´
        
        function startTimer(id) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ —Å–º–µ–Ω–∞
            if (!currentShift.isOpen) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–º–µ–Ω—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–π–º–µ—Ä–∞–º–∏');
                openShiftModal();
                return;
            }
            
            const t = timers.find(x => x.id === id);
            
            if (t.isFixedPayment) { 
                alert("–¢–∞–π–º–µ—Ä –≤ —Ä–µ–∂–∏–º–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ–ø–ª–∞—Ç—ã. –ù–∞–∂–º–∏—Ç–µ '‚úï' –¥–ª—è —Å–±—Ä–æ—Å–∞."); 
                return; 
            } 
            
            if (t.config.MS <= 0 && !t.isInfinity) {
                alert("–í—ã–±–µ—Ä–∏ —Ç–∞—Ä–∏—Ñ");
                return;
            }

            if (!t.isRunning) {
                initAudio();
                const now = Date.now();
                t.isRunning = true; 

                if (t.session.pauseStart) {
                    const pauseDurationMs = now - t.session.pauseStart;
                    t.session.totalPauseDurationMs += pauseDurationMs;
                    t.session.pauseHistory.push({ 
                        start: t.session.pauseStartTime, 
                        end: getClockTime(),
                        durationMs: pauseDurationMs 
                    });
                    t.session.pauseStart = null;
                    t.session.pauseStartTime = null;
                }

                t.lastStartTime = now;
                if (!t.session.startTime) {
                    t.session.startTime = getClockTime();
                    // NEW: Initialize Session ID
                    t.session.sessionId = Date.now();
                    t.session.initialLimit = Math.floor(t.baseConfig.MS / 60000); 
                    logHistory(id, `<div class="log-item type-start">‚ñ∂ –°—Ç–∞—Ä—Ç (${t.session.startTime})</div>`, t.session.sessionId);
                } else {
                    logHistory(id, `<div class="log-item type-start">‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ (${getClockTime()})</div>`, t.session.sessionId);
                }
                updateTimerUI(t); saveTimerState(); 
            }
        }

        function pauseTimer(id) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ —Å–º–µ–Ω–∞
            if (!currentShift.isOpen) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–º–µ–Ω—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–π–º–µ—Ä–∞–º–∏');
                openShiftModal();
                return;
            }
            
            const t = timers.find(x => x.id === id);
            if (t.isFixedPayment) return; 
            if (t.isRunning) {
                t.isRunning = false; 
                
                // –ê–ö–ö–£–ú–£–õ–Ø–¶–ò–Ø –í–†–ï–ú–ï–ù–ò: –£–ß–ò–¢–´–í–ê–ï–ú –í–†–ï–ú–Ø –° –ü–û–°–õ–ï–î–ù–ï–ì–û –ß–ï–ö–ü–û–ô–ù–¢–ê
                if (t.lastStartTime) {
                    t.elapsedTime += (Date.now() - t.lastStartTime);
                    t.lastStartTime = null;
                }

                t.session.pauseStart = Date.now();
                t.session.pauseStartTime = getClockTime();

                logHistory(id, `<div class="log-item type-pause">‚è∏ –ü–∞—É–∑–∞ (${t.session.pauseStartTime})</div>`, t.session.sessionId);
                updateTimerUI(t); saveTimerState(); 
            }
        }
        
        function fixedPaymentTimer(id, label, amount, reportConfig) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ —Å–º–µ–Ω–∞
            if (!currentShift.isOpen) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–º–µ–Ω—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–π–º–µ—Ä–∞–º–∏');
                openShiftModal();
                return;
            }
            
            const t = timers.find(x => x.id === id);
            if (!t) return;
            
            // Generate ID for this fixed session
            const currentSessionId = Date.now();

            if (t.isRunning || t.elapsedTime > 0 || t.session.startTime) {
                 if (t.isRunning) {
                    // –£–ß–ò–¢–´–í–ê–ï–ú –í–†–ï–ú–Ø –° –ü–û–°–õ–ï–î–ù–ï–ì–û –ß–ï–ö–ü–û–ô–ù–¢–ê –ü–ï–†–ï–î –°–ë–†–û–°–û–ú
                    t.elapsedTime += (Date.now() - t.lastStartTime);
                 }
                 t.lastStartTime = null;
                 
                 const minReportMs = (appSettings.minReportMinutes || 0) * 60 * 1000;
                 if (t.elapsedTime >= minReportMs) {
                      const reportHTML = generateResetReport(t, Date.now());
                      // Use previous session ID if exists
                      logHistory(id, reportHTML, t.session.sessionId); 
                 } else {
                     logHistory(id, `<div class="log-item type-reset-nocheck">üõë –°–µ—Å—Å–∏—è —Å–±—Ä–æ—à–µ–Ω–∞ –¥–ª—è —Ñ–∏–∫—Å. –æ–ø–ª–∞—Ç—ã (${getClockTime()})</div>`, t.session.sessionId);
                 }
            }

            t.isRunning = false; 
            t.elapsedTime = 0; 
            t.lastStartTime = null; 
            const group = getGroupForId(id);
            const baseMinutes = group.defaultMinutes;
            const baseMs = baseMinutes * 60 * 1000;
            t.config = { MS: baseMs }; 
            t.alarmsTriggered = { yellow: false, red: false, overtime: false };
            t.overtimeEnabled = true; // Reset overtime flag
            
            t.session = { 
                startTime: null, initialLimit: 0, totalExtensions: 0,
                pauseStart: null, pauseStartTime: null, pauseHistory: [], totalPauseDurationMs: 0,
                accFixedAmount: 0, 
                additionalServices: [],
                sessionId: currentSessionId // Set for this fixed record
            };

            t.isFixedPayment = true;
            t.fixedPaymentDetails = { label, amount: parseInt(amount) };
            // Clear fixedExtensionDetails after reset
            t.fixedExtensionDetails = { label: null, amount: 0, durationValue: 0, durationUnit: 'minute' };


            const reportHTML = generateFixedPaymentReport(t, Date.now(), reportConfig);
            logHistory(id, reportHTML, currentSessionId);

            updateTimerUI(t); 
            saveTimerState(); 
            playBeep();
        }
        
        // NEW: Fixed Rate Extend Timer function (UPDATED FOR CLEAN LOG)
        function fixedRateExtendTimer(id, label, amount, durationValue, durationUnit, reportConfig, enableOvertime) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ —Å–º–µ–Ω–∞
            if (!currentShift.isOpen) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–º–µ–Ω—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–π–º–µ—Ä–∞–º–∏');
                openShiftModal();
                return;
            }
            
            const t = timers.find(x => x.id === id);
            // Must be running or paused (cannot be in fixed payment mode)
            if (!t || t.isFixedPayment) {
                 alert("–û—à–∏–±–∫–∞: –¢–∞–π–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –Ω–∞ –ø–∞—É–∑–µ –¥–ª—è —Ñ–∏–∫—Å. –ø—Ä–æ–¥–ª–µ–Ω–∏—è.");
                 return;
            } 
            
            // Update Overtime Flag based on Button Config
            // If button explicitly sets enableOvertime (true/false), use it. Default is true.
            t.overtimeEnabled = (enableOvertime !== undefined) ? enableOvertime : true;

            // 1. Calculate duration in milliseconds and total minutes
            let minutes;
            if (durationUnit === 'infinity') {
                minutes = 0;
                t.isInfinity = true; // Set Infinity flag
            } else if (durationUnit === 'hour') {
                minutes = durationValue * 60;
                t.isInfinity = false;
            } else {
                minutes = durationValue;
                t.isInfinity = false;
            }

            const durationMs = minutes * 60000;
            
            // 2. Extend the timer
            if (!t.isInfinity) {
                t.config.MS += durationMs;
                // FIX: Do NOT increase totalExtensions for Fixed Rate payment to avoid double charging
                // t.session.totalExtensions += minutes; 
            }
            
            // Reset alarms since limits changed
            t.alarmsTriggered = { yellow: false, red: false, overtime: false };

            // 3. Log history entry (ONLY IF STARTED)
            let logMsg = '';
            if (durationUnit === 'infinity') {
                 logMsg = `(–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ)`;
            } else {
                 logMsg = `+${minutes} –º–∏–Ω.`;
            }
            
            // Accumulate cost for the final check
            t.session.accFixedAmount = (t.session.accFixedAmount || 0) + parseInt(amount);

            // LOGGING CONDITION: ONLY IF STARTED
            if (t.session.startTime) {
                logHistory(id, `<div class="log-item type-ext" style="color: #4f46e5;">${logMsg} (–§–∏–∫—Å. ${amount}—Ä) [–í —Å—á–µ—Ç] (${getClockTime()})</div>`, t.session.sessionId);
            }
            
            updateTimerUI(t); 
            saveTimerState(); 
            playBeep();
        }

        // NEW: Function to Add Additional Service (Does not affect time/rate) (UPDATED FOR CLEAN LOG)
        function addAdditionalService(id, label, amount, btnElement) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ —Å–º–µ–Ω–∞
            if (!currentShift.isOpen) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–º–µ–Ω—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–π–º–µ—Ä–∞–º–∏');
                openShiftModal();
                return;
            }
            
            const t = timers.find(x => x.id === id);
            // Must be running or paused (cannot be in fixed payment mode)
            if (!t || t.isFixedPayment) {
                 alert("–û—à–∏–±–∫–∞: –¢–∞–π–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –Ω–∞ –ø–∞—É–∑–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∏.");
                 return;
            }

            if (!t.session.additionalServices) t.session.additionalServices = [];
            
            t.session.additionalServices.push({ label: label, amount: parseInt(amount) });
            
            // NEW: Visual Feedback (Yellow Button)
            if (btnElement) {
                btnElement.classList.add('service-active');
            }

            // LOGGING CONDITION: ONLY IF STARTED
            if (t.session.startTime) {
                logHistory(id, `<div class="log-item type-service">+ –£—Å–ª—É–≥–∞: ${label} (${amount}—Ä) (${getClockTime()})</div>`, t.session.sessionId);
            }
            
            saveTimerState();
            playBeep();
        }


        function resetTimer(id) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ —Å–º–µ–Ω–∞
            if (!currentShift.isOpen) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–º–µ–Ω—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–π–º–µ—Ä–∞–º–∏');
                openShiftModal();
                return;
            }
            
            const t = timers.find(x => x.id === id);
            if (!t) return;
            
            // Clear Visual Feedback on Service Buttons for this timer
            // We use the timer-row to scope the search
            if (t.elements && t.elements.row) {
                const activeServiceBtns = t.elements.row.querySelectorAll('.service-active');
                activeServiceBtns.forEach(btn => btn.classList.remove('service-active'));
            }

            t.elements.row.classList.add('flash-reset');
            setTimeout(() => { t.elements.row.classList.remove('flash-reset'); updateTimerUI(t); }, 200);

            if (t.isFixedPayment) {
                 // For fixed payment mode, just log reset
                 logHistory(id, `<div class="log-item type-reset-nocheck">üõë –°–±—Ä–æ—Å —Ñ–∏–∫—Å. –æ–ø–ª–∞—Ç—ã (${getClockTime()})</div>`, t.session.sessionId);
                 t.isFixedPayment = false; 
                 t.fixedPaymentDetails = { label: null, amount: 0 };
            } else {
                if (t.isRunning && t.lastStartTime) {
                    // Update elapsed time before resetting
                    t.elapsedTime += (Date.now() - t.lastStartTime);
                    t.lastStartTime = null;
                }

                if (t.session.pauseStart) {
                    const pauseDurationMs = Date.now() - t.session.pauseStart;
                    t.session.totalPauseDurationMs += pauseDurationMs;
                    t.session.pauseHistory.push({ 
                        start: t.session.pauseStartTime, 
                        end: getClockTime(),
                        durationMs: pauseDurationMs 
                    });
                    t.session.pauseStart = null;
                    t.session.pauseStartTime = null;
                }

                // --- NEW LOGIC FOR RECEIPT GENERATION (STRICT) ---
                const minReportMs = (appSettings.minReportMinutes || 0) * 60 * 1000;
                
                // 1. MUST have started (session start time exists)
                const wasStarted = t.session.startTime !== null;
                // 2. MUST meet minimum time requirement (ignore services presence for check triggering)
                const timeMet = t.elapsedTime >= minReportMs;

                // STRICT CHECK: Only generate if Started AND Time Met.
                if (wasStarted && timeMet) {
                    try {
                        const reportHTML = generateResetReport(t, Date.now());
                        logHistory(id, reportHTML, t.session.sessionId);
                    } catch(err) { console.error(err); }
                } else {
                    logHistory(id, `<div class="log-item type-reset-nocheck">üõë –°–±—Ä–æ—Å –±–µ–∑ —á–µ–∫–∞ (–≤—Ä–µ–º—è –Ω–µ –≤—ã—à–ª–æ –∏–ª–∏ –Ω–µ—Ç —Å—Ç–∞—Ä—Ç–∞) (${getClockTime()})</div>`, t.session.sessionId);
                }
            }
            
            // Final reset of timer object state (common for timed and fixed)
            const group = getGroupForId(id);
            const baseMinutes = group.defaultMinutes;
            const baseMs = baseMinutes * 60 * 1000;
            
            t.config = { MS: baseMs }; 
            t.baseConfig.MS = baseMs;
            t.baseConfig.MINUTES = baseMinutes;

            t.isRunning = false; t.elapsedTime = 0; t.lastStartTime = null; 
            t.alarmsTriggered = { yellow: false, red: false, overtime: false }; t.isStatusOpen = false;
            t.isInfinity = false; // RESET Infinity Status
            t.overtimeEnabled = true; // RESET Overtime flag to default
            
            t.session = { 
                startTime: null, initialLimit: 0, totalExtensions: 0,
                pauseStart: null, pauseStartTime: null, pauseHistory: [], totalPauseDurationMs: 0,
                accFixedAmount: 0, // Reset accumulated cost
                additionalServices: [], // Reset services
                sessionId: null // Reset session ID
            };
            t.fixedExtensionDetails = { label: null, amount: 0, durationValue: 0, durationUnit: 'minute' }; // NEW: Reset fixed extension details
            
            t.elements.display.textContent = formatTimeShort(t.config.MS); 
            updateTimerUI(t); saveTimerState(); playBeep(); 
        }

        // Updated for Standard Extension with Overtime and Report Config
        function extendTimer(id, mins, enableOvertime, reportConfig) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ —Å–º–µ–Ω–∞
            if (!currentShift.isOpen) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–º–µ–Ω—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–π–º–µ—Ä–∞–º–∏');
                openShiftModal();
                return;
            }
            
            const t = timers.find(x => x.id === id);
            if (t.isFixedPayment) return; 
            
            // Set Overtime Status if defined
            if (enableOvertime !== undefined) {
                t.overtimeEnabled = enableOvertime;
            }

            t.config.MS += mins * 60000;
            t.session.totalExtensions += mins;
            t.alarmsTriggered = { yellow: false, red: false, overtime: false };
            
            // LOGGING CONDITION: ONLY IF STARTED
            if (t.session.startTime) {
                logHistory(id, `<div class="log-item type-ext">+${mins} –º–∏–Ω. –ø—Ä–æ–¥–ª–µ–Ω–∏–µ (${getClockTime()})</div>`, t.session.sessionId);
            }
            updateTimerUI(t); saveTimerState(); playBeep();
        }
        
        function toggleStatus(id) {
            const t = timers.find(x => x.id === id);
            t.isStatusOpen = !t.isStatusOpen;
            updateTimerUI(t); saveTimerState(); 
        }

        function updateTimerUI(timer) {
            const { elapsedTime, isRunning, config, elements, isFixedPayment, isInfinity, overtimeEnabled } = timer;
            const totalMs = config.MS;
            
            if (isFixedPayment) {
                 elements.display.textContent = '‚àû';
                 elements.display.style.fontSize = '5.5rem';
                 elements.display.className = 'time-display text-6xl font-extrabold state-running';
                 elements.display.classList.add('state-running');
                 elements.row.className = 'timer-row flex flex-col items-start flex-shrink-0';
                 elements.statusWrapper.style.display = 'none';
                 return;
            }
            
            elements.display.style.fontSize = ''; 
            
            const remain = totalMs - elapsedTime;
            elements.display.textContent = (remain > 0) ? formatTimeShort(remain) : `+${formatTimeShort(Math.abs(remain))}`;
            
            // --- NEW: INFINITY DISPLAY LOGIC ---
            if (isInfinity) {
                elements.display.textContent = '‚àû';
            }
            
            if (!elements.row.classList.contains('flash-reset')) {
                elements.row.className = 'timer-row flex flex-col items-start flex-shrink-0';
                
                // Priority for Infinity Blink
                if (isInfinity && isRunning) {
                     elements.row.classList.add('blink-green-active');
                } else {
                    if (overtimeEnabled && (timer.alarmsTriggered.overtime || timer.alarmsTriggered.red)) elements.row.classList.add('alarm-row-pulse-overtime');
                    else if (timer.alarmsTriggered.yellow) elements.row.classList.add('alarm-row-pulse');
                }
            }

            elements.display.className = 'time-display text-6xl font-extrabold';
            
            // Check for 0 time state
            if (totalMs <= 0 && elapsedTime === 0 && !isInfinity) {
                 elements.display.classList.add('state-zero');
                 elements.display.textContent = '00:00';
            } else if (overtimeEnabled && (timer.alarmsTriggered.overtime || timer.alarmsTriggered.red)) {
                elements.display.classList.add('state-overtime-red');
            } else if (timer.alarmsTriggered.yellow) {
                elements.display.classList.add('state-alarm');
            } else {
                if (isRunning) elements.display.classList.add('state-running');
                else elements.display.classList.add('state-paused');
            }
            
            if (!isRunning) elements.row.classList.remove('alarm-row-pulse', 'alarm-row-pulse-overtime', 'blink-green-active');
            updateStatusPanel(timer);
        }

        function updateStatusPanel(timer) {
            const { elapsedTime, config, elements, isStatusOpen, isFixedPayment, overtimeEnabled } = timer;
            if (!isStatusOpen || isFixedPayment) { elements.statusWrapper.style.display = 'none'; return; }
            elements.statusWrapper.style.display = 'block';
            const totalMs = config.MS;
            const overtimeStart = totalMs + GRACE_PERIOD_MS;
            const group = getGroupForId(timer.id);
            const rate = group.rate;
            let html = '', cssClass = '';

            if (elapsedTime >= overtimeStart && overtimeEnabled) {
                const extraMs = elapsedTime - overtimeStart;
                const totalExtraSeconds = Math.floor(extraMs / 1000);
                const fullMinutes = Math.floor((totalExtraSeconds % 3600) / 60);
                const remainderSeconds = totalExtraSeconds % 60;
                const chargeableMinutes = fullMinutes + (remainderSeconds > 50 ? 1 : 0);
                const extraCost = Math.round(chargeableMinutes * rate); 
                cssClass = 'status-info-red';
                html = `
                    <div class="text-xl font-extrabold text-red-700">–ü–ï–†–ï–†–ê–°–•–û–î: +${formatTimeShort(extraMs)}</div>
                    <div class="text-xl font-extrabold text-red-700">–î–û–ü–õ–ê–¢–ê: ${extraCost} —Ä—É–±.</div>
                    <div class="text-xs text-gray-500 mt-1">–õ–∏–º–∏—Ç: ${Math.floor(totalMs/60000)} –º–∏–Ω. –¢–∞—Ä–∏—Ñ: ${rate} —Ä/–º–∏–Ω</div>`;
            } else {
                const remain = Math.max(0, overtimeStart - elapsedTime);
                cssClass = 'status-info-orange';
                html = `<div class="font-bold text-gray-700">–õ–∏–º–∏—Ç: ${Math.floor(totalMs/60000)} –º–∏–Ω</div>
                    <div class="text-xl font-extrabold text-green-700">–û—Å—Ç–∞–ª–æ—Å—å: ${formatTimeShort(remain)}</div>`;
            }
            elements.statusDetails.className = `status-details ${cssClass}`;
            elements.statusDetails.innerHTML = html;
        }

        function saveTimerState(isUnloading = false) {
            if(timers.length === 0) return;
            const now = Date.now();
            
            // 1. –û–±–Ω–æ–≤–ª—è–µ–º –¢–û–õ–¨–ö–û —á–µ–∫–ø–æ–∏–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏. 
            // –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º elapsedTime –∑–¥–µ—Å—å, —Ç–∞–∫ –∫–∞–∫ loop() —ç—Ç–æ —É–∂–µ –¥–µ–ª–∞–µ—Ç.
            timers.forEach(t => {
                if (t.isRunning) {
                    t.lastStartTime = now;
                }
            });

            // 2. –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ç–∞–π–º–µ—Ä–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const state = timers.map(t => ({
                id: t.id,
                title: t.title,
                price: t.price,
                startTime: t.startTime,
                elapsedTime: t.elapsedTime,
                isRunning: t.isRunning,
                lastStartTime: t.lastStartTime,
                session: t.session,
                isFixed: t.isFixed || false,
                isInfinity: t.isInfinity || false,
                overtimeEnabled: t.overtimeEnabled,
                history: t.history,
                config: t.config,
                baseConfig: t.baseConfig,
                alarmsTriggered: t.alarmsTriggered,
                isStatusOpen: t.isStatusOpen,
                fixedPaymentDetails: t.fixedPaymentDetails,
                fixedExtensionDetails: t.fixedExtensionDetails
            }));

            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            localStorage.setItem(TIMER_STATE_STORAGE_KEY, JSON.stringify(state));
            localStorage.setItem(STORAGE_KEY_STATS, JSON.stringify(timerStats));

            // 4. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –æ–±–ª–∞–∫–æ
            if (typeof uploadToCloud === 'function') {
                uploadToCloud('timer_data', 'live_state', { timers: state });
                uploadToCloud('timer_data', 'stats', { statistics: timerStats });
            }
        }



        function createTimer(i) {
            const group = getGroupForId(i);
            if (!group.isActive) return; // Don't create timer if group is inactive
            
            const isPauseVisible = appSettings.generalControls.pauseButtonVisible;
            
            let extendBtnsHtml = '';
            group.buttons.filter(btn => btn.isVisible !== false).forEach((btn, bIdx) => { 
                // NEW: Logic for Standard Buttons
                const key = `'ext-${bIdx}'`;
                const isDbl = btn.doubleClickRequired;
                const enableOvertime = btn.enableOvertime !== false;
                // Currently reportConfig is just passed, can be used later for detailed extension logs
                const reportConfigStr = JSON.stringify(btn.reportConfig || {}).replace(/"/g, "'"); 

                const handler = `handleDoubleTap(${i}, ${key}, () => extendTimer(${i}, ${btn.minutes}, ${enableOvertime}, ${reportConfigStr}), ${isDbl}, this)`;
                
                extendBtnsHtml += `<button onclick="${handler}" class="timer-button flex-1 btn-color-${btn.color}" title="–î–æ–±–∞–≤–∏—Ç—å ${btn.minutes} –º–∏–Ω">${btn.label}</button>`;
            });
            
            
            // NEW: Fixed Extension Buttons Rendering (Updated for Infinity)
            let fixedExtensionBtnsHtml = '';
            group.fixedExtensionButtons.filter(btn => btn.isVisible !== false).forEach((btn, febIdx) => { 
                const fixedExtKey = `'fixed-ext-${febIdx}'`;
                const isFixedExtDblClickRequired = btn.doubleClickRequired;
                const enableOvertime = btn.enableOvertime !== false; // Default true
                const reportConfigStr = JSON.stringify(btn.fixedReportConfig).replace(/"/g, "'"); 
                
                const handler = `handleDoubleTap(${i}, ${fixedExtKey}, () => fixedRateExtendTimer(${i}, '${btn.label.replace(/'/g, "\\'")}', ${btn.amount}, ${btn.durationValue}, '${btn.durationUnit}', ${reportConfigStr}, ${enableOvertime}), ${isFixedExtDblClickRequired}, this)`;
                
                fixedExtensionBtnsHtml += `<button 
                                            onclick="${handler}" 
                                            class="timer-button flex-1 btn-color-${btn.color} fixed-ext-${febIdx}-btn" 
                                            title="–§–∏–∫—Å. –ü—Ä–æ–¥–ª–µ–Ω–∏–µ: ${btn.label}">
                                            ${btn.label}
                                        </button>`;
            });

            // NEW: Additional Service Buttons Rendering
            let additionalServicesHtml = '';
            group.additionalServiceButtons.filter(btn => btn.isVisible !== false).forEach((btn) => {
                 additionalServicesHtml += `<button onclick="addAdditionalService(${i}, '${btn.label.replace(/'/g, "\\'")}', ${btn.amount}, this)" class="timer-button flex-1 btn-color-teal" title="–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É: ${btn.label}">+ ${btn.label}</button>`;
            });

            // Conditional Pause button rendering
            const pauseButtonHtml = isPauseVisible 
                ? `<button onclick="pauseTimer(${i})" class="timer-button control-btn btn-pause flex-1">${ICON_PAUSE}</button>`
                : '';
            
            // NEW: Reset Button with Double Click Logic
            const isResetDblClickRequired = group.resetDoubleClickRequired;
            const resetHandler = `handleDoubleTap(${i}, 'reset', () => resetTimer(${i}), ${isResetDblClickRequired}, this)`;
            
            // Adjust button row to handle missing pause button
            const controlButtons = [
                `<button onclick="startTimer(${i})" class="timer-button control-btn btn-play flex-1">${ICON_PLAY}</button>`,
                pauseButtonHtml,
                extendBtnsHtml,
                `<button onclick="${resetHandler}" class="timer-button control-btn btn-reset flex-1 reset-btn" title="–°–±—Ä–æ—Å">${ICON_RESET}</button>`
            ].filter(Boolean).join('');

            const baseMinutes = group.defaultMinutes;
            const baseMs = baseMinutes * 60 * 1000;
            
            const warnYellowOffset = group.warnYellow || 5;
            const warnRedOffset = group.warnRed || 2;
            
            const warnYellow = Math.max(1, baseMinutes - warnYellowOffset);
            const warnRed = Math.max(1, baseMinutes - warnRedOffset);

            const row = document.createElement('div');
            row.className = 'timer-row flex flex-col items-start flex-shrink-0';
            row.setAttribute('data-id', i); // Added data-id for easier element selection
            
            // Determine what to display in timer-id-display
            const timerDisplay = group.timerIcon || i;
            const isIcon = group.timerIcon && group.timerIcon.trim() !== '';
            
            // –ò–ó–ú–ï–ù–ï–ù–û: —É–±—Ä–∞–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –Ω–æ–º–µ—Ä —Ç–∞–π–º–µ—Ä–∞
            row.innerHTML = `
                <div class="flex items-center justify-between w-full mb-2">
                    <div class="timer-id-display" style="background-color: ${group.timerColor}; ${isIcon ? 'font-size: 2.5rem;' : ''}">
                        ${timerDisplay}
                    </div>
                    <div id="display-${i}" class="time-display" onclick="openHistoryModal(${i})" title="–û—Ç–∫—Ä—ã—Ç—å —á–µ–∫">00:00</div>
                </div>
                <div class="flex items-center space-x-1 sm:space-x-2 w-full mt-2">
                    ${controlButtons}
                </div>
                ${fixedExtensionBtnsHtml ? `<div class="flex items-center space-x-1 sm:space-x-2 w-full mt-2">${fixedExtensionBtnsHtml}</div>` : ''}
                ${additionalServicesHtml ? `<div class="flex items-center space-x-1 sm:space-x-2 w-full mt-2">${additionalServicesHtml}</div>` : ''}
                
                <div id="status-wrapper-${i}" class="status-wrapper" style="display:none;">
                    <div id="status-details-${i}" class="status-details"></div>
                </div>
            `;
            container.appendChild(row);
            
            const newTimer = {
                id: i, elapsedTime: 0, isRunning: false, lastStartTime: null, isStatusOpen: false,
                history: [], 
                session: { 
                    startTime: null, initialLimit: 0, totalExtensions: 0,
                    pauseStart: null, pauseStartTime: null, pauseHistory: [], totalPauseDurationMs: 0,
                    accFixedAmount: 0, // New field for accumulating fixed costs
                    additionalServices: [], // New field for services
                    sessionId: null // New session ID
                },
                config: { MS: baseMs }, 
                baseConfig: { MS: baseMs, MINUTES: baseMinutes, WARN_YELLOW: warnYellow, WARN_RED: warnRed }, 
                alarmsTriggered: { yellow: false, red: false, overtime: false },
                isFixedPayment: false,
                isInfinity: false, // NEW: Infinity State
                overtimeEnabled: true, // Default to true
                fixedPaymentDetails: { label: null, amount: 0 }, 
                fixedExtensionDetails: { label: null, amount: 0, durationValue: 0, durationUnit: 'minute' }, // NEW: Fixed Extension Details
                elements: {
                    row: row, display: document.getElementById(`display-${i}`),
                    statusWrapper: document.getElementById(`status-wrapper-${i}`), statusDetails: document.getElementById(`status-details-${i}`)
                }
            };
            timers.push(newTimer);
        }

        function renderGroupSummaryButtons() {
            const container = document.getElementById('groupSummaryControls');
            container.innerHTML = '';
            
            let hasVisibleGroups = false;
            
            appSettings.groups.forEach((g, idx) => {
                if (g.isActive && g.showSummaryButton && g.ids.length > 0) {
                    hasVisibleGroups = true;
                    const minId = Math.min(...g.ids);
                    const maxId = Math.max(...g.ids);
                    
                    const button = document.createElement('button');
                    button.className = 'group-summary-btn';
                    button.innerHTML = `üìä –°–≤–æ–¥–∫–∞ ${g.name}`;
                    button.onclick = () => {
                        promptAndShowSummaryReport(minId, maxId, `–°–≤–æ–¥–∫–∞ ${g.name}`);
                    };
                    container.appendChild(button);
                }
            });
            
            container.style.display = hasVisibleGroups ? 'grid' : 'none';
        }

        function loop() {
            const now = Date.now();
            const dt = now - lastUpdateTime;
            lastUpdateTime = now;
            const motoIds = appSettings.generalControls.motohoursIds.split(',').map(Number).filter(id => !isNaN(id));

            timers.forEach(t => {
                if (t.isRunning) {
                    t.elapsedTime += dt; // <-- –û–°–ù–û–í–ù–û–ï –ü–†–ò–ë–ê–í–õ–ï–ù–ò–ï –í–†–ï–ú–ï–ù–ò –î–õ–Ø –ü–õ–ê–í–ù–û–ô –ê–ù–ò–ú–ê–¶–ò–ò
                    
                    const ot = t.config.MS + GRACE_PERIOD_MS;
                    const redMs = t.config.MS - (t.baseConfig.WARN_RED * 60000);
                    const yelMs = t.config.MS - (t.baseConfig.WARN_YELLOW * 60000);

                    // Skip alarms if infinity OR if Overtime is Disabled
                    if (!t.isInfinity) {
                        if (t.overtimeEnabled) {
                            if (t.elapsedTime >= ot && !t.alarmsTriggered.overtime) { playBeep(); t.alarmsTriggered.overtime = true; } 
                            else if (t.elapsedTime >= redMs && !t.alarmsTriggered.red) { playBeep(); t.alarmsTriggered.red = true; t.alarmsTriggered.yellow = true; } 
                            else if (t.elapsedTime >= yelMs && !t.alarmsTriggered.yellow) { playBeep(); t.alarmsTriggered.yellow = true; }
                        }
                    }
                }
                updateTimerUI(t);
            });
            updateTotalDisplay();
            // Save state every 1 second
            if (now - lastSaveTime > 1000) { saveTimerState(); lastSaveTime = now; }
            requestAnimationFrame(loop);
        }

        // --- NEW: REPORT GENERATION FUNCTIONS (—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –Ω–æ–º–µ—Ä—É —Å–º–µ–Ω—ã –∏ –∏–º–µ–Ω–∏) ---
        function generateReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const shiftNumber = document.getElementById('reportShiftNumber').value.trim();
            const workerName = document.getElementById('reportWorkerName').value.trim();
            const groupIndex = document.getElementById('reportGroupSelect').value;
            
            if (!startDate || !endDate) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥");
                return;
            }
            
            const startTimestamp = new Date(startDate).getTime();
            const endTimestamp = new Date(endDate).getTime() + (24 * 60 * 60 * 1000);
            
            let totalBase = 0;
            let totalDoplata = 0;
            let grandTotal = 0;
            let checks = [];
            
            // Collect all checks
            timers.forEach(t => {
                // Check if timer belongs to selected group
                if (groupIndex !== 'all') {
                    const group = appSettings.groups[parseInt(groupIndex)];
                    if (!group.ids.includes(t.id)) {
                        return;
                    }
                }
                
                t.history.forEach(item => {
                    if (item.html && item.html.includes('type-summary') && 
                        item.timestamp >= startTimestamp && item.timestamp < endTimestamp) {
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –Ω–æ–º–µ—Ä—É —Å–º–µ–Ω—ã –∏ –∏–º–µ–Ω–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
                        const shiftNumberMatch = item.html.match(/–°–º–µ–Ω–∞ (\d+)/);
                        const workerMatch = item.html.match(/–†–∞–±–æ—Ç–Ω–∏–∫: ([^<]+)/);
                        
                        const itemShiftNumber = shiftNumberMatch ? shiftNumberMatch[1] : null;
                        const itemWorkerName = workerMatch ? workerMatch[1].trim() : null;
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                        const matchesShift = !shiftNumber || itemShiftNumber === shiftNumber;
                        const matchesWorker = !workerName || (itemWorkerName && itemWorkerName.toLowerCase().includes(workerName.toLowerCase()));
                        
                        if (matchesShift && matchesWorker) {
                            const costs = parseCostsFromReport(item.html);
                            totalBase += costs.baseCost; 
                            totalDoplata += costs.doplataCost; 
                            grandTotal += costs.totalCost;
                            
                            checks.push({
                                timerId: t.id,
                                timestamp: item.timestamp,
                                html: item.html,
                                costs: costs,
                                shiftNumber: itemShiftNumber,
                                workerName: itemWorkerName
                            });
                        }
                    }
                });
            });
            
            // Sort checks by timestamp
            checks.sort((a, b) => b.timestamp - a.timestamp);
            
            // Generate report HTML
            let reportHtml = `
                <div class="history-card type-summary" style="border-left: 6px solid #10b981; background-color: #ecfdf5; margin-bottom: 1rem;">
                    <div class="summary-header" style="color: #065f46;">
                        <span>üìã –û–¢–ß–ï–¢ –ó–ê –ü–ï–†–ò–û–î</span>
                        <span>${new Date(startTimestamp).toLocaleDateString()} - ${new Date(endTimestamp - 24*60*60*1000).toLocaleDateString()}</span>
                    </div>
                    <div class="summary-body">
                        ${shiftNumber ? `<div class="summary-row"><span class="summary-label">–ù–æ–º–µ—Ä —Å–º–µ–Ω—ã:</span><span class="summary-val">${shiftNumber}</span></div>` : ''}
                        ${workerName ? `<div class="summary-row"><span class="summary-label">–†–∞–±–æ—Ç–Ω–∏–∫:</span><span class="summary-val">${workerName}</span></div>` : ''}
                        <div class="summary-row"><span class="summary-label">–û–±—â–∞—è –ë–∞–∑–∞:</span><span class="summary-val">${totalBase} —Ä—É–±.</span></div>
                        <div class="summary-row"><span class="summary-label">–û–±—â–∞—è –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞:</span><span class="summary-val" style="color:#dc2626;">${totalDoplata} —Ä—É–±.</span></div>
                        <div class="summary-row total-row"><span class="summary-label">–ò–¢–û–ì–û:</span><span class="summary-val" style="font-size:1.3rem;">${grandTotal} —Ä—É–±.</span></div>
                        <div class="summary-row"><span class="summary-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–∫–æ–≤:</span><span class="summary-val">${checks.length}</span></div>
                    </div>
                </div>`;
            
            // Add individual checks
            checks.forEach(check => {
                const date = new Date(check.timestamp).toLocaleString('ru-RU');
                reportHtml += `
                    <div class="history-card" style="margin-bottom: 0.5rem;">
                        <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem;">
                            –¢–∞–π–º–µ—Ä ${check.timerId} ‚Ä¢ ${date}
                            ${check.shiftNumber ? `‚Ä¢ –°–º–µ–Ω–∞ ${check.shiftNumber}` : ''}
                            ${check.workerName ? `‚Ä¢ ${check.workerName}` : ''}
                        </div>
                        ${check.html}
                    </div>`;
            });
            
            document.getElementById('reportContent').innerHTML = reportHtml;
        }
        
        function exportReportToText() {
            const reportContent = document.getElementById('reportContent').innerText;
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `–æ—Ç—á–µ—Ç_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // --- NEW: DELETED CHECKS FUNCTIONS (–ò–°–ü–†–ê–í–õ–ï–ù–û: —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ –æ–¥–Ω–æ–º—É –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö) ---
        function getDeletedChecks() {
            const stored = localStorage.getItem(STORAGE_KEY_DELETED_CHECKS);
            return stored ? JSON.parse(stored) : [];
        }
        
        function saveDeletedChecks(checks) {
            localStorage.setItem(STORAGE_KEY_DELETED_CHECKS, JSON.stringify(checks));
            // >>> –û–¢–ü–†–ê–í–ö–ê –í –û–ë–õ–ê–ö–û <<<
            if (typeof uploadToCloud === 'function') {
                uploadToCloud('archive', 'deleted_checks', { list: checks });
            }
        }
        
        // –ú–û–î–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –£–î–ê–õ–ï–ù–ù–´–• –ß–ï–ö–û–í –° –§–ò–õ–¨–¢–†–ê–¶–ò–ï–ô –ü–û –¢–ê–ô–ú–ï–†–ê–ú
        function loadDeletedChecks() {
            const startDate = document.getElementById('restoreStartDate').value;
            const endDate = document.getElementById('restoreEndDate').value;
            
            if (!startDate || !endDate) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥");
                return;
            }
            
            const startTimestamp = new Date(startDate).getTime();
            const endTimestamp = new Date(endDate).getTime() + (24 * 60 * 60 * 1000);
            
            const deletedChecks = getDeletedChecks();
            const filteredChecks = deletedChecks.filter(check => 
                check.deletedAt >= startTimestamp && check.deletedAt < endTimestamp
            );
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–∞–π–º–µ—Ä–∞–º
            const checksByTimer = {};
            filteredChecks.forEach((check, index) => {
                if (!checksByTimer[check.timerId]) {
                    checksByTimer[check.timerId] = [];
                }
                checksByTimer[check.timerId].push({...check, originalIndex: index});
            });
            
            let html = '';
            
            if (Object.keys(checksByTimer).length === 0) {
                html = '<div style="text-align: center; color: #6b7280; padding: 2rem;">–ù–µ—Ç —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —á–µ–∫–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
            } else {
                // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ç–∞–π–º–µ—Ä–∞–º
                html += '<div class="shift-timer-filter">';
                html += '<button class="shift-timer-btn active" onclick="filterDeletedChecksByTimer(null)">–í—Å–µ</button>';
                
                Object.keys(checksByTimer).forEach(timerId => {
                    html += `<button class="shift-timer-btn" onclick="filterDeletedChecksByTimer(${timerId})">–¢–∞–π–º–µ—Ä ${timerId}</button>`;
                });
                
                html += '</div>';
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ —á–µ–∫–∏ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞
                html += '<div id="allDeletedChecks">';
                filteredChecks.forEach((check, index) => {
                    const date = new Date(check.deletedAt).toLocaleString('ru-RU');
                    html += `
                        <div class="restore-check-item deleted-check" id="deleted-check-${index}" data-timer-id="${check.timerId}">
                            <div class="restore-check-info">
                                <div><strong>–¢–∞–π–º–µ—Ä ${check.timerId}</strong></div>
                                <div style="font-size: 0.8rem; color: #6b7280;">–£–¥–∞–ª–µ–Ω: ${date}</div>
                                ${check.shiftInfo ? `<div style="font-size: 0.8rem; color: #6b7280;">–°–º–µ–Ω–∞: ${check.shiftInfo.shiftNumber}, –†–∞–±–æ—Ç–Ω–∏–∫: ${check.shiftInfo.workerName}</div>` : ''}
                            </div>
                            <div class="restore-check-actions">
                                <button onclick="restoreSingleCheck(${index})" style="background-color: #10b981; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 0.25rem; cursor: pointer;">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" class="restore-checkbox" data-index="${index}" style="margin-right: 0.5rem;">
                                    –í—ã–±—Ä–∞—Ç—å
                                </label>
                            </div>
                        </div>`;
                });
                html += '</div>';
            }
            
            document.getElementById('restoreContent').innerHTML = html;
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —á–µ–∫–æ–≤ –ø–æ —Ç–∞–π–º–µ—Ä—É
        function filterDeletedChecksByTimer(timerId) {
            const allChecks = document.getElementById('allDeletedChecks');
            if (!allChecks) return;
            
            const checkItems = allChecks.querySelectorAll('.restore-check-item');
            const timerButtons = document.querySelectorAll('.shift-timer-btn');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            timerButtons.forEach(btn => {
                if (timerId === null && btn.textContent === '–í—Å–µ') {
                    btn.classList.add('active');
                } else if (btn.textContent === `–¢–∞–π–º–µ—Ä ${timerId}`) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —á–µ–∫–∏
            checkItems.forEach(item => {
                if (timerId === null || parseInt(item.dataset.timerId) === timerId) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø ---

        function restoreSingleCheck(index) {
            const deletedChecks = getDeletedChecks();
            if (index >= 0 && index < deletedChecks.length) {
                const check = deletedChecks[index];
                const t = timers.find(x => x.id === check.timerId);
                if (t) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —á–µ–∫ –≤ –∏—Å—Ç–æ—Ä–∏–∏
                    const existingIndex = t.history.findIndex(item => 
                        item.sessionId === check.sessionId
                    );
                    
                    if (existingIndex === -1) {
                        t.history.unshift({
                            html: check.item.html || check.item,
                            timestamp: check.item.timestamp || check.deletedAt || Date.now(),
                            sessionId: check.sessionId
                        });
                        saveTimerState();
                    }
                    
                    deletedChecks.splice(index, 1);
                    saveDeletedChecks(deletedChecks);
                    
                    loadDeletedChecks();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–∫–Ω–æ, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è —ç—Ç–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞
                    if (currentModalTimerId === check.timerId && currentModalType === 'history') {
                        applyFilter();
                    }
                    
                    alert("–ß–µ–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!");
                }
            }
        }

        function restoreSelectedChecks() {
            const checkboxes = document.querySelectorAll('.restore-checkbox:checked');
            const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
            
            if (indices.length === 0) {
                alert("–í—ã–±–µ—Ä–∏—Ç–µ —á–µ–∫–∏ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è");
                return;
            }
            
            if (confirm(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ${indices.length} —á–µ–∫–æ–≤?`)) {
                const deletedChecks = getDeletedChecks();
                let restoredCount = 0;
                const restoredTimers = new Set();
                
                indices.sort((a, b) => b - a).forEach(index => {
                    if (index >= 0 && index < deletedChecks.length) {
                        const check = deletedChecks[index];
                        const t = timers.find(x => x.id === check.timerId);
                        
                        if (t) {
                            const existingIndex = t.history.findIndex(item => 
                                item.sessionId === check.sessionId
                            );
                            
                            if (existingIndex === -1) {
                                t.history.unshift({
                                    html: check.item.html || check.item,
                                    timestamp: check.item.timestamp || check.deletedAt || Date.now(),
                                    sessionId: check.sessionId
                                });
                                restoredCount++;
                                restoredTimers.add(t.id);
                            }
                            deletedChecks.splice(index, 1);
                        }
                    }
                });
                
                saveTimerState();
                saveDeletedChecks(deletedChecks);
                loadDeletedChecks();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
                if (currentModalType === 'history' && restoredTimers.has(currentModalTimerId)) {
                    applyFilter();
                }
                
                alert(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ${restoredCount} —á–µ–∫–æ–≤!`);
            }
        }

        function restoreAllChecks() {
            const deletedChecks = getDeletedChecks();
            if (deletedChecks.length === 0) {
                alert("–ù–µ—Ç —á–µ–∫–æ–≤ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è");
                return;
            }
            
            if (confirm(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ ${deletedChecks.length} —á–µ–∫–æ–≤?`)) {
                let restoredCount = 0;
                const restoredTimers = new Set();
                
                deletedChecks.forEach(check => {
                    const t = timers.find(x => x.id === check.timerId);
                    if (t) {
                        const existingIndex = t.history.findIndex(item => 
                            item.sessionId === check.sessionId
                        );
                        
                        if (existingIndex === -1) {
                            t.history.unshift({
                                html: check.item.html || check.item,
                                timestamp: check.item.timestamp || check.deletedAt || Date.now(),
                                sessionId: check.sessionId
                            });
                            restoredCount++;
                            restoredTimers.add(t.id);
                        }
                    }
                });
                
                saveTimerState();
                saveDeletedChecks([]); // –û—á–∏—â–∞–µ–º –∞—Ä—Ö–∏–≤
                loadDeletedChecks();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
                if (currentModalType === 'history') {
                    // –ï—Å–ª–∏ —Å—Ä–µ–¥–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –µ—Å—Ç—å —Ç–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–µ–π—á–∞—Å –æ—Ç–∫—Ä—ã—Ç
                    let needsRefresh = false;
                    for (let timerId of restoredTimers) {
                        if (timerId === currentModalTimerId) {
                            needsRefresh = true;
                            break;
                        }
                    }
                    if (needsRefresh) {
                        applyFilter();
                    }
                }
                
                alert(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ${restoredCount} —á–µ–∫–æ–≤!`);
            }
        }


        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            container = document.getElementById('timersContainer');
            resetButton = document.getElementById('resetMotohoursBtn');
            motohoursDetails = document.getElementById('motohoursDetails');
            toggleIcon = document.getElementById('motohoursToggleIcon');
            motohoursNameDisplay = document.getElementById('motohoursNameDisplay');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Å–º–µ–Ω–∞—Ö
            loadShiftData();
            updateShiftUI();

            // Set initial visibility for Motohours Block and Summary Button
            document.getElementById('motohoursBlock').style.display = appSettings.generalControls.motohoursBlockVisible ? 'flex' : 'none';
            document.getElementById('summaryControls').style.display = appSettings.generalControls.fullSummaryVisible ? 'grid' : 'none';

            // Render group summary buttons
            renderGroupSummaryButtons();

            // Clock
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock-time').textContent = now.toLocaleTimeString('ru-RU');
                const d = now.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                document.getElementById('clock-date').textContent = d.charAt(0).toUpperCase() + d.slice(1);
            }, 1000);

            // Load Stats
            try {
                const saved = localStorage.getItem(STORAGE_KEY_STATS);
                if (saved) timerStats = JSON.parse(saved);
            } catch (e) {}

            // Generate Stats Grid (Dynamically based on Motohours IDs)
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';
            const idsToTrack = appSettings.generalControls.motohoursIds.split(',').map(Number).filter(id => !isNaN(id));

            idsToTrack.forEach(id => {
                if(timerStats[id] === undefined) timerStats[id] = 0;
                const div = document.createElement('div');
                div.className = 'stat-item';
                div.innerHTML = `<span>–¢–∞–π–º–µ—Ä ${id}</span><span id="stat-${id}" class="stat-time">00:00:00</span>`;
                statsGrid.appendChild(div);
            });

            // Create Timers from Settings (only active groups)
            const activeIds = appSettings.activeTimers.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x));
            activeIds.forEach(i => createTimer(i));

            // Restore State
            try {
                const savedStateStr = localStorage.getItem(TIMER_STATE_STORAGE_KEY);
                const now = Date.now();
                if (savedStateStr) {
                    JSON.parse(savedStateStr).forEach(savedT => {
                        const t = timers.find(x => x.id === savedT.id);
                        const motoIds = appSettings.generalControls.motohoursIds.split(',').map(Number).filter(id => !isNaN(id));

                        if (t) {
                             // 1. Update t.baseConfig —Å CURRENT settings (–¥–ª—è –±—É–¥—É—â–∏—Ö —Å–±—Ä–æ—Å–æ–≤/–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π)
                            const group = getGroupForId(t.id);
                            const newBaseMinutes = group.defaultMinutes;
                            const newBaseMs = newBaseMinutes * 60 * 1000;
                            
                            t.baseConfig.MS = newBaseMs;
                            t.baseConfig.MINUTES = newBaseMinutes;
                            t.baseConfig.WARN_YELLOW = group.warnYellow || 5;
                            t.baseConfig.WARN_RED = group.warnRed || 2;

                            // 2. Restore essential state
                            t.elapsedTime = savedT.elapsedTime || 0;
                            t.isRunning = savedT.isRunning || false;
                            t.lastStartTime = savedT.lastStartTime || null;
                            t.alarmsTriggered = savedT.alarmsTriggered || t.alarmsTriggered;
                            t.isStatusOpen = savedT.isStatusOpen || false;
                            t.history = savedT.history || [];
                            
                            t.session.startTime = savedT.session?.startTime || null;
                            t.session.initialLimit = savedT.session?.initialLimit || 0;
                            t.session.totalExtensions = savedT.session?.totalExtensions || 0;
                            t.session.pauseStart = savedT.session?.pauseStart || null;
                            t.session.pauseStartTime = savedT.session?.pauseStartTime || null;
                            t.session.pauseHistory = savedT.session?.pauseHistory || [];
                            t.session.totalPauseDurationMs = savedT.session?.totalPauseDurationMs || 0;
                            t.session.accFixedAmount = savedT.session?.accFixedAmount || 0; // Restore accumulated cost
                            t.session.additionalServices = savedT.session?.additionalServices || []; // Restore services
                            t.session.sessionId = savedT.session?.sessionId || null; // Restore session ID

                            t.isFixedPayment = savedT.isFixedPayment || false;
                            t.isInfinity = savedT.isInfinity || false; // NEW: Restore Infinity State
                            t.overtimeEnabled = (savedT.overtimeEnabled !== undefined) ? savedT.overtimeEnabled : true; // Restore Overtime Flag

                            t.fixedPaymentDetails = savedT.fixedPaymentDetails || { label: null, amount: 0 };
                            // NEW: Restore Fixed Extension Details
                            t.fixedExtensionDetails = savedT.fixedExtensionDetails || { label: null, amount: 0, durationValue: 0, durationUnit: 'minute' };


                            // 3. Restore current duration (config.MS)
                            t.config = savedT.config || t.config;
                            
                            // 4. CRITICAL FIX: If the timer is reset, its duration MUST be the new default time.
                            //    –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–∞–π–º–µ—Ä –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–±—Ä–æ—Å–∞ (–Ω–µ—Ç –ø—Ä–æ—à–µ–¥—à–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω).
                            if (t.elapsedTime === 0 && !t.isRunning && !t.session.startTime) {
                                t.config.MS = newBaseMs;
                            }


                            if (t.isFixedPayment) {
                                t.isRunning = false; // Fixed payment timers are never running (no timer counting)
                            } else {
                                // Compensation only for non-fixed running timers
                                if (t.isRunning && t.lastStartTime) {
                                    // *** –ö–û–ú–ü–ï–ù–°–ê–¶–ò–Ø –í–†–ï–ú–ï–ù–ò –ü–†–û–°–¢–û–Ø (–ü–†–ò –ó–ê–ö–†–´–¢–û–ô –°–¢–†–ê–ù–ò–¶–ï) ***
                                    const timeClosed = now - t.lastStartTime;
                                    t.elapsedTime += timeClosed; // –ö–û–ú–ü–ï–ù–°–ò–†–£–ï–ú –û–°–ù–û–í–ù–û–ï –í–†–ï–ú–Ø
                                    t.lastStartTime = now;
                                    
                                    // Compensation for Motohours stats (NEW)
                                    if (motoIds.includes(t.id)) {
                                         timerStats[t.id] = (timerStats[t.id] || 0) + timeClosed; // –ö–û–ú–ü–ï–ù–°–ò–†–£–ï–ú –ú–û–¢–û–ß–ê–°–´
                                    }
                                }
                                if (!t.isRunning && t.session.pauseStart) {
                                    t.session.pauseStart = now;
                                }
                            }

                            updateTimerUI(t); 
                        }
                    });
                }
            } catch (e) { console.error('State load error:', e); }

            window.addEventListener('beforeunload', () => saveTimerState(true));
            loop();
        });
    </script>
</body>
